<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MINERA SAC - Sistema de Gestión</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html {
            scroll-behavior: smooth;
        }
        
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: #F5F7FA; 
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        :root {
            --primary-color: #0D47A1;
            --primary-dark: #01579B;
            --primary-light: #1565C0;
        }
        
        /* Optimización táctil */
        button, a, .menu-item {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        /* Scroll suave en tablas */
        .table-responsive {
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: #CBD5E1 #F1F5F9;
        }
        
        .table-responsive::-webkit-scrollbar {
            height: 8px;
        }
        
        .table-responsive::-webkit-scrollbar-track {
            background: #F1F5F9;
            border-radius: 10px;
        }
        
        .table-responsive::-webkit-scrollbar-thumb {
            background: #CBD5E1;
            border-radius: 10px;
        }
        
        .table-responsive::-webkit-scrollbar-thumb:hover {
            background: #94A3B8;
        }
        
        /* Login */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #0D47A1;
            position: relative;
            overflow: hidden;
        }
        
        .login-container::before {
            content: '';
            position: absolute;
            width: 500px;
            height: 500px;
            background: #01579B;
            border-radius: 50%;
            top: -250px;
            right: -250px;
            opacity: 0.15;
        }
        
        .login-container::after {
            content: '';
            position: absolute;
            width: 400px;
            height: 400px;
            background: #01579B;
            border-radius: 50%;
            bottom: -200px;
            left: -200px;
            opacity: 0.15;
        }
        
        .login-box {
            background: white;
            padding: 50px 40px;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(13, 71, 161, 0.3);
            width: 100%;
            max-width: 420px;
            position: relative;
            z-index: 1;
            animation: slideUp 0.6s ease;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .login-logo {
            width: 90px;
            height: 90px;
            background: #0D47A1;
            border-radius: 20px;
            margin: 0 auto 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 42px;
            font-weight: 700;
            color: white;
            box-shadow: 0 10px 30px rgba(13, 71, 161, 0.6);
            position: relative;
        }
        
        .login-logo::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: #1565C0;
            border-radius: 20px;
            z-index: -1;
            animation: pulse 2s ease infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.3;
            }
            50% {
                transform: scale(1.1);
                opacity: 0;
            }
        }
        
        .login-title {
            text-align: center;
            font-size: 28px;
            font-weight: 700;
            color: #0A1828;
            margin-bottom: 8px;
        }
        
        .login-subtitle {
            text-align: center;
            color: #64748B;
            margin-bottom: 35px;
            font-size: 15px;
        }
        
        .login-box .form-label {
            font-weight: 700;
            color: #000000;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .login-box .form-control {
            padding: 14px 18px;
            border: 2px solid #E2E8F0;
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s;
        }
        
        .login-box .form-control:focus {
            outline: none;
            border-color: #0D47A1;
            box-shadow: 0 0 0 4px rgba(13, 71, 161, 0.15);
        }
        
        .login-box .btn-primary {
            width: 100%;
            padding: 14px;
            background: #0D47A1;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 14px rgba(13, 71, 161, 0.4);
        }
        
        .login-box .btn-primary:hover {
            background: #01579B;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(13, 71, 161, 0.6);
        }
        
        .login-box .btn-primary:active {
            transform: translateY(0);
        }
        
        /* Contenedor de contraseña con botón */
        .password-container {
            position: relative;
        }
        
        .password-toggle {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #64748B;
            cursor: pointer;
            padding: 5px;
            font-size: 16px;
            transition: color 0.3s;
            z-index: 10;
        }
        
        .password-toggle:hover {
            color: #0D47A1;
        }
        
        .password-toggle:focus {
            outline: none;
        }
        
        .login-box .password-container .form-control {
            padding-right: 45px;
        }
        
        /* Modal Detalles Bootstrap */
        #modalDetalles .modal-dialog {
            display: flex;
            align-items: center;
            min-height: calc(100% - 1rem);
        }
        
        #modalDetalles .modal-header.bg-info {
            background-color: #0D47A1 !important;
        }
        
        #modalDetalles .modal-content {
            border: none;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        #modalDetalles .card {
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid #E5E7EB;
        }
        
        #modalDetalles .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        }
        
        #modalDetalles .modal-body {
            padding: 25px;
            background: #F9FAFB;
        }
        
        #modalDetalles .modal-footer {
            border-top: 2px solid #E5E7EB;
            padding: 15px 25px;
        }
        
        /* Estilos para Configuraciones */
        .card-header {
            font-weight: 700;
            border: none;
            padding: 15px 20px;
        }
        
        .card-header h5 {
            font-size: 16px;
            font-weight: 700;
        }
        
        .form-check-input:checked {
            background-color: #0D47A1;
            border-color: #0D47A1;
        }
        
        .bg-primary {
            background-color: #0D47A1 !important;
        }
        
        .login-info {
            margin-top: 25px;
            padding: 20px;
            background: #F8FAFC;
            border-radius: 12px;
            border-left: 4px solid #0D47A1;
        }
        
        .login-info p {
            margin: 0;
            font-size: 13px;
            color: #64748B;
            line-height: 1.6;
        }
        
        .login-info strong {
            color: #0A1828;
            display: block;
            margin-bottom: 8px;
        }
        
        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh;
            background: #0D47A1;
            z-index: 1001;
            overflow-y: auto;
            transition: transform 0.3s ease;
            box-shadow: 4px 0 20px rgba(13, 71, 161, 0.4);
        }
        
        .sidebar-header {
            padding: 25px 20px;
            text-align: center;
            background: rgba(0, 0, 0, 0.08);
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        .logo {
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 12px;
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 700;
            color: #0D47A1;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .sidebar-title { 
            color: white; 
            font-size: 20px; 
            font-weight: 700; 
            margin-bottom: 4px; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        
        .sidebar-subtitle { 
            color: rgba(255,255,255,0.9); 
            font-size: 11px; 
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            color: rgba(255,255,255,0.95);
            text-decoration: none;
            cursor: pointer;
            border-left: 3px solid transparent;
            text-transform: uppercase;
            font-weight: 700;
            font-size: 13px;
            letter-spacing: 0.5px;
            transition: all 0.3s;
        }
        
        .menu-item:hover { 
            background: rgba(0,0,0,0.15); 
            color: white;
            border-left-color: rgba(255,255,255,0.5);
        }
        
        .menu-item.active { 
            background: rgba(0,0,0,0.25); 
            border-left-color: white; 
            color: white;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
        }
        .menu-item i { width: 20px; text-align: center; }
        
        /* Main Container */
        .main-container {
            margin-left: 260px;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }
        
        /* Top Header */
        .top-header {
            position: sticky;
            top: 0;
            z-index: 999;
            background: #0D47A1;
            padding: 18px 30px;
            box-shadow: 0 4px 12px rgba(13, 71, 161, 0.4);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .menu-toggle {
            display: none;
            width: 40px;
            height: 40px;
            background: white;
            border: none;
            border-radius: 8px;
            color: #0D47A1;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.10);
            transition: all 0.3s;
        }
        
        .menu-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(13, 71, 161, 0.4);
            background: #E3F2FD;
        }
        
        .header-title {
            color: white;
            font-size: 24px;
            font-weight: 600;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
            font-weight: 500;
        }
        
        #btnVolverCampañaActual {
            background: #ffc107;
            border: 2px solid #ff9800;
            color: #000;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        #btnVolverCampañaActual:hover {
            background: #ff9800;
            border-color: #f57c00;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .logout-btn:hover { 
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }
        
        /* Content */
        .content-area { padding: 30px; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 16px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            flex-shrink: 0;
        }
        
        .stat-info {
            flex: 1;
        }
        
        .stat-label {
            font-size: 12px;
            color: #64748B;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 4px;
            letter-spacing: 0.5px;
        }
        
        .stat-value { 
            font-size: 28px; 
            font-weight: 700;
            color: #1E293B;
            line-height: 1.2;
        }
        
        .stat-detail {
            font-size: 13px;
            color: #64748B;
            margin-top: 4px;
        }
        
        .stat-detail span {
            font-weight: 600;
            color: #475569;
        }
        
        .bg-primary { background: #0D47A1; }
        .bg-success { background: #2E7D32; }
        .bg-warning { background: #F57C00; }
        .bg-info { background: #0288D1; }
        .bg-danger { background: #C62828; }
        .bg-secondary { background: #455A64; }
        
        /* Panel */
        .content-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .panel-header {
            padding: 20px 25px;
            border-bottom: 1px solid #E2E8F0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .filter-section {
            background: #F8FAFC;
            padding: 20px;
            border-bottom: 1px solid #E2E8F0;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: end;
        }
        
        table { width: 100%; border-collapse: collapse; }
        
        thead th {
            background: #F8FAFC;
            padding: 14px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            color: #475569;
            text-transform: uppercase;
            border-bottom: 2px solid #E2E8F0;
        }
        
        tbody td {
            padding: 16px;
            border-bottom: 1px solid #F1F5F9;
            color: #1E293B;
            font-size: 14px;
            font-weight: 500;
        }
        
        tbody tr:hover { background: #F8FAFC; }
        
        .summary-card {
            background: #EFF6FF;
            border: 2px solid #3B82F6;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .summary-title {
            font-size: 18px;
            font-weight: 700;
            color: #1E40AF;
            margin-bottom: 15px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #BFDBFE;
        }
        
        .summary-row:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 16px;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            background: #0D47A1;
            color: white;
            padding: 20px 25px;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(13, 71, 161, 0.3);
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 20px;
            text-transform: uppercase;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .modal-close {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
        }
        
        .modal-close:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #E2E8F0;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1E293B;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #E2E8F0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #0D47A1;
            box-shadow: 0 0 0 3px rgba(13, 71, 161, 0.2);
        }
        
        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
        }
        
        .overlay.active { display: block; }
        
        /* Responsive */
        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-container {
                margin-left: 0;
            }
            
            .menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .user-info span {
                display: none;
            }
            
            .header-title {
                font-size: 18px;
            }
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .content-area {
                padding: 20px 15px;
            }
            
            .panel-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .panel-header > * {
                width: 100%;
            }
            
            .filter-section {
                flex-direction: column;
            }
            
            .filter-section > div {
                width: 100%;
            }
            
            .header-title {
                font-size: 16px;
            }
            
            .top-header {
                padding: 12px 15px;
            }
            
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 600px;
            }
            
            .summary-card {
                padding: 15px;
                margin: 15px 0;
            }
            
            .summary-title {
                font-size: 16px;
            }
        }
        
        @media (max-width: 576px) {
            .content-area {
                padding: 15px 10px;
            }
            
            .stat-card {
                padding: 20px;
            }
            
            .stat-value {
                font-size: 28px;
            }
            
            .stat-label {
                font-size: 11px;
            }
            
            .panel-header {
                padding: 15px;
            }
            
            .filter-section {
                padding: 15px;
            }
            
            thead th {
                padding: 10px 8px;
                font-size: 11px;
            }
            
            tbody td {
                padding: 12px 8px;
                font-size: 13px;
            }
            
            .btn-sm {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .header-title {
                font-size: 15px;
            }
            
            .logout-btn {
                padding: 6px 12px;
                font-size: 13px;
            }
            
            .summary-row {
                font-size: 13px;
                padding: 6px 0;
            }
            
            .summary-row:last-child {
                font-size: 14px;
            }
        }
        
        @media (max-width: 400px) {
            .stat-card {
                padding: 16px;
            }
            
            .stat-value {
                font-size: 24px;
            }
            
            .header-title {
                font-size: 14px;
            }
            
            .menu-toggle {
                width: 36px;
                height: 36px;
                font-size: 18px;
            }
            
            .content-area {
                padding: 10px;
            }
        }
        
        /* Landscape móvil */
        @media (max-height: 500px) and (orientation: landscape) {
            .login-container {
                padding: 20px 0;
            }
            
            .login-box {
                padding: 20px;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .login-logo {
                width: 60px;
                height: 60px;
                font-size: 28px;
            }
        }
        
        /* Tablets en landscape */
        @media (min-width: 768px) and (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Pantallas grandes */
        @media (min-width: 1400px) {
            .main-container {
                max-width: 1600px;
                margin-left: calc(260px + ((100vw - 1600px) / 2));
            }
            
            .content-area {
                padding: 40px;
            }
        }
    </style>
</head>
<body>
    <!-- Overlay -->
    <div class="overlay" id="overlay"></div>

    <!-- Login -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="login-logo">M</div>
            <h1 class="login-title">MINERA SAC</h1>
            <p class="login-subtitle">Sistema de Gestión</p>
            
            <div class="mb-3">
                <label class="form-label">Código de Usuario</label>
                <input type="text" class="form-control" id="username" placeholder="Ej: USR001" style="text-transform: uppercase;">
            </div>
            
            <div class="mb-3">
                <label class="form-label">Contraseña</label>
                <div class="password-container">
                    <input type="password" class="form-control" id="password" placeholder="Ingrese su contraseña">
                    <button type="button" class="password-toggle" onclick="togglePassword()">
                        <i class="fas fa-eye" id="toggleIcon"></i>
                    </button>
                </div>
            </div>
            
            <button class="btn btn-primary w-100 mb-3" onclick="login()">
                Iniciar Sesión
            </button>
        </div>
    </div>

    <!-- Sistema Principal -->
    <div id="mainSystem" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">M</div>
                <div class="sidebar-title">MINERA SAC</div>
                <div class="sidebar-subtitle">SISTEMA DE GESTIÓN</div>
            </div>
            <div>
                <a class="menu-item active" data-view="dashboard">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a class="menu-item" data-view="usuarios">
                    <i class="fas fa-user-tie"></i> Usuarios
                </a>
                <a class="menu-item" data-view="insumos">
                    <i class="fas fa-box-open"></i> Insumos
                </a>
                <a class="menu-item" data-view="movimiento">
                    <i class="fas fa-dolly"></i> Movimientos
                </a>
                <a class="menu-item" data-view="registro_trabajo">
                    <i class="fas fa-tasks"></i> Registro Trabajo
                </a>
                <a class="menu-item" data-view="avance">
                    <i class="fas fa-chart-area"></i> Avance
                </a>
                <a class="menu-item" data-view="produccion">
                    <i class="fas fa-cogs"></i> Producción
                </a>
                <a class="menu-item" data-view="voladura">
                    <i class="fas fa-fire"></i> Voladura
                </a>
                <a class="menu-item" data-view="configuraciones">
                    <i class="fas fa-cog"></i> Configuraciones
                </a>
            </div>
        </div>

        <!-- Main -->
        <div class="main-container">
            <!-- Header -->
            <div class="top-header">
                <div class="header-left">
                    <button class="menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="header-title" id="pageTitle">Dashboard General</h1>
                </div>
                <div class="user-info">
                    <span id="userDisplay"></span>
                    <!-- Botón para volver a campaña actual (solo visible en modo visualización) -->
                    <button id="btnVolverCampañaActual" class="btn btn-warning btn-sm me-2" onclick="volverACampañaActual()" style="display:none;">
                        <i class="fas fa-arrow-left"></i> Volver a Campaña Actual
                    </button>
                    <button class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Salir
                    </button>
                </div>
            </div>

            <!-- Content -->
            <div class="content-area">
                <!-- Dashboard Stats -->
                <div id="dashboardStats" class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon bg-primary"><i class="fas fa-users"></i></div>
                        <div class="stat-info">
                            <div class="stat-label">Total Usuarios</div>
                            <div class="stat-value" id="totalUsuarios">0</div>
                            <div class="stat-detail"><span id="usuariosActivos">0</span> activos</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon bg-success"><i class="fas fa-boxes"></i></div>
                        <div class="stat-info">
                            <div class="stat-label">Total Insumos</div>
                            <div class="stat-value" id="totalInsumos">0</div>
                            <div class="stat-detail"><span id="insumosStockBajo">0</span> en stock bajo</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon bg-warning"><i class="fas fa-exchange-alt"></i></div>
                        <div class="stat-info">
                            <div class="stat-label">Movimientos (Hoy)</div>
                            <div class="stat-value" id="totalMovimientos">0</div>
                            <div class="stat-detail"><span id="movEntradas">0</span> entradas / <span id="movSalidas">0</span> salidas</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon bg-info"><i class="fas fa-hard-hat"></i></div>
                        <div class="stat-info">
                            <div class="stat-label">Trabajadores Hoy</div>
                            <div class="stat-value" id="trabajadoresHoy">0</div>
                            <div class="stat-detail"><span id="horasTrabajadas">0</span> horas totales</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon bg-danger"><i class="fas fa-gem"></i></div>
                        <div class="stat-info">
                            <div class="stat-label">Producción (Mes)</div>
                            <div class="stat-value" id="produccionMes">0 Kg</div>
                            <div class="stat-detail">Mineral extraído</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon bg-secondary"><i class="fas fa-ruler"></i></div>
                        <div class="stat-info">
                            <div class="stat-label">Avance (Mes)</div>
                            <div class="stat-value" id="avanceMes">0 m</div>
                            <div class="stat-detail">Metros de perforación</div>
                        </div>
                    </div>
                </div>

                <!-- Content Panel -->
                <div class="content-panel" id="contentPanel" style="display: none;">
                    <!-- Filtros Reportes -->
                    <div id="filterSection" class="filter-section" style="display: none;">
                        <div>
                            <label class="form-label mb-1">Tipo de Reporte</label>
                            <select class="form-select" id="reportType">
                                <option value="">Seleccione...</option>
                                <option value="insumos">Reporte de Insumos</option>
                                <option value="movimiento">Reporte de Movimientos</option>
                                <option value="produccion">Reporte de Producción</option>
                                <option value="trabajo">Reporte de Trabajo (Días)</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label mb-1">Fecha Inicio</label>
                            <input type="date" class="form-control" id="fechaInicio">
                        </div>
                        <div>
                            <label class="form-label mb-1">Fecha Fin</label>
                            <input type="date" class="form-control" id="fechaFin">
                        </div>
                        <div>
                            <button class="btn btn-primary" onclick="generateReport()">
                                <i class="fas fa-search"></i> Generar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Header Panel -->
                    <div class="panel-header" id="panelHeader">
                        <input type="text" class="form-control" id="searchInput" style="max-width:300px" placeholder="Buscar..." onkeyup="buscarEnTabla()">
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-success btn-sm" onclick="exportExcel()">
                                <i class="fas fa-file-excel"></i> Excel
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="exportPDF()">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                            <button class="btn btn-primary btn-sm" id="btnAgregar" onclick="openModal()">
                                <i class="fas fa-plus"></i> Agregar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Table Content -->
                    <div class="p-3" id="tableContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Formulario -->
    <div class="modal-overlay" id="modalForm">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">AGREGAR REGISTRO</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="dataForm">
                    <div id="formFields"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="saveData()">
                    <i class="fas fa-save"></i> Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Ver Detalles -->
    <div class="modal fade" id="modalDetalles" tabindex="-1" aria-labelledby="modalDetallesLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="modalDetallesLabel">
                        <i class="fas fa-info-circle"></i> Detalles del Registro
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modalDetallesBody">
                    <!-- Contenido dinámico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        /*
        CÓDIGO DE COLORES PROFESIONAL - GESTIÓN MINERA
        ================================================
        
        EXPLOSIVOS Y VOLADURA (Rojos/Naranjas - Alta Peligrosidad):
        #E53935 - Rojo Oscuro: Dinamita
        #D32F2F - Rojo Intenso: ANFO  
        #FF6B00 - Naranja Intenso: Fulminante
        #F57C00 - Naranja: Mecha de seguridad
        
        EPP (Verdes/Amarillos - Seguridad):
        #FDD835 - Amarillo: Casco con lámpara (alta visibilidad)
        #7CB342 - Verde Claro: Respirador
        #66BB6A - Verde Medio: Guantes
        #43A047 - Verde Oscuro: Botas
        
        HERRAMIENTAS (Grises/Azules - Durabilidad):
        #546E7A - Gris Azulado: Brocas
        #607D8B - Gris Acero: Barretillas
        
        SOSTENIMIENTO (Morados - Estructura):
        #5E35B1 - Morado Oscuro: Pernos
        #673AB7 - Morado: Malla
        #7E57C2 - Morado Claro: Shotcrete
        
        LUBRICANTES (Azules - Fluidos):
        #039BE5 - Azul Cielo: Aceite hidráulico
        #0288D1 - Azul Medio: Grasa
        
        REPUESTOS (Cyan/Verde Azulado - Mantenimiento):
        #00ACC1 - Cyan: Filtros
        #00838F - Verde Azulado Oscuro: Llantas
        #00897B - Verde Azulado: Baterías
        */
        
        let currentUser = null;
        let currentView = 'dashboard';
        let currentData = [];
        let editingId = null;
        let avatarImageData = null; // Variable global para guardar la imagen del avatar
        let imagenProductoData = null; // Variable global para guardar la imagen del producto

        const DATA = {
        // ============================================================
        // CONFIGURACIÓN GOOGLE SHEETS - CAMBIA SOLO ESTA URL
        // ============================================================
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzWGn4NleNmX0yokyDpojOdpOfZxxKH7Xu5I3HzNDS9OurkEoafj4PprSXODDx6Lk08/exec';
        // ============================================================

        // ============================================================
        // CAPA DE BASE DE DATOS - reemplaza localStorage
        // ============================================================
        const DB = {
            async leerTodo() {
                try {
                    const res = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ accion: 'leerTodo' })
                    });
                    const json = await res.json();
                    return json.ok ? json.datos : null;
                } catch(e) { console.error('DB.leerTodo:', e); return null; }
            },
            async leerConfig() {
                try {
                    const res = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ accion: 'leerConfig' })
                    });
                    const json = await res.json();
                    return json.ok ? json.datos : {};
                } catch(e) { return {}; }
            },
            async leerZonas() {
                try {
                    const res = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ accion: 'leerZonas' })
                    });
                    const json = await res.json();
                    return json.ok ? json.datos : [];
                } catch(e) { return []; }
            },
            async agregar(hoja, datos) {
                try {
                    const res = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ accion: 'agregar', hoja, datos })
                    });
                    return await res.json();
                } catch(e) { return { ok: false, error: e.toString() }; }
            },
            async actualizar(hoja, datos) {
                try {
                    const res = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ accion: 'actualizar', hoja, datos })
                    });
                    return await res.json();
                } catch(e) { return { ok: false, error: e.toString() }; }
            },
            async eliminar(hoja, id) {
                try {
                    const res = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ accion: 'eliminar', hoja, id })
                    });
                    return await res.json();
                } catch(e) { return { ok: false, error: e.toString() }; }
            },
            async guardarConfig(datos) {
                try {
                    const res = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ accion: 'guardarConfig', datos })
                    });
                    return await res.json();
                } catch(e) { return { ok: false }; }
            },
            async guardarZonas(zonas) {
                try {
                    const res = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ accion: 'guardarZonas', zonas })
                    });
                    return await res.json();
                } catch(e) { return { ok: false }; }
            },
            async guardarCampania(datos) {
                try {
                    const res = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ accion: 'guardarCampania', datos })
                    });
                    return await res.json();
                } catch(e) { return { ok: false }; }
            },
            async leerCampanias() {
                try {
                    const res = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ accion: 'leerCampanias' })
                    });
                    const json = await res.json();
                    return json.ok ? json.datos : null;
                } catch(e) { return null; }
            }
        };

        // Cache local para no hacer peticiones repetidas en la misma sesión
        let _configCache = null;
        let _zonasCache = null;

        async function getConfig(clave, defecto = '') {
            if (!_configCache) _configCache = await DB.leerConfig();
            return _configCache[clave] !== undefined ? _configCache[clave] : defecto;
        }

        async function setConfig(clave, valor) {
            if (!_configCache) _configCache = {};
            _configCache[clave] = valor;
            await DB.guardarConfig(_configCache);
        }

        async function getZonas() {
            if (!_zonasCache) _zonasCache = await DB.leerZonas();
            return _zonasCache || [];
        }

        async function setZonas(zonas) {
            _zonasCache = zonas;
            await DB.guardarZonas(zonas);
        }

        const DATA = {
            usuarios: [
                {id: 1, id_usuario: 'USR001', nombre: 'Carlos Mendoza', email: 'carlos@minera.com', password: 'admin123', rol: 'admin', fecha_registro: '2024-01-15', estado: 'Activo', avatar: ''},
                {id: 2, id_usuario: 'USR002', nombre: 'María López', email: 'maria@minera.com', password: 'sup123', rol: 'supervisor', fecha_registro: '2024-02-01', estado: 'Activo', avatar: ''},
                {id: 3, id_usuario: 'USR003', nombre: 'Juan Pérez', email: 'juan@minera.com', password: 'geo123', rol: 'geologo', fecha_registro: '2024-02-10', estado: 'Activo', avatar: ''},
                {id: 4, id_usuario: 'USR004', nombre: 'Ana Torres', email: 'ana@minera.com', password: 'ing123', rol: 'ingeniero_minas', fecha_registro: '2024-02-05', estado: 'Activo', avatar: ''},
                {id: 5, id_usuario: 'USR005', nombre: 'Luis García', email: 'luis@minera.com', password: 'perf123', rol: 'perforista', fecha_registro: '2024-02-12', estado: 'Activo', avatar: ''},
                {id: 6, id_usuario: 'USR006', nombre: 'Pedro Ramírez', email: 'pedro@minera.com', password: 'tec123', rol: 'tecnico', fecha_registro: '2024-02-08', estado: 'Activo', avatar: ''},
                {id: 7, id_usuario: 'USR007', nombre: 'Rosa Flores', email: 'rosa@minera.com', password: 'coc123', rol: 'cocinero', fecha_registro: '2024-01-20', estado: 'Activo', avatar: ''},
                {id: 8, id_usuario: 'USR008', nombre: 'Miguel Vargas', email: 'miguel@minera.com', password: 'mec123', rol: 'mecanico', fecha_registro: '2024-02-03', estado: 'Activo', avatar: ''},
                {id: 9, id_usuario: 'USR009', nombre: 'Carmen Silva', email: 'carmen@minera.com', password: 'enf123', rol: 'enfermero', fecha_registro: '2024-01-25', estado: 'Activo', avatar: ''},
                {id: 10, id_usuario: 'USR010', nombre: 'Roberto Díaz', email: 'roberto@minera.com', password: 'alm123', rol: 'almacenero', fecha_registro: '2024-02-15', estado: 'Activo', avatar: ''},
                {id: 11, id_usuario: 'USR011', nombre: 'Patricia Ramos', email: 'patricia@minera.com', password: 'ger123', rol: 'gerente', fecha_registro: '2024-01-10', estado: 'Activo', avatar: ''},
                {id: 12, id_usuario: 'USR012', nombre: 'Jorge Castro', email: 'jorge@minera.com', password: 'vol123', rol: 'volador', fecha_registro: '2024-02-14', estado: 'Activo', avatar: ''},
                {id: 13, id_usuario: 'USR013', nombre: 'Elena Morales', email: 'elena@minera.com', password: 'top123', rol: 'topografo', fecha_registro: '2024-02-11', estado: 'Activo', avatar: ''},
                {id: 14, id_usuario: 'USR014', nombre: 'Francisco Ruiz', email: 'francisco@minera.com', password: 'cho123', rol: 'chofer', fecha_registro: '2024-02-07', estado: 'Activo', avatar: ''},
                {id: 15, id_usuario: 'USR015', nombre: 'Sofía Mendez', email: 'sofia@minera.com', password: 'rrhh123', rol: 'recursos_humanos', fecha_registro: '2024-01-18', estado: 'Activo', avatar: ''}
            ],
            insumos: [
                {id: 1, id_producto: 'PROD001', producto: 'Fulminante', imagen: '', categoria: 'Voladura', unidad: 'Caja', tipo_control: 'Contable', unidades_por_caja: 100, presentacion: 'Caja x 100 unidades', stock_minimo: 10, stock_actual: 5, stock_cajas: 5, stock_unidades: 50, color: '#FF6B00', fecha_creacion: '2024-02-10'},
                {id: 2, id_producto: 'PROD002', producto: 'Dinamita', imagen: '', categoria: 'Explosivos', unidad: 'Kg', tipo_control: 'Medible', unidades_por_caja: 0, presentacion: 'Kilogramo', stock_minimo: 50, stock_actual: 60, stock_cajas: 0, stock_unidades: 0, color: '#E53935', fecha_creacion: '2024-02-12'},
                {id: 3, id_producto: 'PROD003', producto: 'ANFO', imagen: '', categoria: 'Explosivos', unidad: 'Kg', tipo_control: 'Medible', unidades_por_caja: 0, presentacion: 'Kilogramo', stock_minimo: 100, stock_actual: 250, stock_cajas: 0, stock_unidades: 0, color: '#D32F2F', fecha_creacion: '2024-02-08'},
                {id: 4, id_producto: 'PROD004', producto: 'Mecha de Seguridad', imagen: '', categoria: 'Voladura', unidad: 'Metro', tipo_control: 'Medible', unidades_por_caja: 0, presentacion: 'Metro lineal', stock_minimo: 500, stock_actual: 550, stock_cajas: 0, stock_unidades: 0, color: '#F57C00', fecha_creacion: '2024-02-08'},
                {id: 5, id_producto: 'PROD005', producto: 'Casco con Lámpara', imagen: '', categoria: 'EPP', unidad: 'Unidades', tipo_control: 'Contable', unidades_por_caja: 1, presentacion: 'Unidad', stock_minimo: 20, stock_actual: 25, stock_cajas: 0, stock_unidades: 25, color: '#FDD835', fecha_creacion: '2024-02-05'},
                {id: 6, id_producto: 'PROD006', producto: 'Respirador 3M', imagen: '', categoria: 'EPP', unidad: 'Unidades', tipo_control: 'Contable', unidades_por_caja: 1, presentacion: 'Unidad', stock_minimo: 30, stock_actual: 10, stock_cajas: 0, stock_unidades: 10, color: '#7CB342', fecha_creacion: '2024-02-05'},
                {id: 7, id_producto: 'PROD007', producto: 'Guantes de Cuero', imagen: '', categoria: 'EPP', unidad: 'Pares', tipo_control: 'Contable', unidades_por_caja: 12, presentacion: 'Caja x 12 pares', stock_minimo: 50, stock_actual: 45, stock_cajas: 3, stock_unidades: 9, color: '#66BB6A', fecha_creacion: '2024-02-06'},
                {id: 8, id_producto: 'PROD008', producto: 'Botas Punta Acero', imagen: '', categoria: 'EPP', unidad: 'Pares', tipo_control: 'Contable', unidades_por_caja: 1, presentacion: 'Par', stock_minimo: 25, stock_actual: 18, stock_cajas: 0, stock_unidades: 18, color: '#43A047', fecha_creacion: '2024-02-06'},
                {id: 9, id_producto: 'PROD009', producto: 'Broca Integral 38mm', imagen: '', categoria: 'Herramientas', unidad: 'Unidades', tipo_control: 'Contable', unidades_por_caja: 1, presentacion: 'Unidad', stock_minimo: 15, stock_actual: 12, stock_cajas: 0, stock_unidades: 12, color: '#546E7A', fecha_creacion: '2024-02-07'},
                {id: 10, id_producto: 'PROD010', producto: 'Barretilla 6 pies', imagen: '', categoria: 'Herramientas', unidad: 'Unidades', tipo_control: 'Contable', unidades_por_caja: 1, presentacion: 'Unidad', stock_minimo: 30, stock_actual: 35, stock_cajas: 0, stock_unidades: 35, color: '#607D8B', fecha_creacion: '2024-02-07'},
                {id: 11, id_producto: 'PROD011', producto: 'Perno Split Set', imagen: '', categoria: 'Sostenimiento', unidad: 'Unidades', tipo_control: 'Contable', unidades_por_caja: 50, presentacion: 'Caja x 50 unidades', stock_minimo: 200, stock_actual: 175, stock_cajas: 3, stock_unidades: 25, color: '#5E35B1', fecha_creacion: '2024-02-08'},
                {id: 12, id_producto: 'PROD012', producto: 'Malla Electrosoldada', imagen: '', categoria: 'Sostenimiento', unidad: 'Rollo', tipo_control: 'Contable', unidades_por_caja: 1, presentacion: 'Rollo', stock_minimo: 10, stock_actual: 8, stock_cajas: 0, stock_unidades: 8, color: '#673AB7', fecha_creacion: '2024-02-08'},
                {id: 13, id_producto: 'PROD013', producto: 'Shotcrete', imagen: '', categoria: 'Sostenimiento', unidad: 'Bolsa', tipo_control: 'Contable', unidades_por_caja: 40, presentacion: 'Pallet x 40 bolsas', stock_minimo: 100, stock_actual: 120, stock_cajas: 3, stock_unidades: 0, color: '#7E57C2', fecha_creacion: '2024-02-09'},
                {id: 14, id_producto: 'PROD014', producto: 'Aceite Hidráulico', imagen: '', categoria: 'Lubricantes', unidad: 'Litros', tipo_control: 'Medible', unidades_por_caja: 0, presentacion: 'Litro', stock_minimo: 200, stock_actual: 180, stock_cajas: 0, stock_unidades: 0, color: '#039BE5', fecha_creacion: '2024-02-09'},
                {id: 15, id_producto: 'PROD015', producto: 'Grasa EP-2', imagen: '', categoria: 'Lubricantes', unidad: 'Kg', tipo_control: 'Medible', unidades_por_caja: 0, presentacion: 'Kilogramo', stock_minimo: 150, color: '#0288D1', fecha_creacion: '2024-02-10'},
                {id: 16, id_producto: 'PROD016', producto: 'Filtro de Aire', imagen: '', categoria: 'Repuestos', unidad: 'Unidades', tipo_control: 'Contable', unidades_por_caja: 1, presentacion: 'Unidad', stock_minimo: 20, color: '#00ACC1', fecha_creacion: '2024-02-10'},
                {id: 17, id_producto: 'PROD017', producto: 'Llanta 29.5 R29', imagen: '', categoria: 'Repuestos', unidad: 'Unidades', tipo_control: 'Contable', unidades_por_caja: 1, presentacion: 'Unidad', stock_minimo: 8, color: '#00838F', fecha_creacion: '2024-02-11'},
                {id: 18, id_producto: 'PROD018', producto: 'Batería 12V', imagen: '', categoria: 'Repuestos', unidad: 'Unidades', tipo_control: 'Contable', unidades_por_caja: 1, presentacion: 'Unidad', stock_minimo: 15, color: '#00897B', fecha_creacion: '2024-02-11'}
            ],
            registro_trabajo: [
                {id: 1, id_registro: 'REG001', fecha: '2024-02-14', id_usuario: 'USR001', nombre: 'Carlos Mendoza', zona_trabajo: 'Zona A', turno: 'Mañana', horas_trabajadas: 8, observaciones: 'Trabajo normal'},
                {id: 2, id_registro: 'REG002', fecha: '2024-02-14', id_usuario: 'USR002', nombre: 'María López', zona_trabajo: 'Zona B', turno: 'Tarde', horas_trabajadas: 8, observaciones: 'Supervisión de voladura'},
                {id: 3, id_registro: 'REG003', fecha: '2024-02-13', id_usuario: 'USR003', nombre: 'Juan Pérez', zona_trabajo: 'Zona A', turno: 'Noche', horas_trabajadas: 8, observaciones: 'Operación de maquinaria'}
            ],
            movimiento: [
                {id: 1, id_movimiento: 'MOV001', tipo_movimiento: 'Entrada', id_producto: 'PROD001', producto: 'Fulminante', categoria: 'Voladura', unidad: 'Caja', cajas_movidas: 5, unidades_movidas: 500, cantidad_simple: 500, fecha_creacion: '2024-02-14', receptor: 'USR001 - Carlos Mendoza'},
                {id: 2, id_movimiento: 'MOV002', tipo_movimiento: 'Salida', id_producto: 'PROD002', producto: 'Dinamita', categoria: 'Explosivos', unidad: 'Kg', cajas_movidas: 0, unidades_movidas: 0, cantidad_simple: 30, fecha_creacion: '2024-02-14', receptor: 'USR002 - María López'},
                {id: 3, id_movimiento: 'MOV003', tipo_movimiento: 'Entrada', id_producto: 'PROD003', producto: 'Casco de Seguridad', categoria: 'EPP', unidad: 'Unidades', cajas_movidas: 0, unidades_movidas: 0, cantidad_simple: 20, fecha_creacion: '2024-02-13', receptor: 'USR003 - Juan Pérez'}
            ],
            avance: [
                {id: 1, id_avance: 'AVA001', fecha: '2024-02-14', zona: 'Zona A-12', tipo_labor: 'Perforación', avance_metros: 15.5, turno: 'Mañana', personal: 5, observaciones: 'Avance según cronograma'},
                {id: 2, id_avance: 'AVA002', fecha: '2024-02-13', zona: 'Zona B-05', tipo_labor: 'Extracción', avance_metros: 12.3, turno: 'Tarde', personal: 6, observaciones: 'Retraso por mantenimiento'}
            ],
            produccion: [
                {id: 1, fecha: '2024-02-14', zona: 'Zona A', mineral: 'Oro', cantidad: 150, turno: 'Mañana'},
                {id: 2, fecha: '2024-02-13', zona: 'Zona B', mineral: 'Plata', cantidad: 300, turno: 'Tarde'},
                {id: 3, fecha: '2024-02-12', zona: 'Zona A', mineral: 'Cobre', cantidad: 450, turno: 'Noche'}
            ],
            voladura: [
                {id: 1, fecha: '2024-02-14', zona: 'Zona A-12', explosivo: 'ANFO', cantidad: 500, taladros: 45, estado: 'Completado'},
                {id: 2, fecha: '2024-02-13', zona: 'Zona B-05', explosivo: 'Dinamita', cantidad: 300, taladros: 30, estado: 'En Proceso'}
            ]
        };

        // ========================================
        // SISTEMA DE GESTIÓN DE CAMPAÑAS
        // ========================================
        
        async function inicializarSistemaCampañas() {
            const sistema = (await DB.leerCampanias());
            
            if (!sistema) {
                // Primera vez: crear sistema SIN usuarios ni insumos
                const fechaHoy = new Date().toISOString().split('T')[0];
                const mesActual = new Date().toLocaleString('es-ES', { month: 'long', year: 'numeric' });
                
                const sistemaNuevo = {
                    version: "1.0",
                    campañaActual: {
                        id: 1,
                        nombre: `Campaña ${mesActual}`,
                        fechaInicio: fechaHoy,
                        fechaFin: null,
                        fechaFinPrevista: null,
                        estado: "activa",
                        datos: {
                            movimiento: DATA.movimiento || [],
                            avance: DATA.avance || [],
                            produccion: DATA.produccion || [],
                            voladura: DATA.voladura || [],
                            registro_trabajo: DATA.registro_trabajo || []
                        }
                    },
                    campañasArchivadas: []
                    // ✅ NO incluye usuarios ni insumos - permanecen solo en DATA
                };
                
                await DB.guardarCampania(sistemaNuevo);
                console.log('✅ Sistema de campañas inicializado (SIN usuarios/insumos en sistema)');
                return sistemaNuevo;
            } else {
                const sistemaExistente = JSON.parse(sistema);
                console.log('📦 Sistema de campañas cargado');
                return sistemaExistente;
            }
        }
        
        async function cargarCampañaActiva() {
            const sistema = inicializarSistemaCampañas();
            
            // Solo cargar datos de campaña (NO usuarios ni insumos)
            if (sistema.campañaActual) {
                DATA.movimiento = sistema.campañaActual.datos.movimiento || [];
                DATA.avance = sistema.campañaActual.datos.avance || [];
                DATA.produccion = sistema.campañaActual.datos.produccion || [];
                DATA.voladura = sistema.campañaActual.datos.voladura || [];
                DATA.registro_trabajo = sistema.campañaActual.datos.registro_trabajo || [];
            }
            
            // ✅ Usuarios e Insumos NUNCA se tocan - permanecen en DATA original
            console.log('📦 Campaña cargada. Usuarios en DATA:', DATA.usuarios.length);
        }
        
        async function guardarEnCampañaActiva() {
            const sistema = (await DB.leerCampanias());
            
            if (sistema.campañaActual) {
                sistema.campañaActual.datos.movimiento = DATA.movimiento;
                sistema.campañaActual.datos.avance = DATA.avance;
                sistema.campañaActual.datos.produccion = DATA.produccion;
                sistema.campañaActual.datos.voladura = DATA.voladura;
                sistema.campañaActual.datos.registro_trabajo = DATA.registro_trabajo;
            }
            
            // ✅ Usuarios e Insumos NO se guardan - permanecen independientes
            
            await DB.guardarCampania(sistema);
        }
        
        async function iniciarNuevaCampaña(nombreCampaña, fechaInicio, duracionMeses) {
            const sistema = (await DB.leerCampanias());
            
            if (sistema.campañaActual && sistema.campañaActual.estado === 'activa') {
                if (!confirm('¿Está seguro? Esto archivará la campaña actual y creará una nueva campaña vacía.')) {
                    return false;
                }
                finalizarCampañaActual();
            }
            
            const inicio = new Date(fechaInicio);
            const fin = new Date(inicio);
            fin.setMonth(fin.getMonth() + parseInt(duracionMeses));
            fin.setDate(fin.getDate() - 1);
            
            const nuevaCampaña = {
                id: Date.now(),
                nombre: nombreCampaña,
                fechaInicio: fechaInicio,
                fechaFin: null,
                fechaFinPrevista: fin.toISOString().split('T')[0],
                estado: "activa",
                datos: {
                    movimiento: [],
                    avance: [],
                    produccion: [],
                    voladura: [],
                    registro_trabajo: []
                }
            };
            
            sistema.campañaActual = nuevaCampaña;
            await DB.guardarCampania(sistema);
            cargarCampañaActiva();
            
            alert('✅ Nueva campaña iniciada con éxito. Las tablas están limpias para empezar.');
            return true;
        }
        
        async function finalizarCampañaActual() {
            const sistema = (await DB.leerCampanias());
            
            if (!sistema.campañaActual || sistema.campañaActual.estado !== 'activa') {
                alert('No hay campaña activa para finalizar');
                return false;
            }
            
            if (!confirm('¿Está seguro de finalizar la campaña actual? Los datos se archivarán.')) {
                return false;
            }
            
            sistema.campañaActual.estado = 'finalizada';
            sistema.campañaActual.fechaFin = new Date().toISOString().split('T')[0];
            
            const datos = sistema.campañaActual.datos;
            sistema.campañaActual.estadisticas = {
                totalMovimientos: datos.movimiento.length,
                totalAvance: datos.avance.reduce((sum, a) => sum + (parseFloat(a.avance_metros) || 0), 0),
                totalProduccion: datos.produccion.reduce((sum, p) => sum + (parseFloat(p.cantidad) || 0), 0),
                totalVoladuras: datos.voladura.length,
                totalRegistros: datos.registro_trabajo.length
            };
            
            sistema.campañasArchivadas.push({...sistema.campañaActual});
            sistema.campañaActual = null;
            
            await DB.guardarCampania(sistema);
            
            alert('✅ Campaña finalizada y archivada. Inicie una nueva campaña para continuar.');
            return true;
        }
        
        async function verCampañaArchivada(campañaId) {
            const sistema = (await DB.leerCampanias());
            const campaña = sistema.campañasArchivadas.find(c => c.id === campañaId);
            
            if (!campaña) {
                alert('Campaña no encontrada');
                return;
            }
            
            // ⚠️ ALERTA DE CONFIRMACIÓN
            const confirmar = confirm(`📂 VER CAMPAÑA ARCHIVADA

Campaña: ${campaña.nombre}
Período: ${new Date(campaña.fechaInicio).toLocaleDateString('es-ES')} al ${new Date(campaña.fechaFin).toLocaleDateString('es-ES')}

📊 Datos registrados:
• Movimientos: ${campaña.estadisticas?.totalMovimientos || 0}
• Avance: ${campaña.estadisticas?.totalAvance?.toFixed(1) || 0} m
• Producción: ${campaña.estadisticas?.totalProduccion?.toFixed(0) || 0}

⚠️ MODO SOLO LECTURA:
✓ Podrás VER todos los datos
✓ Podrás EXPORTAR reportes
✗ NO podrás AGREGAR registros
✗ NO podrás EDITAR datos
✗ NO podrás ELIMINAR información

Para volver a la campaña actual, usa el botón "Volver".

¿Deseas continuar?`);
            
            if (!confirmar) {
                return; // Usuario canceló
            }
            
            // Cargar datos de campaña archivada
            DATA.movimiento = [...campaña.datos.movimiento];
            DATA.avance = [...campaña.datos.avance];
            DATA.produccion = [...campaña.datos.produccion];
            DATA.voladura = [...campaña.datos.voladura];
            DATA.registro_trabajo = [...campaña.datos.registro_trabajo];
            
            // Marcar modo visualización
            window.modoVisualizacionCampaña = true;
            window.campañaVisualizando = campaña;
            
            // Ir a la vista de movimientos para que vea los datos
            switchView('movimiento');
            
            // Actualizar dashboard con datos de la campaña
            actualizarDashboard();
            
            // Mostrar alerta persistente
            const alertHtml = `
                <div id="alertaCampañaArchivada" class="alert alert-warning alert-dismissible fade show" role="alert" 
                     style="position:fixed;top:70px;right:20px;z-index:9999;max-width:450px;box-shadow:0 4px 6px rgba(0,0,0,0.1);">
                    <strong>📂 Modo Visualización - Solo Lectura</strong><br>
                    <strong>Campaña:</strong> ${campaña.nombre}<br>
                    <small><strong>Período:</strong> ${new Date(campaña.fechaInicio).toLocaleDateString('es-ES')} al ${new Date(campaña.fechaFin).toLocaleDateString('es-ES')}</small>
                    <hr class="my-2">
                    <small><strong>Estadísticas:</strong><br>
                    • Movimientos: ${campaña.estadisticas?.totalMovimientos || 0}<br>
                    • Avance: ${campaña.estadisticas?.totalAvance?.toFixed(1) || 0} m<br>
                    • Producción: ${campaña.estadisticas?.totalProduccion?.toFixed(0) || 0}</small>
                    <button type="button" class="btn btn-sm btn-primary mt-2 w-100" onclick="volverACampañaActual()">
                        <i class="fas fa-arrow-left"></i> Volver a Campaña Actual
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" onclick="volverACampañaActual()"></button>
                </div>
            `;
            
            // Remover alertas anteriores
            document.querySelectorAll('#alertaCampañaArchivada').forEach(a => a.remove());
            
            // Agregar nueva alerta
            document.body.insertAdjacentHTML('beforeend', alertHtml);
            
            // Deshabilitar botones de agregar/editar/eliminar en modo visualización
            deshabilitarEdicionEnModoVisualizacion();
            
            // Mostrar botón de volver en el header
            const btnVolver = document.getElementById('btnVolverCampañaActual');
            if (btnVolver) {
                btnVolver.style.display = 'inline-block';
            }
        }
        
        function deshabilitarEdicionEnModoVisualizacion() {
            // Deshabilitar botón agregar
            const btnAgregar = document.getElementById('btnAgregar');
            if (btnAgregar) {
                btnAgregar.disabled = true;
                btnAgregar.innerHTML = '<i class="fas fa-eye-slash"></i> Modo Solo Lectura';
                btnAgregar.classList.remove('btn-primary');
                btnAgregar.classList.add('btn-secondary');
            }
        }
        
        function habilitarEdicion() {
            // Habilitar botón agregar
            const btnAgregar = document.getElementById('btnAgregar');
            if (btnAgregar) {
                btnAgregar.disabled = false;
                btnAgregar.innerHTML = '<i class="fas fa-plus"></i> Agregar';
                btnAgregar.classList.remove('btn-secondary');
                btnAgregar.classList.add('btn-primary');
            }
        }
        
        async function volverACampañaActual() {
            // Obtener información de la campaña que está visualizando
            const campañaVisualizando = window.campañaVisualizando;
            
            if (!campañaVisualizando) {
                // Si no hay campaña visualizando, simplemente salir
                return;
            }
            
            // ⚠️ ALERTA DE CONFIRMACIÓN
            const confirmar = confirm(`🔄 VOLVER A CAMPAÑA ACTUAL

Estás visualizando:
📂 ${campañaVisualizando.nombre}
📅 ${new Date(campañaVisualizando.fechaInicio).toLocaleDateString('es-ES')} al ${new Date(campañaVisualizando.fechaFin).toLocaleDateString('es-ES')}

Al volver a la campaña actual:
✓ Cargarás los datos de la campaña activa
✓ Podrás agregar y editar registros nuevamente
✓ Dejarás de ver los datos archivados

¿Deseas volver a la campaña actual?`);
            
            if (!confirmar) {
                return; // Usuario canceló
            }
            
            window.modoVisualizacionCampaña = false;
            window.campañaVisualizando = null;
            
            // Cargar campaña activa
            cargarCampañaActiva();
            
            // Ir a movimientos para ver los datos actuales
            switchView('movimiento');
            
            // Actualizar dashboard
            actualizarDashboard();
            
            // Limpiar alertas
            document.querySelectorAll('#alertaCampañaArchivada').forEach(a => a.remove());
            document.querySelectorAll('.alert-warning').forEach(a => a.remove());
            
            // Rehabilitar edición
            habilitarEdicion();
            
            // Ocultar botón de volver en el header
            const btnVolver = document.getElementById('btnVolverCampañaActual');
            if (btnVolver) {
                btnVolver.style.display = 'none';
            }
            
            // Si estás en configuraciones, recargar la sección de campañas
            if (currentView === 'configuraciones') {
                cargarSeccionCampañas();
            }
            
            // Mensaje de confirmación
            const alertaVuelta = `
                <div class="alert alert-success alert-dismissible fade show" role="alert" 
                     style="position:fixed;top:70px;right:20px;z-index:9999;max-width:350px;">
                    <strong>✅ Campaña Actual Cargada</strong><br>
                    <small>Volviste a la campaña activa</small>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', alertaVuelta);
            
            // Auto-cerrar después de 3 segundos
            setTimeout(() => {
                document.querySelectorAll('.alert-success').forEach(a => a.remove());
            }, 3000);
        }
        
        async function iniciarNuevaCampañaUI() {
            const nombre = document.getElementById('nuevaCampañaNombre').value;
            const inicio = document.getElementById('nuevaCampañaInicio').value;
            const duracion = document.getElementById('nuevaCampañaDuracion').value;
            
            if (!nombre || !inicio) {
                alert('⚠️ Por favor complete todos los campos');
                return;
            }
            
            if (iniciarNuevaCampaña(nombre, inicio, duracion)) {
                location.reload();
            }
        }
        
        async function cargarSeccionCampañas() {
            const sistema = (await DB.leerCampanias() || {});
            const campañaActual = sistema.campañaActual;
            const campañasArchivadas = sistema.campañasArchivadas || [];
            
            let html = '';
            
            // ⚠️ ALERTA SI ESTÁ EN MODO VISUALIZACIÓN
            if (window.modoVisualizacionCampaña && window.campañaVisualizando) {
                html += `
                    <div class="alert alert-warning border-warning" style="border-width: 2px !important;">
                        <div class="d-flex align-items-center mb-3">
                            <div class="flex-grow-1">
                                <h5 class="mb-1"><i class="fas fa-exclamation-triangle"></i> Estás viendo una campaña archivada</h5>
                                <p class="mb-0">
                                    <strong>Campaña:</strong> ${window.campañaVisualizando.nombre}<br>
                                    <strong>Período:</strong> ${new Date(window.campañaVisualizando.fechaInicio).toLocaleDateString('es-ES')} - ${new Date(window.campañaVisualizando.fechaFin).toLocaleDateString('es-ES')}
                                </p>
                            </div>
                        </div>
                        <button class="btn btn-primary btn-lg w-100" onclick="volverACampañaActual()">
                            <i class="fas fa-arrow-left"></i> Volver a Campaña Actual
                        </button>
                    </div>
                    <hr class="my-4">
                `;
            }
            
            html += '<div class="row">';
            
            // CAMPAÑA ACTUAL
            html += '<div class="col-md-6"><h6 class="border-bottom pb-2 mb-3"><i class="fas fa-calendar-check text-success"></i> Campaña Actual</h6>';
            
            if (campañaActual) {
                html += `
                    <div class="card bg-light">
                        <div class="card-body">
                            <h5 class="card-title text-success">${campañaActual.nombre}</h5>
                            <p class="mb-2">
                                <strong>Inicio:</strong> ${new Date(campañaActual.fechaInicio).toLocaleDateString('es-ES')}<br>
                                ${campañaActual.fechaFinPrevista ? '<strong>Fin previsto:</strong> ' + new Date(campañaActual.fechaFinPrevista).toLocaleDateString('es-ES') + '<br>' : ''}
                                <strong>Estado:</strong> <span class="badge bg-success">🟢 Activa</span>
                            </p>
                            <hr>
                            <small class="text-muted">
                                <i class="fas fa-chart-line"></i> Registros actuales:<br>
                                • Movimientos: ${campañaActual.datos.movimiento.length}<br>
                                • Avance: ${campañaActual.datos.avance.length}<br>
                                • Producción: ${campañaActual.datos.produccion.length}<br>
                                • Voladura: ${campañaActual.datos.voladura.length}
                            </small>
                            <hr>
                            <button class="btn btn-danger w-100" onclick="finalizarCampañaActual(); renderConfiguraciones();">
                                <i class="fas fa-stop-circle"></i> Finalizar Campaña
                            </button>
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> No hay campaña activa. 
                        Inicie una nueva campaña para comenzar a trabajar.
                    </div>
                `;
            }
            
            html += '</div>';
            
            // NUEVA CAMPAÑA
            html += `
                <div class="col-md-6">
                    <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-plus-circle text-primary"></i> Iniciar Nueva Campaña</h6>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Nombre de la Campaña</label>
                        <input type="text" class="form-control" id="nuevaCampañaNombre" 
                               placeholder="Ej: Campaña Marzo-Abril 2026">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Fecha de Inicio</label>
                        <input type="date" class="form-control" id="nuevaCampañaInicio" 
                               value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Duración</label>
                        <select class="form-select" id="nuevaCampañaDuracion">
                            <option value="1">1 mes</option>
                            <option value="2" selected>2 meses</option>
                            <option value="3">3 meses</option>
                        </select>
                    </div>
                    <button class="btn btn-primary w-100" onclick="iniciarNuevaCampañaUI()">
                        <i class="fas fa-play-circle"></i> Iniciar Nueva Campaña
                    </button>
                    ${campañaActual ? '<small class="text-warning d-block mt-2"><i class="fas fa-exclamation-triangle"></i> Esto finalizará y archivará la campaña actual</small>' : ''}
                </div>
            `;
            
            html += '</div>';
            
            // CAMPAÑAS ARCHIVADAS
            if (campañasArchivadas.length > 0) {
                html += `
                    <hr class="my-4">
                    <h6 class="border-bottom pb-2 mb-3">
                        <i class="fas fa-archive text-secondary"></i> Campañas Archivadas 
                        (${campañasArchivadas.length})
                    </h6>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Nombre</th>
                                    <th>Período</th>
                                    <th>Registros</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                campañasArchivadas.slice().reverse().forEach(c => {
                    html += `
                        <tr>
                            <td><strong>${c.nombre}</strong></td>
                            <td>
                                <small>${new Date(c.fechaInicio).toLocaleDateString('es-ES')} - 
                                ${new Date(c.fechaFin).toLocaleDateString('es-ES')}</small>
                            </td>
                            <td>
                                <small>
                                    ${c.estadisticas ? 
                                        c.estadisticas.totalMovimientos + ' mov, ' + 
                                        c.estadisticas.totalAvance.toFixed(1) + ' m, ' + 
                                        c.estadisticas.totalProduccion.toFixed(0) + ' prod' 
                                        : 'N/A'}
                                </small>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="verCampañaArchivada(${c.id})">
                                    <i class="fas fa-eye"></i> Ver
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            document.getElementById('seccionCampañas').innerHTML = html;
        }

        async function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                alert('Por favor, ingrese usuario y contraseña');
                return;
            }

            // Mostrar indicador de carga
            const btnLogin = document.querySelector('#loginScreen .btn-primary');
            const textoOriginal = btnLogin ? btnLogin.innerHTML : '';
            if (btnLogin) {
                btnLogin.disabled = true;
                btnLogin.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Conectando...';
            }

            try {
                // Cargar todos los datos desde Google Sheets
                showNotification('Conectando con la base de datos...', 'info');
                const todosLosDatos = await DB.leerTodo();
                
                if (todosLosDatos) {
                    // Actualizar DATA con datos reales de Google Sheets
                    if (todosLosDatos.usuarios && todosLosDatos.usuarios.length > 0) DATA.usuarios = todosLosDatos.usuarios;
                    if (todosLosDatos.insumos && todosLosDatos.insumos.length > 0) DATA.insumos = todosLosDatos.insumos;
                    if (todosLosDatos.movimiento) DATA.movimiento = todosLosDatos.movimiento;
                    if (todosLosDatos.avance) DATA.avance = todosLosDatos.avance;
                    if (todosLosDatos.produccion) DATA.produccion = todosLosDatos.produccion;
                    if (todosLosDatos.voladura) DATA.voladura = todosLosDatos.voladura;
                    if (todosLosDatos.registro_trabajo) DATA.registro_trabajo = todosLosDatos.registro_trabajo;
                    // Cargar config cache
                    if (todosLosDatos.configuracion) {
                        _configCache = {};
                        todosLosDatos.configuracion.forEach(row => {
                            if (row.clave) _configCache[row.clave] = row.valor;
                        });
                    }
                    // Cargar zonas cache
                    if (todosLosDatos.zonas_trabajo) {
                        _zonasCache = todosLosDatos.zonas_trabajo.map(r => r.zona || r).filter(Boolean);
                    }
                }
                
                // Buscar usuario
                const user = DATA.usuarios.find(u => String(u.id_usuario).toUpperCase() === username.toUpperCase());
                
                if (user) {
                    if (String(user.estado) !== 'Activo') {
                        alert('Usuario inactivo. Contacte al administrador.');
                        return;
                    }
                    if (String(user.password) === password) {
                        currentUser = {
                            username: user.id_usuario,
                            nombre: user.nombre,
                            rol: user.rol,
                            email: user.email,
                            avatar: user.avatar
                        };
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('mainSystem').style.display = 'block';
                        document.getElementById('userDisplay').textContent = `${currentUser.nombre} (${currentUser.rol})`;
                        actualizarDashboard();
                    } else {
                        alert('Usuario o contraseña incorrectos');
                    }
                } else {
                    alert('Usuario o contraseña incorrectos');
                }
            } catch(e) {
                console.error('Error en login:', e);
                alert('Error de conexión. Verifica que el SCRIPT_URL esté configurado correctamente.');
            } finally {
                if (btnLogin) {
                    btnLogin.disabled = false;
                    btnLogin.innerHTML = textoOriginal;
                }
            }
        }
        
        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const toggleIcon = document.getElementById('toggleIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainSystem').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }
        
        // Función para actualizar dashboard con datos en tiempo real
        function actualizarDashboard() {
            const hoy = new Date().toISOString().split('T')[0];
            const mesActual = new Date().toISOString().slice(0, 7); // YYYY-MM
            
            // 1. Total Usuarios
            const totalUsuarios = DATA.usuarios.length;
            const usuariosActivos = DATA.usuarios.filter(u => u.estado === 'Activo').length;
            document.getElementById('totalUsuarios').textContent = totalUsuarios;
            document.getElementById('usuariosActivos').textContent = usuariosActivos;
            
            // 2. Total Insumos y Stock Bajo
            const totalInsumos = DATA.insumos.length;
            const insumosStockBajo = DATA.insumos.filter(i => {
                const stockActual = i.stock_actual || 0;
                const stockMinimo = i.stock_minimo || 0;
                return stockActual < stockMinimo;
            }).length;
            document.getElementById('totalInsumos').textContent = totalInsumos;
            document.getElementById('insumosStockBajo').textContent = insumosStockBajo;
            
            // 3. Movimientos de hoy (usar campo 'fecha' no 'fecha_creacion')
            const movimientosHoy = DATA.movimiento ? DATA.movimiento.filter(m => m.fecha === hoy).length : 0;
            const entradasHoy = DATA.movimiento ? DATA.movimiento.filter(m => m.fecha === hoy && m.tipo === 'Entrada').length : 0;
            const salidasHoy = DATA.movimiento ? DATA.movimiento.filter(m => m.fecha === hoy && m.tipo === 'Salida').length : 0;
            document.getElementById('totalMovimientos').textContent = movimientosHoy;
            document.getElementById('movEntradas').textContent = entradasHoy;
            document.getElementById('movSalidas').textContent = salidasHoy;
            
            // 4. Trabajadores hoy
            const trabajadoresHoy = DATA.registro_trabajo ? DATA.registro_trabajo.filter(t => t.fecha === hoy).length : 0;
            
            // Obtener jornadas del día
            const jornadasHoy = DATA.registro_trabajo ? 
                DATA.registro_trabajo.filter(t => t.fecha === hoy).map(t => parseFloat(t.horas_trabajadas) || 0) : [];
            
            let jornadaTexto = '0';
            if (jornadasHoy.length > 0) {
                // Verificar si todos tienen la misma jornada
                const jornadasUnicas = [...new Set(jornadasHoy)];
                
                if (jornadasUnicas.length === 1) {
                    // Todos tienen la misma jornada
                    const jornada = jornadasUnicas[0];
                    if (jornada === 1) jornadaTexto = 'T';
                    else if (jornada === 1.5) jornadaTexto = 'TM';
                    else if (jornada === 0.5) jornadaTexto = 'M';
                    else jornadaTexto = String(jornada);
                } else {
                    // Tienen diferentes jornadas, mostrar todas
                    jornadaTexto = jornadasUnicas.map(j => {
                        if (j === 1) return 'T';
                        else if (j === 1.5) return 'TM';
                        else if (j === 0.5) return 'M';
                        else return String(j);
                    }).join(', ');
                }
            }
            
            document.getElementById('trabajadoresHoy').textContent = trabajadoresHoy;
            document.getElementById('horasTrabajadas').textContent = jornadaTexto;
            
            // 5. Producción del mes - mostrar según unidad registrada
            const produccionDelMes = DATA.produccion ? 
                DATA.produccion.filter(p => p.fecha && p.fecha.startsWith(mesActual)) : [];
            
            let textoProduccion = '0';
            if (produccionDelMes.length > 0) {
                // Agrupar por unidad
                const porUnidad = {};
                produccionDelMes.forEach(p => {
                    const unidad = p.unidad || 'Unidades';
                    if (!porUnidad[unidad]) porUnidad[unidad] = 0;
                    porUnidad[unidad] += parseFloat(p.cantidad) || 0;
                });
                
                // Crear texto con todas las unidades
                const unidades = Object.keys(porUnidad);
                if (unidades.length === 1) {
                    // Una sola unidad
                    textoProduccion = `${porUnidad[unidades[0]].toFixed(0)} ${unidades[0]}`;
                } else {
                    // Múltiples unidades
                    textoProduccion = unidades.map(u => `${porUnidad[u].toFixed(0)} ${u}`).join(' + ');
                }
            }
            
            document.getElementById('produccionMes').textContent = textoProduccion;
            
            // 6. Avance del mes
            const avanceMes = DATA.avance ? 
                DATA.avance.filter(a => a.fecha && a.fecha.startsWith(mesActual)).reduce((sum, a) => sum + (parseFloat(a.avance_metros) || 0), 0) : 0;
            document.getElementById('avanceMes').textContent = `${avanceMes.toFixed(1)} m`;
        }
        
        // Permitir login con tecla Enter
        document.addEventListener('DOMContentLoaded', async function() {
            // === CARGAR CAMPAÑA ACTIVA AL INICIO ===
            cargarCampañaActiva();
            
            // === INICIALIZAR ZONAS DE TRABAJO - VACÍO AL INICIO ===
            // Empezar sin ninguna zona predefinida
            const zonasDefault = [];
            await setZonas(zonasDefault);
            console.log('✅ Zonas inicializadas: Lista vacía');
            
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            
            // Agregar event listener para Enter en ambos campos
            if (usernameInput) {
                usernameInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        login();
                    }
                });
            }
            
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        login();
                    }
                });
            }
            
            // Actualizar datalist de zonas cuando se cierra el modal
            const modalDetalles = document.getElementById('modalDetalles');
            if (modalDetalles) {
                modalDetalles.addEventListener('hidden.bs.modal', function() {
                    // Actualizar el datalist de zona_trabajo si existe
                    const datalistZonas = document.getElementById('zonas-trabajo-list');
                    if (datalistZonas) {
                        const zonas = (await getZonas());
                        
                        // Actualizar opciones del datalist
                        datalistZonas.innerHTML = zonas.map(z => `<option value="${z}">`).join('');
                    }
                });
            }
        });

        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            
            if (!reportType) {
                alert('Seleccione un tipo de reporte');
                return;
            }
            
            if (reportType === 'trabajo') {
                renderReporteTrabajo();
            } else {
                renderReporteGeneral(reportType, fechaInicio, fechaFin);
            }
        }

        function renderReporteTrabajo() {
            const trabajadores = DATA.usuarios;
            let html = '<h5 class="mb-3">Reporte de Días Trabajados</h5>';
            html += '<div class="table-responsive"><table class="table table-hover"><thead><tr>';
            html += '<th>ID</th><th>Nombre</th><th>Rol</th><th>Estado</th><th>Días Trabajados</th><th>Fecha Registro</th></tr></thead><tbody>';
            
            let totalDias = 0;
            trabajadores.forEach(t => {
                html += `<tr><td>#${t.id}</td><td>${t.nombre}</td><td><span class="badge bg-primary">${t.rol}</span></td><td><span class="badge ${t.estado === 'Activo' ? 'bg-success' : 'bg-secondary'}">${t.estado}</span></td><td>${t.dias} días</td><td>${t.fechaRegistro}</td></tr>`;
                totalDias += t.dias;
            });
            
            html += '</tbody></table></div>';
            
            html += '<div class="summary-card">';
            html += '<div class="summary-title"><i class="fas fa-calculator"></i> Resumen de Días Trabajados</div>';
            html += `<div class="summary-row"><span>Total de Trabajadores:</span><span>${trabajadores.length}</span></div>`;
            html += `<div class="summary-row"><span>Trabajadores Activos:</span><span>${trabajadores.filter(t => t.estado === 'Activo').length}</span></div>`;
            html += `<div class="summary-row"><span>Total Días Trabajados:</span><span>${totalDias} días</span></div>`;
            html += `<div class="summary-row"><span>Promedio por Trabajador:</span><span>${Math.round(totalDias/trabajadores.length)} días</span></div>`;
            html += '</div>';
            
            document.getElementById('tableContent').innerHTML = html;
        }

        function renderReporteGeneral(tipo, inicio, fin) {
            let datos = DATA[tipo] || [];
            let html = `<h5 class="mb-3">Reporte de ${tipo.charAt(0).toUpperCase() + tipo.slice(1)}</h5>`;
            
            if (inicio && fin) {
                datos = datos.filter(d => d.fecha >= inicio && d.fecha <= fin);
                html += `<p class="text-muted mb-3">Período: ${inicio} a ${fin}</p>`;
            }
            
            html += '<div class="table-responsive"><table class="table table-hover"><thead><tr>';
            
            if (tipo === 'insumos') {
                html += '<th>ID</th><th>Nombre</th><th>Categoría</th><th>Cantidad</th><th>Estado</th></tr></thead><tbody>';
                let totalCantidad = 0;
                datos.forEach(i => {
                    html += `<tr><td>#${i.id}</td><td>${i.nombre}</td><td>${i.categoria}</td><td>${i.cantidad} ${i.unidad}</td><td><span class="badge ${i.estado === 'Disponible' ? 'bg-success' : 'bg-warning'}">${i.estado}</span></td></tr>`;
                    totalCantidad += i.cantidad;
                });
                html += `</tbody></table></div><div class="summary-card"><div class="summary-title">Resumen</div><div class="summary-row"><span>Total Items:</span><span>${datos.length}</span></div><div class="summary-row"><span>Cantidad Total:</span><span>${totalCantidad}</span></div></div>`;
            } else if (tipo === 'movimiento') {
                html += '<th>Fecha</th><th>Tipo</th><th>Insumo</th><th>Cantidad</th><th>Responsable</th></tr></thead><tbody>';
                let entradas = 0, salidas = 0;
                datos.forEach(m => {
                    html += `<tr><td>${m.fecha}</td><td><span class="badge ${m.tipo === 'Entrada' ? 'bg-success' : 'bg-danger'}">${m.tipo}</span></td><td>${m.insumo}</td><td>${m.cantidad}</td><td>${m.responsable}</td></tr>`;
                    if (m.tipo === 'Entrada') entradas += m.cantidad;
                    else salidas += m.cantidad;
                });
                html += `</tbody></table></div><div class="summary-card"><div class="summary-title">Resumen</div><div class="summary-row"><span>Total Movimientos:</span><span>${datos.length}</span></div><div class="summary-row"><span>Total Entradas:</span><span>${entradas}</span></div><div class="summary-row"><span>Total Salidas:</span><span>${salidas}</span></div><div class="summary-row"><span>Balance:</span><span>${entradas - salidas}</span></div></div>`;
            } else if (tipo === 'produccion') {
                html += '<th>Fecha</th><th>Zona</th><th>Mineral</th><th>Cantidad</th><th>Turno</th></tr></thead><tbody>';
                let totalProduccion = 0;
                datos.forEach(p => {
                    html += `<tr><td>${p.fecha}</td><td>${p.zona}</td><td>${p.mineral}</td><td>${p.cantidad} Kg</td><td>${p.turno}</td></tr>`;
                    totalProduccion += p.cantidad;
                });
                html += `</tbody></table></div><div class="summary-card"><div class="summary-title">Resumen</div><div class="summary-row"><span>Total Registros:</span><span>${datos.length}</span></div><div class="summary-row"><span>Producción Total:</span><span>${totalProduccion} Kg</span></div><div class="summary-row"><span>Promedio:</span><span>${Math.round(totalProduccion/datos.length)} Kg</span></div></div>`;
            }
            
            document.getElementById('tableContent').innerHTML = html;
        }

        function renderTable(view) {
            let html = '';
            currentData = DATA[view] || [];
            
            if (view === 'usuarios' && currentUser.rol !== 'admin') {
                html += '<div class="alert alert-info" role="alert"><i class="fas fa-info-circle"></i> <strong>Información:</strong> Solo el Administrador puede editar o eliminar usuarios.</div>';
            }
            
            // Botón especial para registro_trabajo
            if (view === 'registro_trabajo') {
                html += `
                    <div class="alert alert-success d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <i class="fas fa-calendar-week"></i> <strong>Reporte de Asistencia Semanal</strong>
                            <p class="mb-0 small">Genera un PDF con el registro de asistencia por semanas y días trabajados</p>
                        </div>
                        <button class="btn btn-success" onclick="exportarAsistenciaSemanal()">
                            <i class="fas fa-file-pdf"></i> Generar PDF Asistencia
                        </button>
                    </div>
                `;
            }
            
            // Botón especial para avance
            if (view === 'avance') {
                html += `
                    <div class="alert alert-primary d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <i class="fas fa-chart-line"></i> <strong>Reporte Semanal de Avances</strong>
                            <p class="mb-0 small">Genera un PDF profesional con el resumen de avances por labor, tipo y turno</p>
                        </div>
                        <button class="btn btn-primary" onclick="exportarAvanceSemanal()">
                            <i class="fas fa-file-pdf"></i> Generar PDF Avance
                        </button>
                    </div>
                `;
            }
            
            // Botón especial para producción
            if (view === 'produccion') {
                html += `
                    <div class="alert alert-warning d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <i class="fas fa-industry"></i> <strong>Reporte Semanal de Producción</strong>
                            <p class="mb-0 small">Genera un PDF con producción por zonas y total de mineral extraído</p>
                        </div>
                        <button class="btn btn-warning" onclick="exportarProduccionSemanal()">
                            <i class="fas fa-file-pdf"></i> Generar PDF Producción
                        </button>
                    </div>
                `;
            }
            
            // Botón especial para movimiento
            if (view === 'movimiento') {
                html += `
                    <div class="alert alert-info d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <i class="fas fa-exchange-alt"></i> <strong>Reporte Semanal de Movimientos</strong>
                            <p class="mb-0 small">Genera un PDF con entradas, salidas y stock de insumos</p>
                        </div>
                        <button class="btn btn-info" onclick="exportarMovimientosSemanal()">
                            <i class="fas fa-file-pdf"></i> Generar PDF Movimientos
                        </button>
                    </div>
                `;
            }
            
            html += '<div class="table-responsive"><table class="table table-hover"><thead><tr>';
            
            if (view === 'usuarios') {
                html += '<th>ID Usuario</th><th>Nombre</th><th>Email</th><th>Rol</th><th>Estado</th><th>Fecha Registro</th><th>Acciones</th></tr></thead><tbody>';
                currentData.forEach(u => {
                    const canEdit = currentUser.rol === 'admin';
                    html += `<tr><td>${u.id_usuario}</td><td>${u.nombre}</td><td>${u.email}</td><td><span class="badge bg-primary">${u.rol}</span></td><td><span class="badge bg-success">${u.estado}</span></td><td>${u.fecha_registro}</td><td>`;
                    html += `<button class="btn btn-sm btn-info me-1" onclick="viewDetails(${u.id}, 'usuarios')"><i class="fas fa-eye"></i> Ver</button> `;
                    if (canEdit) {
                        html += `<button class="btn btn-sm btn-warning me-1" onclick="openModal(${u.id})"><i class="fas fa-edit"></i></button> <button class="btn btn-sm btn-danger" onclick="deleteItem(${u.id})"><i class="fas fa-trash"></i></button>`;
                    } else {
                        html += `<button class="btn btn-sm btn-secondary" disabled><i class="fas fa-lock"></i> Bloqueado</button>`;
                    }
                    html += `</td></tr>`;
                });
            } else if (view === 'insumos') {
                html += '<th>Código</th><th>Producto</th><th>Categoría</th><th>Unidad</th><th>Stock Actual</th><th>Estado Stock</th><th>Acciones</th></tr></thead><tbody>';
                currentData.forEach(i => {
                    // Calcular color según stock
                    let stockColor = '';
                    let stockTexto = '';
                    const stockActual = i.stock_actual || 0;
                    const stockMinimo = i.stock_minimo || 0;
                    const umbralCerca = stockMinimo * 1.2; // 20% arriba del mínimo
                    
                    if (stockActual < stockMinimo) {
                        stockColor = '#DC3545'; // Rojo - Stock bajo
                        stockTexto = 'BAJO';
                    } else if (stockActual < umbralCerca) {
                        stockColor = '#FF9800'; // Naranja - Cerca del mínimo
                        stockTexto = 'MEDIO';
                    } else {
                        stockColor = '#28A745'; // Verde - Stock suficiente
                        stockTexto = 'OK';
                    }
                    
                    // Formatear stock para productos contables
                    let stockDisplay = stockActual;
                    if (i.tipo_control === 'Contable' && i.unidades_por_caja > 1) {
                        const cajas = i.stock_cajas || 0;
                        const unidades = i.stock_unidades || 0;
                        // Determinar el nombre de la unidad individual
                        let unidadNombre = 'unidades';
                        if (i.unidad === 'Pares') unidadNombre = 'pares';
                        else if (i.unidad === 'Rollo') unidadNombre = 'rollos';
                        else if (i.unidad === 'Bolsa') unidadNombre = 'bolsas';
                        
                        stockDisplay = `${cajas} cajas, ${unidades} ${unidadNombre}`;
                    } else if (i.tipo_control === 'Contable') {
                        const unidades = i.stock_unidades || 0;
                        stockDisplay = `${unidades} ${i.unidad.toLowerCase()}`;
                    }
                    
                    html += `<tr>
                        <td>${i.id_producto}</td>
                        <td><strong>${i.producto}</strong></td>
                        <td><span class="badge bg-secondary">${i.categoria}</span></td>
                        <td>${i.unidad}</td>
                        <td><strong>${stockDisplay}</strong></td>
                        <td>
                            <span class="badge" style="background:${stockColor};padding:5px 12px;font-weight:600;">
                                ${stockTexto}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info me-1" onclick="viewDetails(${i.id}, 'insumos')"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-warning me-1" onclick="openModal(${i.id})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteItem(${i.id})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                });
            } else if (view === 'movimiento') {
                html += '<th>Fecha</th><th>Tipo</th><th>Producto</th><th>Cantidad</th><th>Responsable</th><th>Acciones</th></tr></thead><tbody>';
                currentData.forEach(m => {
                    // Formatear cantidad según el tipo de producto
                    let cantidadDisplay = m.cantidad || 0;
                    
                    // Buscar el producto para saber si tiene cajas
                    const producto = DATA.insumos.find(p => p.producto === m.insumo);
                    if (producto && producto.tipo_control === 'Contable' && producto.unidades_por_caja > 1 && m.mov_cajas !== undefined) {
                        const cajas = m.mov_cajas || 0;
                        const unidades = m.mov_unidades || 0;
                        // Determinar el nombre de la unidad individual
                        let unidadNombre = 'unidades';
                        if (producto.unidad === 'Pares') unidadNombre = 'pares';
                        else if (producto.unidad === 'Rollo') unidadNombre = 'rollos';
                        else if (producto.unidad === 'Bolsa') unidadNombre = 'bolsas';
                        
                        cantidadDisplay = `${cajas} cajas, ${unidades} ${unidadNombre}`;
                    } else if (producto && producto.unidad) {
                        // Para productos medibles, agregar la unidad
                        cantidadDisplay = `${m.cantidad || 0} ${producto.unidad}`;
                    }
                    
                    html += `<tr>
                        <td>${m.fecha}</td>
                        <td><span class="badge ${m.tipo === 'Entrada' ? 'bg-success' : 'bg-danger'}">${m.tipo}</span></td>
                        <td><strong>${m.insumo}</strong></td>
                        <td>${cantidadDisplay}</td>
                        <td>${m.responsable}</td>
                        <td>
                            <button class="btn btn-sm btn-info me-1" onclick="viewDetails(${m.id}, 'movimiento')"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-warning me-1" onclick="openModal(${m.id})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteItem(${m.id})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                });
            } else if (view === 'registro_trabajo') {
                html += '<th>ID Registro</th><th>Fecha</th><th>Usuario</th><th>Nombre</th><th>Zona</th><th>Turno</th><th>Jornada</th><th>Observaciones</th><th>Acciones</th></tr></thead><tbody>';
                currentData.forEach(r => {
                    // Formatear jornada
                    let jornadaDisplay = '';
                    if (r.horas_trabajadas == 1) {
                        jornadaDisplay = '<span class="badge bg-success">T (1 día)</span>';
                    } else if (r.horas_trabajadas == 1.5) {
                        jornadaDisplay = '<span class="badge bg-info">TM (1.5 días)</span>';
                    } else if (r.horas_trabajadas == 0.5) {
                        jornadaDisplay = '<span class="badge bg-warning">M (0.5 días)</span>';
                    } else {
                        jornadaDisplay = `${r.horas_trabajadas}`;
                    }
                    
                    html += `<tr>
                        <td>${r.id_registro}</td>
                        <td>${r.fecha}</td>
                        <td>${r.id_usuario}</td>
                        <td>${r.nombre}</td>
                        <td><span class="badge bg-secondary">${r.zona_trabajo}</span></td>
                        <td>${r.turno}</td>
                        <td>${jornadaDisplay}</td>
                        <td>${r.observaciones || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-info me-1" onclick="viewDetails(${r.id}, 'registro_trabajo')"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-warning me-1" onclick="openModal(${r.id})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteItem(${r.id})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                });
            } else if (view === 'avance') {
                html += '<th>ID</th><th>Fecha</th><th>Labor/Zona</th><th>Tipo Labor</th><th>Actividad</th><th>Avance (m)</th><th>Jornada</th><th>Personal</th><th>Acciones</th></tr></thead><tbody>';
                currentData.forEach(a => {
                    let jornadaTexto = '';
                    if (a.jornada == 1) jornadaTexto = 'T (8h)';
                    else if (a.jornada == 1.5) jornadaTexto = 'TM (12h)';
                    else if (a.jornada == 0.5) jornadaTexto = 'M (4h)';
                    else jornadaTexto = a.jornada || '-';
                    
                    html += `<tr>
                        <td>${a.id_avance}</td>
                        <td>${a.fecha}</td>
                        <td>${a.zona}</td>
                        <td><span class="badge bg-info">${a.tipo_labor}</span></td>
                        <td>${a.actividad || '-'}</td>
                        <td><strong>${a.avance_metros} m</strong></td>
                        <td><span class="badge bg-success">${jornadaTexto}</span></td>
                        <td>${a.personal || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-info me-1" onclick="viewDetails(${a.id}, 'avance')"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-warning me-1" onclick="openModal(${a.id})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteItem(${a.id})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                });
            } else if (view === 'produccion') {
                html += '<th>Fecha</th><th>Zona</th><th>Mineral</th><th>Cantidad</th><th>Unidad</th><th>Acciones</th></tr></thead><tbody>';
                currentData.forEach(p => {
                    html += `<tr>
                        <td>${p.fecha}</td>
                        <td>${p.zona}</td>
                        <td><span class="badge bg-warning text-dark">${p.mineral}</span></td>
                        <td><strong>${p.cantidad}</strong></td>
                        <td><span class="badge bg-info">${p.unidad || 'Kg'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-info me-1" onclick="viewDetails(${p.id}, 'produccion')"><i class="fas fa-eye"></i> Ver</button>
                            <button class="btn btn-sm btn-warning me-1" onclick="openModal(${p.id})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteItem(${p.id})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                });
            } else if (view === 'voladura') {
                html += '<th>Fecha</th><th>Zona</th><th>Explosivo</th><th>Cantidad</th><th>Taladros</th><th>Estado</th><th>Acciones</th></tr></thead><tbody>';
                currentData.forEach(v => {
                    html += `<tr>
                        <td>${v.fecha}</td>
                        <td>${v.zona}</td>
                        <td>${v.explosivo}</td>
                        <td>${v.cantidad} Kg</td>
                        <td>${v.taladros}</td>
                        <td><span class="badge bg-info">${v.estado}</span></td>
                        <td>
                            <button class="btn btn-sm btn-info me-1" onclick="viewDetails(${v.id}, 'voladura')"><i class="fas fa-eye"></i> Ver</button>
                            <button class="btn btn-sm btn-warning me-1" onclick="openModal(${v.id})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteItem(${v.id})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                });
            }
            
            html += '</tbody></table></div>';
            document.getElementById('tableContent').innerHTML = html;
        }

        // Función de búsqueda en tabla
        function buscarEnTabla() {
            const searchValue = document.getElementById('searchInput').value.toLowerCase();
            const table = document.querySelector('#tableContent table');
            
            if (!table) return;
            
            const rows = table.getElementsByTagName('tr');
            
            for (let i = 1; i < rows.length; i++) { // Empezar en 1 para saltar el header
                const row = rows[i];
                let found = false;
                const cells = row.getElementsByTagName('td');
                
                for (let j = 0; j < cells.length; j++) {
                    const cellText = cells[j].textContent || cells[j].innerText;
                    if (cellText.toLowerCase().indexOf(searchValue) > -1) {
                        found = true;
                        break;
                    }
                }
                
                row.style.display = found ? '' : 'none';
            }
        }
        
        function exportExcel() {
            if (!currentData.length) return;
            
            // Definir columnas a excluir según la vista
            let excludeColumns = ['password', 'avatar', 'imagen', 'id'];
            
            // Para insumos, excluir también stock_minimo, color, tipo_control, unidades_por_caja, presentacion, stock_cajas, stock_unidades
            if (currentView === 'insumos') {
                excludeColumns = [...excludeColumns, 'stock_minimo', 'color', 'tipo_control', 'unidades_por_caja', 'presentacion', 'fecha_creacion', 'color_hex', 'stock_cajas', 'stock_unidades'];
            }
            
            // Para movimientos, excluir fecha_creacion (solo usar fecha)
            if (currentView === 'movimiento') {
                excludeColumns = [...excludeColumns, 'fecha_creacion'];
            }
            
            // Definir nombres profesionales de columnas
            const columnNames = {
                id_usuario: 'Código Usuario',
                nombre: 'Nombre',
                email: 'Correo',
                rol: 'Cargo',
                fecha_registro: 'Fecha Registro',
                estado: 'Estado',
                id_producto: 'Código',
                producto: 'Producto',
                categoria: 'Categoría',
                unidad: 'Unidad',
                cantidad: 'Cantidad Total',
                stock_actual: 'Stock',
                estado_stock: 'Estado Stock',
                fecha: 'Fecha',
                tipo: 'Tipo',
                insumo: 'Insumo',
                responsable: 'Responsable',
                id_registro: 'Código',
                zona_trabajo: 'Zona',
                turno: 'Turno',
                horas_trabajadas: 'Jornada',
                observaciones: 'Observaciones',
                id_avance: 'Código',
                zona: 'Zona',
                tipo_labor: 'Labor',
                avance_metros: 'Avance (m)',
                personal: 'Personal',
                mineral: 'Mineral',
                explosivo: 'Explosivo',
                taladros: 'Taladros',
                mov_cajas: 'Cajas',
                mov_unidades: 'Unidades',
                fecha_creacion: 'Fecha de Registro'
            };
            
            // Filtrar columnas
            let keys = Object.keys(currentData[0]).filter(key => !excludeColumns.includes(key));
            
            // Para insumos, agregar estado_stock
            if (currentView === 'insumos') {
                keys.push('estado_stock');
            }
            
            // Crear headers con nombres profesionales
            const headers = keys.map(key => columnNames[key] || key);
            let csv = headers.join(',') + '\n';
            
            // Agregar datos
            currentData.forEach(row => {
                const values = keys.map(key => {
                    // Para insumos, calcular estado_stock
                    if (currentView === 'insumos' && key === 'estado_stock') {
                        const stockActual = row.stock_actual || 0;
                        const stockMinimo = row.stock_minimo || 0;
                        const umbralCerca = stockMinimo * 1.2;
                        
                        let estadoStock = 'OK';
                        if (stockActual < stockMinimo) {
                            estadoStock = 'BAJO';
                        } else if (stockActual < umbralCerca) {
                            estadoStock = 'MEDIO';
                        }
                        return `"${estadoStock}"`;
                    }
                    
                    // Para insumos, formatear stock_actual concatenado
                    if (currentView === 'insumos' && key === 'stock_actual') {
                        if (row.tipo_control === 'Contable' && row.unidades_por_caja > 1) {
                            const cajas = row.stock_cajas || 0;
                            const unidades = row.stock_unidades || 0;
                            return `"${cajas} cajas, ${unidades} unidades"`;
                        } else if (row.tipo_control === 'Contable') {
                            const unidades = row.stock_unidades || 0;
                            return `"${unidades} ${row.unidad.toLowerCase()}"`;
                        }
                    }
                    
                    // Para movimientos: mostrar solo si el producto tiene cajas, sino dejar vacío
                    if (currentView === 'movimiento' && (key === 'mov_cajas' || key === 'mov_unidades')) {
                        // Buscar el producto para verificar si tiene cajas
                        const producto = DATA.insumos.find(p => p.producto === row.insumo);
                        if (producto && producto.tipo_control === 'Contable' && producto.unidades_por_caja > 1) {
                            // Solo mostrar valor si el producto es contable con cajas
                            return `"${row[key] || 0}"`;
                        }
                        // Si no es contable con cajas, dejar vacío
                        return '""';
                    }
                    
                    // Para fecha_creacion: quitar hora, solo fecha
                    if (key === 'fecha_creacion' && row[key]) {
                        const soloFecha = row[key].split('T')[0];
                        return `"${soloFecha}"`;
                    }
                    
                    // Para registro_trabajo: formatear jornada (horas_trabajadas)
                    if (currentView === 'registro_trabajo' && key === 'horas_trabajadas') {
                        if (row[key] == 1) return '"T (1 día)"';
                        if (row[key] == 1.5) return '"TM (1.5 días)"';
                        if (row[key] == 0.5) return '"M (0.5 días)"';
                        return `"${row[key]}"`;
                    }
                    
                    const value = row[key] || '';
                    // Escapar comas y comillas
                    return `"${String(value).replace(/"/g, '""')}"`;
                });
                csv += values.join(',') + '\n';
            });
            
            // Obtener nombre de empresa para el archivo
            const nombreEmpresa = ((await getConfig('config_nombreEmpresa', '')) || 'MINERA_SAC').replace(/\s+/g, '_');
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${nombreEmpresa}_${currentView}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Si estamos en reportes, exportar el reporte visible
            if (currentView === 'reportes') {
                const reportType = document.getElementById('reportType').value;
                const fechaInicio = document.getElementById('fechaInicio').value;
                const fechaFin = document.getElementById('fechaFin').value;
                
                if (!reportType) {
                    alert('Por favor genere un reporte primero');
                    return;
                }
                
                // Obtener nombre de empresa desde configuración
                const nombreEmpresa = (await getConfig('config_nombreEmpresa', '')) || 'MINERA SAC';
                
                // Título del reporte
                doc.setFontSize(18);
                doc.setTextColor(24, 119, 242);
                doc.text(nombreEmpresa, 14, 15);
                
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                const reportTitles = {
                    'insumos': 'Reporte de Insumos',
                    'movimiento': 'Reporte de Movimientos',
                    'produccion': 'Reporte de Producción',
                    'trabajo': 'Reporte de Días Trabajados'
                };
                doc.text(reportTitles[reportType] || 'Reporte', 14, 25);
                
                // Período si hay fechas
                if (fechaInicio && fechaFin) {
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Período: ${fechaInicio} al ${fechaFin}`, 14, 32);
                }
                
                // Fecha de generación
                doc.text(`Generado: ${new Date().toLocaleString('es-PE')}`, 14, fechaInicio && fechaFin ? 38 : 32);
                
                let startY = fechaInicio && fechaFin ? 45 : 38;
                
                // Exportar según tipo de reporte
                if (reportType === 'trabajo') {
                    const trabajadores = DATA.usuarios;
                    const tableData = trabajadores.map(t => [
                        `#${t.id}`,
                        t.nombre,
                        t.rol,
                        t.estado,
                        `${t.dias} días`,
                        t.fechaRegistro
                    ]);
                    
                    doc.autoTable({
                        head: [['ID', 'Nombre', 'Rol', 'Estado', 'Días Trabajados', 'Fecha Registro']],
                        body: tableData,
                        startY: startY,
                        theme: 'grid',
                        headStyles: { fillColor: [24, 119, 242], textColor: 255 },
                        margin: { top: 10 }
                    });
                    
                    // Resumen
                    const finalY = doc.lastAutoTable.finalY + 10;
                    const totalDias = trabajadores.reduce((sum, t) => sum + t.dias, 0);
                    const activos = trabajadores.filter(t => t.estado === 'Activo').length;
                    
                    doc.setFillColor(239, 246, 255);
                    doc.rect(14, finalY, 182, 40, 'F');
                    doc.setFontSize(12);
                    doc.setTextColor(30, 64, 175);
                    doc.text('RESUMEN', 16, finalY + 8);
                    
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    doc.text(`Total de Trabajadores: ${trabajadores.length}`, 16, finalY + 16);
                    doc.text(`Trabajadores Activos: ${activos}`, 16, finalY + 23);
                    doc.text(`Total Días Trabajados: ${totalDias} días`, 16, finalY + 30);
                    doc.text(`Promedio: ${Math.round(totalDias/trabajadores.length)} días`, 16, finalY + 37);
                    
                } else {
                    // Filtrar datos por fecha si se especificó
                    let datos = DATA[reportType] || [];
                    if (fechaInicio && fechaFin) {
                        datos = datos.filter(d => d.fecha && d.fecha >= fechaInicio && d.fecha <= fechaFin);
                    }
                    
                    if (reportType === 'insumos') {
                        const tableData = datos.map(i => [
                            `#${i.id}`,
                            i.nombre,
                            i.categoria,
                            `${i.cantidad} ${i.unidad}`,
                            i.estado
                        ]);
                        
                        doc.autoTable({
                            head: [['ID', 'Nombre', 'Categoría', 'Cantidad', 'Estado']],
                            body: tableData,
                            startY: startY,
                            theme: 'grid',
                            headStyles: { fillColor: [24, 119, 242] }
                        });
                        
                        const finalY = doc.lastAutoTable.finalY + 10;
                        const totalCantidad = datos.reduce((sum, i) => sum + i.cantidad, 0);
                        
                        doc.setFillColor(239, 246, 255);
                        doc.rect(14, finalY, 182, 20, 'F');
                        doc.setFontSize(10);
                        doc.text(`Total Items: ${datos.length}  |  Cantidad Total: ${totalCantidad}`, 16, finalY + 13);
                        
                    } else if (reportType === 'movimiento') {
                        const tableData = datos.map(m => [
                            m.fecha,
                            m.tipo,
                            m.insumo,
                            m.cantidad.toString(),
                            m.responsable
                        ]);
                        
                        doc.autoTable({
                            head: [['Fecha', 'Tipo', 'Insumo', 'Cantidad', 'Responsable']],
                            body: tableData,
                            startY: startY,
                            theme: 'grid',
                            headStyles: { fillColor: [24, 119, 242] }
                        });
                        
                        const finalY = doc.lastAutoTable.finalY + 10;
                        const entradas = datos.filter(m => m.tipo === 'Entrada').reduce((sum, m) => sum + m.cantidad, 0);
                        const salidas = datos.filter(m => m.tipo === 'Salida').reduce((sum, m) => sum + m.cantidad, 0);
                        
                        doc.setFillColor(239, 246, 255);
                        doc.rect(14, finalY, 182, 27, 'F');
                        doc.setFontSize(10);
                        doc.text(`Total Movimientos: ${datos.length}`, 16, finalY + 8);
                        doc.text(`Entradas: ${entradas}  |  Salidas: ${salidas}  |  Balance: ${entradas - salidas}`, 16, finalY + 16);
                        
                    } else if (reportType === 'produccion') {
                        const tableData = datos.map(p => [
                            p.fecha,
                            p.zona,
                            p.mineral,
                            `${p.cantidad} Kg`,
                            p.turno
                        ]);
                        
                        doc.autoTable({
                            head: [['Fecha', 'Zona', 'Mineral', 'Cantidad', 'Turno']],
                            body: tableData,
                            startY: startY,
                            theme: 'grid',
                            headStyles: { fillColor: [24, 119, 242] }
                        });
                        
                        const finalY = doc.lastAutoTable.finalY + 10;
                        const totalProduccion = datos.reduce((sum, p) => sum + p.cantidad, 0);
                        
                        doc.setFillColor(239, 246, 255);
                        doc.rect(14, finalY, 182, 20, 'F');
                        doc.setFontSize(10);
                        doc.text(`Total Registros: ${datos.length}  |  Producción Total: ${totalProduccion} Kg  |  Promedio: ${datos.length ? Math.round(totalProduccion/datos.length) : 0} Kg`, 16, finalY + 13);
                    }
                }
                
                // Guardar con nombre descriptivo incluyendo nombre de empresa
                const nombreEmpresaArchivo = ((await getConfig('config_nombreEmpresa', '')) || 'MINERA_SAC').replace(/\s+/g, '_');
                const fileName = `${nombreEmpresaArchivo}_${reportType}_${fechaInicio || 'todos'}_${fechaFin || new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
            } else {
                // Exportar tabla normal
                if (!currentData.length) {
                    alert('No hay datos para exportar');
                    return;
                }
                
                // Definir columnas a excluir según la vista
                let excludeColumns = ['password', 'avatar', 'imagen', 'id'];
                
                // Para insumos, excluir también stock_minimo, color, tipo_control, unidades_por_caja, presentacion, stock_cajas, stock_unidades, color_hex
                if (currentView === 'insumos') {
                    excludeColumns = [...excludeColumns, 'stock_minimo', 'color', 'tipo_control', 'unidades_por_caja', 'presentacion', 'fecha_creacion', 'stock_cajas', 'stock_unidades', 'color_hex'];
                }
                
                // Para movimientos, excluir fecha_creacion (solo usar fecha)
                if (currentView === 'movimiento') {
                    excludeColumns = [...excludeColumns, 'fecha_creacion'];
                }
                
                // Definir nombres profesionales de columnas
                const columnNames = {
                    id_usuario: 'Código Usuario',
                    nombre: 'Nombre',
                    email: 'Correo',
                    rol: 'Cargo',
                    fecha_registro: 'Fecha Registro',
                    estado: 'Estado',
                    id_producto: 'Código',
                    producto: 'Producto',
                    categoria: 'Categoría',
                    unidad: 'Unidad',
                    cantidad: 'Cantidad Total',
                    stock_actual: 'Stock',
                    estado_stock: 'Estado',
                    fecha: 'Fecha',
                    tipo: 'Tipo',
                    insumo: 'Insumo',
                    responsable: 'Responsable',
                    id_registro: 'Código',
                    zona_trabajo: 'Zona',
                    turno: 'Turno',
                    horas_trabajadas: 'Jornada',
                    observaciones: 'Observaciones',
                    id_avance: 'Código',
                    zona: 'Zona',
                    tipo_labor: 'Labor',
                    avance_metros: 'Avance (m)',
                    personal: 'Personal',
                    mineral: 'Mineral',
                    explosivo: 'Explosivo',
                    taladros: 'Taladros',
                    mov_cajas: 'Cajas',
                    mov_unidades: 'Unidades',
                    fecha_creacion: 'Fecha de Registro'
                };
                
                // Filtrar columnas
                let keys = Object.keys(currentData[0]).filter(key => !excludeColumns.includes(key));
                
                // Para insumos, agregar estado_stock
                if (currentView === 'insumos') {
                    keys.push('estado_stock');
                }
                
                // Crear headers con nombres profesionales
                const headers = keys.map(key => columnNames[key] || key);
                
                // Crear datos filtrados
                const tableData = currentData.map(row => 
                    keys.map(key => {
                        // Para insumos, calcular estado_stock
                        if (currentView === 'insumos' && key === 'estado_stock') {
                            const stockActual = row.stock_actual || 0;
                            const stockMinimo = row.stock_minimo || 0;
                            const umbralCerca = stockMinimo * 1.2;
                            
                            if (stockActual < stockMinimo) {
                                return 'BAJO';
                            } else if (stockActual < umbralCerca) {
                                return 'MEDIO';
                            }
                            return 'OK';
                        }
                        
                        // Para insumos, formatear stock_actual concatenado
                        if (currentView === 'insumos' && key === 'stock_actual') {
                            if (row.tipo_control === 'Contable' && row.unidades_por_caja > 1) {
                                const cajas = row.stock_cajas || 0;
                                const unidades = row.stock_unidades || 0;
                                return `${cajas} cajas, ${unidades} unidades`;
                            } else if (row.tipo_control === 'Contable') {
                                const unidades = row.stock_unidades || 0;
                                return `${unidades} ${row.unidad.toLowerCase()}`;
                            }
                        }
                        
                        // Para movimientos: mostrar solo si el producto tiene cajas, sino dejar vacío
                        if (currentView === 'movimiento' && (key === 'mov_cajas' || key === 'mov_unidades')) {
                            // Buscar el producto para verificar si tiene cajas
                            const producto = DATA.insumos.find(p => p.producto === row.insumo);
                            if (producto && producto.tipo_control === 'Contable' && producto.unidades_por_caja > 1) {
                                // Solo mostrar valor si el producto es contable con cajas
                                return String(row[key] || 0);
                            }
                            // Si no es contable con cajas, dejar vacío
                            return '';
                        }
                        
                        // Para fecha_creacion: quitar hora, solo fecha
                        if (key === 'fecha_creacion' && row[key]) {
                            const soloFecha = row[key].split('T')[0];
                            return soloFecha;
                        }
                        
                        // Para registro_trabajo: formatear jornada (horas_trabajadas)
                        if (currentView === 'registro_trabajo' && key === 'horas_trabajadas') {
                            if (row[key] == 1) return 'T (1 día)';
                            if (row[key] == 1.5) return 'TM (1.5 días)';
                            if (row[key] == 0.5) return 'M (0.5 días)';
                            return String(row[key]);
                        }
                        
                        return String(row[key] || '');
                    })
                );
                
                // Título del PDF
                const viewTitles = {
                    usuarios: 'Usuarios del Sistema',
                    insumos: 'Inventario de Insumos',
                    movimiento: 'Movimientos de Inventario',
                    registro_trabajo: 'Registro de Trabajo',
                    avance: 'Control de Avance',
                    produccion: 'Control de Producción',
                    voladura: 'Gestión de Voladura'
                };
                
                // Obtener nombre de empresa desde configuración
                const nombreEmpresa = (await getConfig('config_nombreEmpresa', '')) || 'MINERA SAC';
                
                doc.setFontSize(18);
                doc.setTextColor(13, 71, 161);
                doc.text(nombreEmpresa, 14, 15);
                
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                doc.text(viewTitles[currentView] || `Reporte de ${currentView}`, 14, 25);
                
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text(`Generado: ${new Date().toLocaleString('es-PE')}`, 14, 32);
                
                doc.autoTable({
                    head: [headers],
                    body: tableData,
                    startY: 38,
                    theme: 'grid',
                    headStyles: { 
                        fillColor: [13, 71, 161],
                        textColor: 255,
                        fontStyle: 'bold'
                    },
                    styles: {
                        fontSize: 8,
                        cellPadding: 2
                    },
                    margin: { top: 10 }
                });
                
                // Pie de página con total de registros
                const finalY = doc.lastAutoTable.finalY + 10;
                if (finalY < 280) {
                    doc.setFillColor(239, 246, 255);
                    doc.rect(14, finalY, 182, 15, 'F');
                    doc.setFontSize(10);
                    doc.setTextColor(0);
                    doc.text(`Total de Registros: ${currentData.length}`, 16, finalY + 10);
                }
                
                // Guardar con nombre de empresa
                const nombreEmpresaArchivo = ((await getConfig('config_nombreEmpresa', '')) || 'MINERA_SAC').replace(/\s+/g, '_');
                doc.save(`${nombreEmpresaArchivo}_${currentView}_${new Date().toISOString().split('T')[0]}.pdf`);
            }
        }
        
        // ===== REPORTE DE ASISTENCIA SEMANAL - DISEÑO PROFESIONAL =====
        function exportarAsistenciaSemanal() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            const registros = DATA.registro_trabajo;
            
            if (registros.length === 0) {
                alert('No hay registros de trabajo para exportar');
                return;
            }
            
            const nombreEmpresa = (await getConfig('config_nombreEmpresa', '')) || 'MINERA APU 1';
            
            // Agrupar por mes
            const registrosPorMes = {};
            registros.forEach(r => {
                const fecha = new Date(r.fecha + 'T00:00:00');
                const mesKey = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
                
                if (!registrosPorMes[mesKey]) registrosPorMes[mesKey] = {};
                if (!registrosPorMes[mesKey][r.nombre]) registrosPorMes[mesKey][r.nombre] = [];
                
                registrosPorMes[mesKey][r.nombre].push({
                    fecha: fecha,
                    jornada: parseFloat(r.horas_trabajadas) || 0
                });
            });
            
            const meses = Object.keys(registrosPorMes).sort();
            
            let y = 10;
            const anchoPagina = 190;  // A4 vertical tiene 210mm, usar 190mm útiles
            const nomW = 50;
            const diasW = 28;
            const totalCols = 7;
            const colW = (anchoPagina - nomW - diasW) / totalCols;  // ~16mm por columna
            
            // TÍTULO MORADO UNA SOLA VEZ AL INICIO
            doc.setFillColor(128, 0, 128);
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.5);
            doc.rect(10, y, anchoPagina, 8, 'FD');
            doc.setFontSize(13);
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'bold');
            doc.text(`${nombreEmpresa} REGISTRO DE TRABAJADOR`, 10 + anchoPagina/2, y + 5.5, { align: 'center' });
            y += 10;
            
            meses.forEach((mesKey, mesIndex) => {
                const [año, mes] = mesKey.split('-');
                const nombreMes = new Date(año, parseInt(mes) - 1).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' }).toUpperCase();
                const trabajadores = Object.keys(registrosPorMes[mesKey]).sort();
                const registrosMes = registrosPorMes[mesKey];
                
                // Crear semanas del mes completo basado en el calendario
                const semanas = [];
                const primerDiaMes = new Date(año, parseInt(mes) - 1, 1);
                const ultimoDiaMes = new Date(año, parseInt(mes), 0);
                
                // Encontrar el lunes de la primera semana
                let inicio = new Date(primerDiaMes);
                const diaInicio = inicio.getDay();
                inicio.setDate(inicio.getDate() - (diaInicio === 0 ? 6 : diaInicio - 1));
                
                // Generar TODAS las semanas que tocan el mes
                while (inicio <= ultimoDiaMes) {
                    const fin = new Date(inicio);
                    fin.setDate(fin.getDate() + 6);
                    
                    // Verificar si esta semana tiene al menos un día del mes actual
                    const tieneDiasDelMes = inicio <= ultimoDiaMes && fin >= primerDiaMes;
                    
                    if (tieneDiasDelMes) {
                        // Verificar si esta semana tiene datos
                        let hayDatos = false;
                        Object.values(registrosMes).forEach(regs => {
                            regs.forEach(r => {
                                if (r.fecha >= inicio && r.fecha <= fin) hayDatos = true;
                            });
                        });
                        
                        // Solo agregar la semana si tiene datos
                        if (hayDatos) {
                            const dias = [];
                            for (let i = 0; i < 7; i++) {
                                const d = new Date(inicio);
                                d.setDate(d.getDate() + i);
                                dias.push(d);
                            }
                            semanas.push(dias);
                        }
                    }
                    
                    inicio.setDate(inicio.getDate() + 7);
                }
                
                // CADA SEMANA EN LA MISMA PÁGINA - SIN SALTOS
                semanas.forEach((dias) => {
                    // Verificar si hay espacio para la semana (A4 vertical = 297mm alto)
                    const alturaEstimada = 14 + (trabajadores.length * 6);
                    if (y + alturaEstimada > 270) {  // Ajustado para vertical
                        doc.addPage();
                        y = 10;
                    }
                    
                    const startX = 10 + nomW;
                    
                    // FILA 1: Mes + números + Días
                    doc.setFillColor(70, 130, 180);  // Azul para cabecera
                    doc.rect(10, y, nomW, 7, 'FD');
                    doc.setFontSize(10);
                    doc.setTextColor(255, 255, 255);
                    doc.text(`[${mes}] ${nombreMes.split(' ')[0]}`, 10 + nomW/2, y + 4.5, { align: 'center' });
                    
                    let x = startX;
                    dias.forEach(d => {
                        doc.setFillColor(70, 130, 180);  // Azul para días
                        doc.setTextColor(255, 255, 255);  // Texto blanco
                        doc.rect(x, y, colW, 7, 'FD');
                        doc.text(String(d.getDate()), x + colW/2, y + 4.5, { align: 'center' });
                        x += colW;
                    });
                    
                    doc.setFillColor(70, 130, 180);  // Azul para cabecera
                    doc.rect(x, y, diasW, 7, 'FD');
                    doc.setTextColor(255, 255, 255);
                    doc.text('Días', x + diasW/2, y + 4.5, { align: 'center' });
                    y += 7;
                    
                    // FILA 2: Nombre + días + Trabajados
                    doc.setFillColor(70, 130, 180);  // Azul para cabecera
                    doc.rect(10, y, nomW, 7, 'FD');
                    doc.setTextColor(255, 255, 255);
                    doc.text('Nombre', 10 + nomW/2, y + 4.5, { align: 'center' });
                    
                    x = startX;
                    const dNombres = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
                    dias.forEach(d => {
                        doc.setFillColor(70, 130, 180);  // Azul para días
                        doc.setTextColor(255, 255, 255);  // Texto blanco
                        doc.rect(x, y, colW, 7, 'FD');
                        // Usar getDay() que devuelve 0=Domingo, 1=Lunes, etc.
                        const nom = dNombres[d.getDay()];
                        doc.text(nom, x + colW/2, y + 4.5, { align: 'center' });
                        x += colW;
                    });
                    
                    doc.setFillColor(70, 130, 180);  // Azul para cabecera
                    doc.rect(x, y, diasW, 7, 'FD');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(9);
                    doc.text('Trabajados', x + diasW/2, y + 4.5, { align: 'center' });
                    doc.setFontSize(10);
                    y += 7;
                    
                    // TRABAJADORES
                    doc.setFont('helvetica', 'normal');
                    trabajadores.forEach(trab => {
                        doc.setFillColor(149, 199, 153);  // Verde #95c799 para fila de trabajador
                        doc.setTextColor(0, 0, 0);  // Texto negro
                        doc.rect(10, y, nomW, 6, 'FD');
                        doc.text(trab.toUpperCase(), 10 + nomW/2, y + 4, { align: 'center' });
                        
                        let totalSemana = 0;
                        x = startX;
                        dias.forEach(d => {
                            doc.setFillColor(255, 255, 255);  // Blanco para celdas de datos
                            doc.setTextColor(0, 0, 0);  // Texto negro
                            doc.rect(x, y, colW, 6, 'FD');
                            
                            const reg = registrosMes[trab].find(r => 
                                r.fecha.getDate() === d.getDate() &&
                                r.fecha.getMonth() === d.getMonth() &&
                                r.fecha.getFullYear() === d.getFullYear()
                            );
                            
                            if (reg) {
                                const j = reg.jornada;
                                let txt = '';
                                if (j === 1) txt = 'T';
                                else if (j === 1.5) txt = 'TM';
                                else if (j === 0.5) txt = 'M';
                                else txt = String(j);
                                
                                doc.setFont('helvetica', 'bold');
                                doc.setTextColor(0, 0, 0);
                                doc.text(txt, x + colW/2, y + 4, { align: 'center' });
                                doc.setFont('helvetica', 'normal');
                                totalSemana += j;
                            }
                            x += colW;
                        });
                        
                        doc.setFillColor(149, 199, 153);  // Verde #95c799 para total
                        doc.rect(x, y, diasW, 6, 'FD');
                        doc.setTextColor(0, 0, 0);  // Texto negro
                        doc.text(String(totalSemana), x + diasW/2, y + 4, { align: 'center' });
                        y += 6;
                    });
                    
                    y += 7;  // Espacio entre semanas
                });
            });
            
            // RESUMEN FINAL - UNA SOLA VEZ AL FINAL DE TODO
            // Verificar si hay espacio para el resumen (necesita ~60mm)
            if (y > 220) {  // Ajustado para vertical (297mm - 60mm = 237mm)
                doc.addPage();
                y = 10;
            }
            
            y += 7;  // Espacio antes del resumen
            
            const resW = 140;
            
            doc.setFillColor(255, 0, 0);
            doc.rect(10, y, resW, 8, 'FD');
            y += 8;
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            
            doc.setFillColor(70, 130, 180);  // Azul para cabecera
            doc.rect(10, y, resW/2, 7, 'FD');
            doc.setTextColor(255, 255, 255);
            doc.text('Nombre', 10 + resW/4, y + 4.5, { align: 'center' });
            
            doc.setFillColor(70, 130, 180);  // Azul para cabecera
            doc.rect(10 + resW/2, y, resW/2, 7, 'FD');
            doc.setTextColor(255, 255, 255);
            doc.text('Total de días trabajados', 10 + 3*resW/4, y + 4.5, { align: 'center' });
            y += 7;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            
            // OBTENER TODOS LOS TRABAJADORES DE TODOS LOS MESES
            const todosTrabajadores = new Set();
            meses.forEach(mesKey => {
                Object.keys(registrosPorMes[mesKey]).forEach(trab => todosTrabajadores.add(trab));
            });
            
            Array.from(todosTrabajadores).sort().forEach(trab => {
                let totalGeneral = 0;
                meses.forEach(mesKey => {
                    if (registrosPorMes[mesKey][trab]) {
                        totalGeneral += registrosPorMes[mesKey][trab].reduce((sum, r) => sum + r.jornada, 0);
                    }
                });
                
                doc.setFillColor(255, 255, 255);
                doc.setTextColor(0, 0, 0);
                doc.rect(10, y, resW/2, 6, 'FD');
                doc.text(trab.toUpperCase(), 10 + resW/4, y + 4, { align: 'center' });
                
                doc.setFillColor(255, 255, 255);
                doc.rect(10 + resW/2, y, resW/2, 6, 'FD');
                doc.text(String(totalGeneral), 10 + 3*resW/4, y + 4, { align: 'center' });
                y += 6;
            });
            
            doc.save(`${nombreEmpresa.replace(/\s+/g, '_')}_Asistencia_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function exportarAvanceSemanal() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            const registros = DATA.avance;
            
            if (registros.length === 0) {
                alert('No hay registros de avance para exportar');
                return;
            }
            
            const nombreEmpresa = (await getConfig('config_nombreEmpresa', '')) || 'MINERA APU 1';
            
            // Agrupar por semana
            const registrosPorSemana = {};
            registros.forEach(r => {
                const fecha = new Date(r.fecha + 'T00:00:00');
                const diaInicio = fecha.getDay();
                const lunes = new Date(fecha);
                lunes.setDate(lunes.getDate() - (diaInicio === 0 ? 6 : diaInicio - 1));
                const semanaKey = lunes.toISOString().split('T')[0];
                
                if (!registrosPorSemana[semanaKey]) {
                    registrosPorSemana[semanaKey] = [];
                }
                registrosPorSemana[semanaKey].push(r);
            });
            
            const semanas = Object.keys(registrosPorSemana).sort();
            let y = 10;
            let paginaActual = 1;
            
            semanas.forEach((semanaKey, semanaIndex) => {
                const registrosSemana = registrosPorSemana[semanaKey];
                const fechaInicio = new Date(semanaKey);
                const fechaFin = new Date(fechaInicio);
                fechaFin.setDate(fechaFin.getDate() + 6);
                
                const mesNombre = fechaInicio.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' }).toUpperCase();
                
                // Calcular altura necesaria para esta semana
                const numRegistros = registrosSemana.length;
                const alturaResumen = 60; // Título + periodo + resumen ejecutivo
                const alturaDetalle = 14 + (numRegistros * 7) + 10; // Cabecera + filas + espacio
                const alturaResumenTipo = 50; // Resumen por tipo con totales
                const alturaTotal = alturaResumen + alturaDetalle + alturaResumenTipo;
                
                // Si no cabe en la página actual, crear nueva página
                if (semanaIndex > 0 && (y + alturaTotal > 280)) {
                    doc.addPage();
                    y = 10;
                    paginaActual++;
                }
                
                // TÍTULO (solo si es inicio de página)
                if (y === 10) {
                    doc.setFillColor(41, 128, 185);
                    doc.rect(10, y, 190, 12, 'FD');
                    doc.setFontSize(14);
                    doc.setTextColor(255, 255, 255);
                    doc.setFont('helvetica', 'bold');
                    doc.text(nombreEmpresa, 105, y + 5, { align: 'center' });
                    doc.setFontSize(11);
                    doc.text('REPORTE SEMANAL DE AVANCES MINEROS', 105, y + 10, { align: 'center' });
                    y += 15;
                }
                
                // PERIODO
                doc.setFillColor(52, 73, 94);
                doc.rect(10, y, 190, 8, 'FD');
                doc.setFontSize(10);
                doc.setTextColor(255, 255, 255);
                const periodoTexto = `PERIODO: ${fechaInicio.getDate()}/${fechaInicio.getMonth()+1} AL ${fechaFin.getDate()}/${fechaFin.getMonth()+1}/${fechaFin.getFullYear()} | ${mesNombre}`;
                doc.text(periodoTexto, 105, y + 5.5, { align: 'center' });
                y += 12;
                
                // RESUMEN EJECUTIVO
                const totalAvance = registrosSemana.reduce((sum, r) => sum + (parseFloat(r.avance_metros) || 0), 0);
                const laboresActivas = [...new Set(registrosSemana.map(r => r.zona))].length;
                
                // Calcular promedios por jornada
                const jornadaT = registrosSemana.filter(r => r.jornada == 1);
                const jornadaTM = registrosSemana.filter(r => r.jornada == 1.5);
                const jornadaM = registrosSemana.filter(r => r.jornada == 0.5);
                
                const promedioT = jornadaT.length > 0 ? 
                    (jornadaT.reduce((sum, r) => sum + (parseFloat(r.avance_metros) || 0), 0) / jornadaT.length).toFixed(2) : 0;
                const promedioTM = jornadaTM.length > 0 ? 
                    (jornadaTM.reduce((sum, r) => sum + (parseFloat(r.avance_metros) || 0), 0) / jornadaTM.length).toFixed(2) : 0;
                const promedioM = jornadaM.length > 0 ? 
                    (jornadaM.reduce((sum, r) => sum + (parseFloat(r.avance_metros) || 0), 0) / jornadaM.length).toFixed(2) : 0;
                
                doc.setFillColor(46, 204, 113);
                doc.rect(10, y, 190, 7, 'FD');
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('RESUMEN SEMANAL', 105, y + 4.5, { align: 'center' });
                y += 7;
                
                const boxW = 47;
                // Cajas de resumen
                doc.setFillColor(52, 152, 219);
                doc.rect(10, y, boxW, 18, 'FD');
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(255, 255, 255);
                doc.text('Total Avanzado', 10 + boxW/2, y + 4, { align: 'center' });
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text(`${totalAvance.toFixed(1)} m`, 10 + boxW/2, y + 12, { align: 'center' });
                
                doc.setFillColor(155, 89, 182);
                doc.rect(10 + boxW, y, boxW, 18, 'FD');
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.text('Labores Activas', 10 + boxW + boxW/2, y + 4, { align: 'center' });
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text(`${laboresActivas}`, 10 + boxW + boxW/2, y + 12, { align: 'center' });
                
                doc.setFillColor(230, 126, 34);
                doc.rect(10 + boxW*2, y, boxW, 18, 'FD');
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.text('Prom. T (8h)', 10 + boxW*2 + boxW/2, y + 4, { align: 'center' });
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text(`${promedioT} m`, 10 + boxW*2 + boxW/2, y + 12, { align: 'center' });
                
                doc.setFillColor(26, 188, 156);
                doc.rect(10 + boxW*3, y, boxW, 18, 'FD');
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.text('Prom. TM (12h)', 10 + boxW*3 + boxW/2, y + 4, { align: 'center' });
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text(`${promedioTM} m`, 10 + boxW*3 + boxW/2, y + 12, { align: 'center' });
                y += 22;
                
                // Info adicional de jornadas
                if (promedioM > 0 || jornadaT.length > 0 || jornadaTM.length > 0) {
                    doc.setFillColor(236, 240, 241);
                    doc.rect(10, y, 190, 8, 'FD');
                    doc.setFontSize(8);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont('helvetica', 'normal');
                    let infoTexto = `Registros: T=${jornadaT.length} | TM=${jornadaTM.length}`;
                    if (promedioM > 0) infoTexto += ` | M=${jornadaM.length} (Prom: ${promedioM}m)`;
                    doc.text(infoTexto, 105, y + 5, { align: 'center' });
                    y += 10;
                }
                
                // DETALLE POR LABOR
                doc.setFillColor(52, 152, 219);
                doc.rect(10, y, 190, 7, 'FD');
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('DETALLE DE AVANCES', 105, y + 4.5, { align: 'center' });
                y += 7;
                
                // Cabecera tabla
                doc.setFillColor(44, 62, 80);
                doc.rect(10, y, 25, 7, 'FD');
                doc.rect(35, y, 60, 7, 'FD');
                doc.rect(95, y, 45, 7, 'FD');
                doc.rect(140, y, 35, 7, 'FD');
                doc.rect(175, y, 25, 7, 'FD');
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('FECHA', 22.5, y + 4.5, { align: 'center' });
                doc.text('LABOR / ZONA', 65, y + 4.5, { align: 'center' });
                doc.text('TIPO', 117.5, y + 4.5, { align: 'center' });
                doc.text('AVANCE (m)', 157.5, y + 4.5, { align: 'center' });
                doc.text('JORN.', 187.5, y + 4.5, { align: 'center' });
                y += 7;
                
                // Filas de datos
                doc.setFont('helvetica', 'normal');
                let isAlternate = false;
                registrosSemana.forEach(r => {
                    doc.setFillColor(isAlternate ? 255 : 245, isAlternate ? 255 : 250, isAlternate ? 255 : 250);
                    doc.rect(10, y, 25, 7, 'FD');
                    doc.rect(35, y, 60, 7, 'FD');
                    doc.rect(95, y, 45, 7, 'FD');
                    doc.rect(140, y, 35, 7, 'FD');
                    doc.rect(175, y, 25, 7, 'FD');
                    
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(8);
                    const fecha = new Date(r.fecha + 'T00:00:00');
                    const fechaCorta = `${fecha.getDate()}/${fecha.getMonth()+1}`;
                    doc.text(fechaCorta, 22.5, y + 4.5, { align: 'center' });
                    
                    const laborTexto = r.zona.length > 25 ? r.zona.substring(0, 25) + '...' : r.zona;
                    doc.text(laborTexto, 37, y + 4.5);
                    
                    const tipoTexto = r.tipo_labor.length > 18 ? r.tipo_labor.substring(0, 18) + '...' : r.tipo_labor;
                    doc.text(tipoTexto, 117.5, y + 4.5, { align: 'center' });
                    
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(46, 204, 113);
                    doc.text(`${r.avance_metros}`, 157.5, y + 4.5, { align: 'center' });
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(0, 0, 0);
                    
                    let jornadaTexto = '';
                    if (r.jornada == 1) jornadaTexto = 'T';
                    else if (r.jornada == 1.5) jornadaTexto = 'TM';
                    else if (r.jornada == 0.5) jornadaTexto = 'M';
                    else jornadaTexto = String(r.jornada || '-');
                    
                    doc.setFont('helvetica', 'bold');
                    doc.text(jornadaTexto, 187.5, y + 4.5, { align: 'center' });
                    doc.setFont('helvetica', 'normal');
                    
                    y += 7;
                    isAlternate = !isAlternate;
                });
                
                y += 5;
                
                // RESUMEN POR TIPO DE LABOR
                doc.setFillColor(230, 126, 34);
                doc.rect(10, y, 190, 7, 'FD');
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('RESUMEN POR TIPO DE LABOR', 105, y + 4.5, { align: 'center' });
                y += 7;
                
                const resumenTipos = {};
                registrosSemana.forEach(r => {
                    if (!resumenTipos[r.tipo_labor]) {
                        resumenTipos[r.tipo_labor] = { avance: 0, cantidad: 0 };
                    }
                    resumenTipos[r.tipo_labor].avance += parseFloat(r.avance_metros) || 0;
                    resumenTipos[r.tipo_labor].cantidad += 1;
                });
                
                const tiposOrdenados = Object.keys(resumenTipos).sort((a, b) => 
                    resumenTipos[b].avance - resumenTipos[a].avance
                );
                
                // Cabecera resumen
                doc.setFillColor(44, 62, 80);
                doc.rect(10, y, 70, 7, 'FD');
                doc.rect(80, y, 50, 7, 'FD');
                doc.rect(130, y, 35, 7, 'FD');
                doc.rect(165, y, 35, 7, 'FD');
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('TIPO DE LABOR', 45, y + 4.5, { align: 'center' });
                doc.text('GRÁFICO', 105, y + 4.5, { align: 'center' });
                doc.text('AVANCE (m)', 147.5, y + 4.5, { align: 'center' });
                doc.text('N° REG.', 182.5, y + 4.5, { align: 'center' });
                y += 7;
                
                doc.setTextColor(0, 0, 0);
                const maxAvance = Math.max(...Object.values(resumenTipos).map(t => t.avance));
                
                tiposOrdenados.forEach((tipo, index) => {
                    const isAlternate = index % 2 === 0;
                    doc.setFillColor(isAlternate ? 255 : 245, isAlternate ? 255 : 250, isAlternate ? 255 : 250);
                    doc.setFont('helvetica', 'normal');
                    doc.rect(10, y, 70, 8, 'FD');
                    doc.rect(80, y, 50, 8, 'FD');
                    doc.rect(130, y, 35, 8, 'FD');
                    doc.rect(165, y, 35, 8, 'FD');
                    
                    doc.setFontSize(8);
                    doc.text(tipo.length > 24 ? tipo.substring(0, 24) + '...' : tipo, 12, y + 5.5);
                    
                    const barWidth = (resumenTipos[tipo].avance / maxAvance) * 45;
                    doc.setFillColor(52, 152, 219);
                    doc.rect(82, y + 2, barWidth, 4, 'F');
                    
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(9);
                    doc.text(`${resumenTipos[tipo].avance.toFixed(1)}`, 147.5, y + 5.5, { align: 'center' });
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    doc.text(`${resumenTipos[tipo].cantidad}`, 182.5, y + 5.5, { align: 'center' });
                    y += 8;
                });
                
                // TOTALES
                doc.setFillColor(46, 204, 113);
                doc.rect(10, y, 120, 7, 'FD');
                doc.rect(130, y, 35, 7, 'FD');
                doc.rect(165, y, 35, 7, 'FD');
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(9);
                doc.setTextColor(255, 255, 255);
                doc.text('TOTAL GENERAL', 70, y + 4.5, { align: 'center' });
                doc.text(`${totalAvance.toFixed(1)}`, 147.5, y + 4.5, { align: 'center' });
                doc.text(`${registrosSemana.length}`, 182.5, y + 4.5, { align: 'center' });
                y += 10;
                
                // PIE DE PÁGINA
                doc.setFontSize(7);
                doc.setTextColor(100, 100, 100);
                doc.text(`Página ${paginaActual} | Generado: ${new Date().toLocaleString('es-ES')}`, 105, 290, { align: 'center' });
            });
            
            doc.save(`${nombreEmpresa.replace(/\s+/g, '_')}_Avance_Semanal_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function exportarProduccionSemanal() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            const registros = DATA.produccion;
            
            if (registros.length === 0) {
                alert('No hay registros de producción para exportar');
                return;
            }
            
            const nombreEmpresa = (await getConfig('config_nombreEmpresa', '')) || 'MINERA APU 1';
            
            // Agrupar por semana
            const registrosPorSemana = {};
            registros.forEach(r => {
                const fecha = new Date(r.fecha + 'T00:00:00');
                const diaInicio = fecha.getDay();
                const lunes = new Date(fecha);
                lunes.setDate(lunes.getDate() - (diaInicio === 0 ? 6 : diaInicio - 1));
                const semanaKey = lunes.toISOString().split('T')[0];
                
                if (!registrosPorSemana[semanaKey]) {
                    registrosPorSemana[semanaKey] = [];
                }
                registrosPorSemana[semanaKey].push(r);
            });
            
            const semanas = Object.keys(registrosPorSemana).sort();
            let paginaActual = 1;
            
            semanas.forEach((semanaKey, semanaIndex) => {
                if (semanaIndex > 0) doc.addPage();
                
                const registrosSemana = registrosPorSemana[semanaKey];
                const fechaInicio = new Date(semanaKey);
                const fechaFin = new Date(fechaInicio);
                fechaFin.setDate(fechaFin.getDate() + 6);
                
                let y = 10;
                
                // TÍTULO
                doc.setFillColor(230, 126, 34);
                doc.rect(10, y, 190, 12, 'FD');
                doc.setFontSize(14);
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.text(nombreEmpresa, 105, y + 5, { align: 'center' });
                doc.setFontSize(11);
                doc.text('REPORTE SEMANAL DE PRODUCCION MINERA', 105, y + 10, { align: 'center' });
                y += 15;
                
                // PERIODO
                doc.setFillColor(52, 73, 94);
                doc.rect(10, y, 190, 8, 'FD');
                doc.setFontSize(10);
                doc.setTextColor(255, 255, 255);
                const periodoTexto = `PERIODO: ${fechaInicio.getDate()}/${fechaInicio.getMonth()+1} AL ${fechaFin.getDate()}/${fechaFin.getMonth()+1}/${fechaFin.getFullYear()}`;
                doc.text(periodoTexto, 105, y + 5.5, { align: 'center' });
                y += 12;
                
                // CALCULAR TOTALES
                const porMineral = {};
                const porZona = {};
                let totalRegistros = 0;
                
                // NO convertir - usar directamente la unidad registrada
                
                registrosSemana.forEach(r => {
                    totalRegistros++;
                    
                    // Por mineral - guardar cantidad directa SIN convertir
                    if (!porMineral[r.mineral]) {
                        porMineral[r.mineral] = { 
                            cantidad: 0, 
                            unidades: {} 
                        };
                    }
                    porMineral[r.mineral].cantidad += parseFloat(r.cantidad) || 0;
                    
                    const unidad = r.unidad || 'Unidades';
                    if (!porMineral[r.mineral].unidades[unidad]) {
                        porMineral[r.mineral].unidades[unidad] = 0;
                    }
                    porMineral[r.mineral].unidades[unidad] += parseFloat(r.cantidad) || 0;
                    
                    // Por zona - cantidad directa SIN convertir
                    if (!porZona[r.zona]) {
                        porZona[r.zona] = { 
                            cantidad: 0, 
                            minerales: {} 
                        };
                    }
                    porZona[r.zona].cantidad += parseFloat(r.cantidad) || 0;
                    
                    if (!porZona[r.zona].minerales[r.mineral]) {
                        porZona[r.zona].minerales[r.mineral] = 0;
                    }
                    porZona[r.zona].minerales[r.mineral] += parseFloat(r.cantidad) || 0;
                });
                
                const zonasActivas = Object.keys(porZona).length;
                const tiposMinerales = Object.keys(porMineral).length;
                const totalGeneral = Object.values(porMineral).reduce((sum, m) => sum + m.cantidad, 0);
                
                // Determinar unidad más común para el total
                const todasUnidades = {};
                registrosSemana.forEach(r => {
                    const unidad = r.unidad || 'Unidades';
                    if (!todasUnidades[unidad]) todasUnidades[unidad] = 0;
                    todasUnidades[unidad] += parseFloat(r.cantidad) || 0;
                });
                const cantidadUnidades = Object.keys(todasUnidades).length;
                const hayUnidadesMixtas = cantidadUnidades > 1;
                const unidadPrincipal = Object.keys(todasUnidades).sort((a, b) => todasUnidades[b] - todasUnidades[a])[0] || 'Unidades';
                
                // RESUMEN EJECUTIVO
                doc.setFillColor(241, 196, 15);
                doc.rect(10, y, 190, 7, 'FD');
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('RESUMEN EJECUTIVO', 105, y + 4.5, { align: 'center' });
                y += 7;
                
                const boxW = 47.5;
                
                // TOTAL EN UNIDAD PRINCIPAL - DESTACADO
                doc.setFillColor(231, 76, 60);
                doc.rect(10, y, boxW, 22, 'FD');
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(255, 255, 255);
                doc.text('TOTAL PRODUCCION', 10 + boxW/2, y + 5, { align: 'center' });
                doc.setFontSize(hayUnidadesMixtas ? 14 : 18);
                doc.setFont('helvetica', 'bold');
                if (hayUnidadesMixtas) {
                    doc.text(`${totalGeneral.toFixed(0)}`, 10 + boxW/2, y + 12, { align: 'center' });
                    doc.setFontSize(8);
                    doc.text(`(${cantidadUnidades} unidades)`, 10 + boxW/2, y + 18, { align: 'center' });
                } else {
                    doc.text(`${totalGeneral.toFixed(0)} ${unidadPrincipal}`, 10 + boxW/2, y + 15, { align: 'center' });
                }
                
                // Zonas
                doc.setFillColor(155, 89, 182);
                doc.rect(10 + boxW, y, boxW, 22, 'FD');
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text('Zonas Productivas', 10 + boxW + boxW/2, y + 5, { align: 'center' });
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text(`${zonasActivas}`, 10 + boxW + boxW/2, y + 15, { align: 'center' });
                
                // Minerales
                doc.setFillColor(230, 126, 34);
                doc.rect(10 + boxW*2, y, boxW, 22, 'FD');
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text('Tipos de Mineral', 10 + boxW*2 + boxW/2, y + 5, { align: 'center' });
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text(`${tiposMinerales}`, 10 + boxW*2 + boxW/2, y + 15, { align: 'center' });
                
                // Registros
                doc.setFillColor(52, 152, 219);
                doc.rect(10 + boxW*3, y, boxW, 22, 'FD');
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text('Total Registros', 10 + boxW*3 + boxW/2, y + 5, { align: 'center' });
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text(`${totalRegistros}`, 10 + boxW*3 + boxW/2, y + 15, { align: 'center' });
                y += 25;
                
                // PRODUCCION POR ZONA
                doc.setFillColor(52, 152, 219);
                doc.rect(10, y, 190, 7, 'FD');
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('PRODUCCION POR ZONA', 105, y + 4.5, { align: 'center' });
                y += 7;
                
                // Cabecera
                doc.setFillColor(44, 62, 80);
                doc.rect(10, y, 70, 7, 'FD');
                doc.rect(80, y, 50, 7, 'FD');
                doc.rect(130, y, 35, 7, 'FD');
                doc.rect(165, y, 35, 7, 'FD');
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('ZONA / LABOR', 45, y + 4.5, { align: 'center' });
                doc.text('MINERALES', 105, y + 4.5, { align: 'center' });
                doc.text('CANTIDAD', 147.5, y + 4.5, { align: 'center' });
                doc.text('UNIDAD', 182.5, y + 4.5, { align: 'center' });
                y += 7;
                
                // Filas
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(0, 0, 0);
                let isAlternate = false;
                
                Object.keys(porZona).sort().forEach(zona => {
                    // Calcular si cabe (8mm por fila)
                    if (y + 8 > 260) {
                        doc.addPage();
                        y = 10;
                        // Repetir cabecera
                        doc.setFillColor(44, 62, 80);
                        doc.rect(10, y, 70, 7, 'FD');
                        doc.rect(80, y, 50, 7, 'FD');
                        doc.rect(130, y, 35, 7, 'FD');
                        doc.rect(165, y, 35, 7, 'FD');
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(255, 255, 255);
                        doc.text('ZONA / LABOR', 45, y + 4.5, { align: 'center' });
                        doc.text('MINERALES', 105, y + 4.5, { align: 'center' });
                        doc.text('CANTIDAD', 147.5, y + 4.5, { align: 'center' });
                        doc.text('TM', 182.5, y + 4.5, { align: 'center' });
                        y += 7;
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(0, 0, 0);
                    }
                    
                    doc.setFillColor(isAlternate ? 255 : 245, isAlternate ? 255 : 250, isAlternate ? 255 : 250);
                    doc.rect(10, y, 70, 8, 'FD');
                    doc.rect(80, y, 50, 8, 'FD');
                    doc.rect(130, y, 35, 8, 'FD');
                    doc.rect(165, y, 35, 8, 'FD');
                    
                    doc.setFontSize(8);
                    const zonaTexto = zona.length > 25 ? zona.substring(0, 25) + '...' : zona;
                    doc.text(zonaTexto, 12, y + 5.5);
                    
                    const mineralesTexto = Object.keys(porZona[zona].minerales).join(', ');
                    const mineralesCorto = mineralesTexto.length > 18 ? mineralesTexto.substring(0, 18) + '...' : mineralesTexto;
                    doc.text(mineralesCorto, 82, y + 5.5);
                    
                    // CANTIDAD
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(11);
                    doc.setTextColor(231, 76, 60);
                    doc.text(`${porZona[zona].cantidad.toFixed(0)}`, 147.5, y + 5.5, { align: 'center' });
                    
                    // UNIDAD - mostrar la unidad principal de esta zona
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(9);
                    doc.setTextColor(52, 152, 219);
                    doc.text(unidadPrincipal, 182.5, y + 5.5, { align: 'center' });
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(0, 0, 0);
                    
                    y += 8;
                    isAlternate = !isAlternate;
                });
                
                y += 5;
                
                // Verificar espacio para sección de minerales (mínimo 50mm)
                if (y + 50 > 270) {
                    doc.addPage();
                    y = 10;
                }
                
                // PRODUCCION POR MINERAL
                doc.setFillColor(46, 204, 113);
                doc.rect(10, y, 190, 7, 'FD');
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('TOTAL POR TIPO DE MINERAL', 105, y + 4.5, { align: 'center' });
                y += 7;
                
                // Cabecera resumen mineral
                doc.setFillColor(44, 62, 80);
                doc.rect(10, y, 60, 7, 'FD');
                doc.rect(70, y, 60, 7, 'FD');
                doc.rect(130, y, 35, 7, 'FD');
                doc.rect(165, y, 35, 7, 'FD');
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('MINERAL', 40, y + 4.5, { align: 'center' });
                doc.text('GRAFICO', 100, y + 4.5, { align: 'center' });
                doc.text('CANTIDAD', 147.5, y + 4.5, { align: 'center' });
                doc.text('UNIDAD', 182.5, y + 4.5, { align: 'center' });
                y += 7;
                
                doc.setTextColor(0, 0, 0);
                const maxCantidad = Math.max(...Object.values(porMineral).map(m => m.cantidad));
                
                Object.keys(porMineral).sort((a, b) => porMineral[b].cantidad - porMineral[a].cantidad).forEach((mineral, index) => {
                    // Calcular si cabe (8mm por fila)
                    if (y + 8 > 270) {
                        doc.addPage();
                        y = 10;
                        // Repetir cabecera
                        doc.setFillColor(44, 62, 80);
                        doc.rect(10, y, 60, 7, 'FD');
                        doc.rect(70, y, 60, 7, 'FD');
                        doc.rect(130, y, 35, 7, 'FD');
                        doc.rect(165, y, 35, 7, 'FD');
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(255, 255, 255);
                        doc.text('MINERAL', 40, y + 4.5, { align: 'center' });
                        doc.text('GRAFICO', 100, y + 4.5, { align: 'center' });
                        doc.text('CANTIDAD', 147.5, y + 4.5, { align: 'center' });
                        doc.text('UNIDAD', 182.5, y + 4.5, { align: 'center' });
                        y += 7;
                        doc.setTextColor(0, 0, 0);
                        doc.setFont('helvetica', 'normal');
                    }
                    
                    const isAlternate = index % 2 === 0;
                    doc.setFillColor(isAlternate ? 255 : 245, isAlternate ? 255 : 250, isAlternate ? 255 : 250);
                    doc.setFont('helvetica', 'normal');
                    doc.rect(10, y, 60, 8, 'FD');
                    doc.rect(70, y, 60, 8, 'FD');
                    doc.rect(130, y, 35, 8, 'FD');
                    doc.rect(165, y, 35, 8, 'FD');
                    
                    doc.setFontSize(8);
                    doc.text(mineral, 12, y + 5.5);
                    
                    // Barra de progreso basada en cantidad real
                    const barWidth = (porMineral[mineral].cantidad / maxCantidad) * 55;
                    doc.setFillColor(46, 204, 113);
                    doc.rect(72, y + 2, barWidth, 4, 'F');
                    
                    // Unidad principal de este mineral
                    const unidadMineral = Object.keys(porMineral[mineral].unidades).sort((a, b) => 
                        porMineral[mineral].unidades[b] - porMineral[mineral].unidades[a]
                    )[0];
                    
                    // Verificar si hay múltiples unidades para este mineral
                    const unidadesMineral = Object.keys(porMineral[mineral].unidades);
                    const hayMezcla = unidadesMineral.length > 1;
                    
                    // CANTIDAD EN UNIDAD REAL
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(12);
                    doc.setTextColor(46, 204, 113);
                    
                    if (hayMezcla) {
                        // Mostrar todas las unidades
                        let textoMezcla = '';
                        unidadesMineral.forEach((u, i) => {
                            if (i > 0) textoMezcla += ' + ';
                            textoMezcla += `${porMineral[mineral].unidades[u].toFixed(0)} ${u}`;
                        });
                        doc.setFontSize(9);
                        doc.text(textoMezcla, 147.5, y + 5.5, { align: 'center' });
                    } else {
                        doc.text(`${porMineral[mineral].cantidad.toFixed(0)} ${unidadMineral}`, 147.5, y + 5.5, { align: 'center' });
                    }
                    
                    // Columna UNIDAD
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(10);
                    doc.setTextColor(52, 152, 219);
                    doc.text(hayMezcla ? 'MIXTO' : unidadMineral || 'Unidades', 182.5, y + 5.5, { align: 'center' });
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(0, 0, 0);
                    y += 8;
                });
                
                // TOTAL GENERAL - MUY VISIBLE
                y += 3;
                if (y + 15 > 270) {
                    doc.addPage();
                    y = 10;
                }
                
                doc.setFillColor(231, 76, 60);
                doc.rect(10, y, 120, 12, 'FD');
                doc.rect(130, y, 70, 12, 'FD');
                
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(12);
                doc.setTextColor(255, 255, 255);
                doc.text('TOTAL GENERAL PRODUCCION', 70, y + 7.5, { align: 'center' });
                
                doc.setFontSize(16);
                if (hayUnidadesMixtas) {
                    doc.text(`${totalGeneral.toFixed(0)} (MIXTO)`, 165, y + 7.5, { align: 'center' });
                } else {
                    doc.text(`${totalGeneral.toFixed(0)} ${unidadPrincipal.toUpperCase()}`, 165, y + 7.5, { align: 'center' });
                }
                
                y += 15;
                
                // PIE
                doc.setFontSize(7);
                doc.setTextColor(100, 100, 100);
                doc.text(`Pagina ${paginaActual} | Generado: ${new Date().toLocaleString('es-ES')}`, 105, 290, { align: 'center' });
                paginaActual++;
            });
            
            doc.save(`${nombreEmpresa.replace(/\s+/g, '_')}_Produccion_Semanal_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function exportarMovimientosSemanal() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            const movimientos = DATA.movimiento;
            
            if (movimientos.length === 0) {
                alert('No hay movimientos para exportar');
                return;
            }
            
            const nombreEmpresa = (await getConfig('config_nombreEmpresa', '')) || 'MINERA APU 1';
            
            // Función para formatear cantidad IGUAL que en la tabla
            function formatearCantidad(m) {
                let cantidadDisplay = m.cantidad || 0;
                
                const producto = DATA.insumos.find(p => p.producto === m.insumo);
                if (producto && producto.tipo_control === 'Contable' && producto.unidades_por_caja > 1 && m.mov_cajas !== undefined) {
                    const cajas = m.mov_cajas || 0;
                    const unidades = m.mov_unidades || 0;
                    let unidadNombre = 'unidades';
                    if (producto.unidad === 'Pares') unidadNombre = 'pares';
                    else if (producto.unidad === 'Rollo') unidadNombre = 'rollos';
                    else if (producto.unidad === 'Bolsa') unidadNombre = 'bolsas';
                    
                    cantidadDisplay = `${cajas} cajas, ${unidades} ${unidadNombre}`;
                } else if (producto && producto.unidad) {
                    // Para productos medibles, agregar la unidad
                    cantidadDisplay = `${m.cantidad || 0} ${producto.unidad}`;
                }
                
                return cantidadDisplay;
            }
            
            // Agrupar por semana
            const movimientosPorSemana = {};
            movimientos.forEach(m => {
                const fecha = new Date(m.fecha + 'T00:00:00');
                const diaInicio = fecha.getDay();
                const lunes = new Date(fecha);
                lunes.setDate(lunes.getDate() - (diaInicio === 0 ? 6 : diaInicio - 1));
                const semanaKey = lunes.toISOString().split('T')[0];
                
                if (!movimientosPorSemana[semanaKey]) {
                    movimientosPorSemana[semanaKey] = [];
                }
                movimientosPorSemana[semanaKey].push(m);
            });
            
            const semanas = Object.keys(movimientosPorSemana).sort();
            let paginaActual = 1;
            
            semanas.forEach((semanaKey, semanaIndex) => {
                if (semanaIndex > 0) doc.addPage();
                
                const movimientosSemana = movimientosPorSemana[semanaKey];
                const fechaInicio = new Date(semanaKey);
                const fechaFin = new Date(fechaInicio);
                fechaFin.setDate(fechaFin.getDate() + 6);
                
                let y = 10;
                
                // TÍTULO
                doc.setFillColor(23, 162, 184);
                doc.rect(10, y, 190, 12, 'FD');
                doc.setFontSize(14);
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.text(nombreEmpresa, 105, y + 5, { align: 'center' });
                doc.setFontSize(11);
                doc.text('REPORTE SEMANAL DE MOVIMIENTOS', 105, y + 10, { align: 'center' });
                y += 15;
                
                // PERIODO
                doc.setFillColor(52, 73, 94);
                doc.rect(10, y, 190, 8, 'FD');
                doc.setFontSize(10);
                doc.setTextColor(255, 255, 255);
                const periodoTexto = `PERIODO: ${fechaInicio.getDate()}/${fechaInicio.getMonth()+1} AL ${fechaFin.getDate()}/${fechaFin.getMonth()+1}/${fechaFin.getFullYear()}`;
                doc.text(periodoTexto, 105, y + 5.5, { align: 'center' });
                y += 12;
                
                // Separar movimientos por tipo
                const entradas = movimientosSemana.filter(m => m.tipo === 'Entrada').sort((a,b) => new Date(a.fecha) - new Date(b.fecha));
                const salidas = movimientosSemana.filter(m => m.tipo === 'Salida').sort((a,b) => new Date(a.fecha) - new Date(b.fecha));
                
                // TABLA DE ENTRADAS
                if (entradas.length > 0) {
                    doc.setFillColor(40, 167, 69);
                    doc.rect(10, y, 190, 7, 'FD');
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(255, 255, 255);
                    doc.text('ENTRADAS', 105, y + 4.5, { align: 'center' });
                    y += 7;
                    
                    // Cabecera
                    doc.setFillColor(44, 62, 80);
                    doc.rect(10, y, 25, 7, 'FD');
                    doc.rect(35, y, 75, 7, 'FD');
                    doc.rect(110, y, 50, 7, 'FD');
                    doc.rect(160, y, 40, 7, 'FD');
                    doc.setFontSize(8);
                    doc.setTextColor(255, 255, 255);
                    doc.text('FECHA', 22.5, y + 4.5, { align: 'center' });
                    doc.text('PRODUCTO', 72.5, y + 4.5, { align: 'center' });
                    doc.text('CANTIDAD', 135, y + 4.5, { align: 'center' });
                    doc.text('RESPONSABLE', 180, y + 4.5, { align: 'center' });
                    y += 7;
                    
                    doc.setFont('helvetica', 'normal');
                    let isAlt = false;
                    entradas.forEach(e => {
                        if (y + 7 > 270) {
                            doc.addPage();
                            y = 10;
                            isAlt = false;
                            
                            // Repetir cabecera de ENTRADAS
                            doc.setFillColor(40, 167, 69);
                            doc.rect(10, y, 190, 7, 'FD');
                            doc.setFontSize(10);
                            doc.setFont('helvetica', 'bold');
                            doc.setTextColor(255, 255, 255);
                            doc.text('ENTRADAS (cont.)', 105, y + 4.5, { align: 'center' });
                            y += 7;
                            
                            doc.setFillColor(44, 62, 80);
                            doc.rect(10, y, 25, 7, 'FD');
                            doc.rect(35, y, 75, 7, 'FD');
                            doc.rect(110, y, 50, 7, 'FD');
                            doc.rect(160, y, 40, 7, 'FD');
                            doc.setFontSize(8);
                            doc.setTextColor(255, 255, 255);
                            doc.text('FECHA', 22.5, y + 4.5, { align: 'center' });
                            doc.text('PRODUCTO', 72.5, y + 4.5, { align: 'center' });
                            doc.text('CANTIDAD', 135, y + 4.5, { align: 'center' });
                            doc.text('RESPONSABLE', 180, y + 4.5, { align: 'center' });
                            y += 7;
                        }
                        
                        doc.setFillColor(isAlt ? 255 : 240, isAlt ? 255 : 255, isAlt ? 255 : 240);
                        doc.rect(10, y, 25, 7, 'FD');
                        doc.rect(35, y, 75, 7, 'FD');
                        doc.rect(110, y, 50, 7, 'FD');
                        doc.rect(160, y, 40, 7, 'FD');
                        
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(8);
                        const fecha = new Date(e.fecha + 'T00:00:00');
                        doc.text(`${fecha.getDate()}/${fecha.getMonth()+1}`, 22.5, y + 4.5, { align: 'center' });
                        
                        const prod = (e.insumo || '').length > 32 ? (e.insumo || '').substring(0, 32) + '...' : (e.insumo || '');
                        doc.text(prod, 37, y + 4.5);
                        
                        doc.setFont('helvetica', 'bold');
                        const cantTexto = String(formatearCantidad(e));
                        doc.setFontSize(cantTexto.length > 15 ? 7 : 8);
                        doc.text(cantTexto, 135, y + 4.5, { align: 'center' });
                        
                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(8);
                        const resp = (e.responsable || '').length > 16 ? (e.responsable || '').substring(0, 16) + '...' : (e.responsable || '');
                        doc.text(resp, 162, y + 4.5);
                        
                        y += 7;
                        isAlt = !isAlt;
                    });
                    
                    y += 3;
                }
                
                // TABLA DE SALIDAS
                if (salidas.length > 0) {
                    if (y + 15 > 270) {
                        doc.addPage();
                        y = 10;
                    }
                    
                    doc.setFillColor(220, 53, 69);
                    doc.rect(10, y, 190, 7, 'FD');
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(255, 255, 255);
                    doc.text('SALIDAS', 105, y + 4.5, { align: 'center' });
                    y += 7;
                    
                    // Cabecera
                    doc.setFillColor(44, 62, 80);
                    doc.rect(10, y, 25, 7, 'FD');
                    doc.rect(35, y, 75, 7, 'FD');
                    doc.rect(110, y, 50, 7, 'FD');
                    doc.rect(160, y, 40, 7, 'FD');
                    doc.setFontSize(8);
                    doc.setTextColor(255, 255, 255);
                    doc.text('FECHA', 22.5, y + 4.5, { align: 'center' });
                    doc.text('PRODUCTO', 72.5, y + 4.5, { align: 'center' });
                    doc.text('CANTIDAD', 135, y + 4.5, { align: 'center' });
                    doc.text('RESPONSABLE', 180, y + 4.5, { align: 'center' });
                    y += 7;
                    
                    doc.setFont('helvetica', 'normal');
                    let isAlt = false;
                    salidas.forEach(s => {
                        if (y + 7 > 270) {
                            doc.addPage();
                            y = 10;
                            isAlt = false;
                            
                            // Repetir cabecera de SALIDAS
                            doc.setFillColor(220, 53, 69);
                            doc.rect(10, y, 190, 7, 'FD');
                            doc.setFontSize(10);
                            doc.setFont('helvetica', 'bold');
                            doc.setTextColor(255, 255, 255);
                            doc.text('SALIDAS (cont.)', 105, y + 4.5, { align: 'center' });
                            y += 7;
                            
                            doc.setFillColor(44, 62, 80);
                            doc.rect(10, y, 25, 7, 'FD');
                            doc.rect(35, y, 75, 7, 'FD');
                            doc.rect(110, y, 50, 7, 'FD');
                            doc.rect(160, y, 40, 7, 'FD');
                            doc.setFontSize(8);
                            doc.setTextColor(255, 255, 255);
                            doc.text('FECHA', 22.5, y + 4.5, { align: 'center' });
                            doc.text('PRODUCTO', 72.5, y + 4.5, { align: 'center' });
                            doc.text('CANTIDAD', 135, y + 4.5, { align: 'center' });
                            doc.text('RESPONSABLE', 180, y + 4.5, { align: 'center' });
                            y += 7;
                        }
                        
                        doc.setFillColor(isAlt ? 255 : 255, isAlt ? 255 : 240, isAlt ? 255 : 240);
                        doc.rect(10, y, 25, 7, 'FD');
                        doc.rect(35, y, 75, 7, 'FD');
                        doc.rect(110, y, 50, 7, 'FD');
                        doc.rect(160, y, 40, 7, 'FD');
                        
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(8);
                        const fecha = new Date(s.fecha + 'T00:00:00');
                        doc.text(`${fecha.getDate()}/${fecha.getMonth()+1}`, 22.5, y + 4.5, { align: 'center' });
                        
                        const prod = (s.insumo || '').length > 32 ? (s.insumo || '').substring(0, 32) + '...' : (s.insumo || '');
                        doc.text(prod, 37, y + 4.5);
                        
                        doc.setFont('helvetica', 'bold');
                        const cantTexto = String(formatearCantidad(s));
                        doc.setFontSize(cantTexto.length > 15 ? 7 : 8);
                        doc.text(cantTexto, 135, y + 4.5, { align: 'center' });
                        
                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(8);
                        const resp = (s.responsable || '').length > 16 ? (s.responsable || '').substring(0, 16) + '...' : (s.responsable || '');
                        doc.text(resp, 162, y + 4.5);
                        
                        y += 7;
                        isAlt = !isAlt;
                    });
                    
                    y += 3;
                }
                
                // TABLA RESUMEN POR PRODUCTO
                if (y + 40 > 270) {
                    doc.addPage();
                    y = 10;
                }
                
                doc.setFillColor(108, 117, 125);
                doc.rect(10, y, 190, 7, 'FD');
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('RESUMEN: ENTRADAS, SALIDAS Y STOCK POR PRODUCTO', 105, y + 4.5, { align: 'center' });
                y += 7;
                
                // Calcular totales por producto con formato
                const resumenProductos = {};
                movimientosSemana.forEach(m => {
                    if (!resumenProductos[m.insumo]) {
                        const insumo = DATA.insumos.find(i => i.producto === m.insumo);
                        resumenProductos[m.insumo] = {
                            entradasList: [],
                            salidasList: [],
                            stock: insumo ? insumo.stock_actual : 0,
                            insumo: insumo
                        };
                    }
                    if (m.tipo === 'Entrada') resumenProductos[m.insumo].entradasList.push(m);
                    if (m.tipo === 'Salida') resumenProductos[m.insumo].salidasList.push(m);
                });
                
                // Cabecera resumen
                doc.setFillColor(44, 62, 80);
                doc.rect(10, y, 50, 7, 'FD');
                doc.rect(60, y, 45, 7, 'FD');
                doc.rect(105, y, 45, 7, 'FD');
                doc.rect(150, y, 50, 7, 'FD');
                doc.setFontSize(8);
                doc.setTextColor(255, 255, 255);
                doc.text('PRODUCTO', 35, y + 4.5, { align: 'center' });
                doc.text('ENTRADAS', 82.5, y + 4.5, { align: 'center' });
                doc.text('SALIDAS', 127.5, y + 4.5, { align: 'center' });
                doc.text('STOCK ACTUAL', 175, y + 4.5, { align: 'center' });
                y += 7;
                
                doc.setFont('helvetica', 'normal');
                Object.keys(resumenProductos).sort().forEach((prod, idx) => {
                    if (y + 7 > 270) {
                        doc.addPage();
                        y = 10;
                        
                        // Repetir título y cabecera del resumen
                        doc.setFillColor(108, 117, 125);
                        doc.rect(10, y, 190, 7, 'FD');
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(255, 255, 255);
                        doc.text('RESUMEN (cont.)', 105, y + 4.5, { align: 'center' });
                        y += 7;
                        
                        doc.setFillColor(44, 62, 80);
                        doc.rect(10, y, 50, 7, 'FD');
                        doc.rect(60, y, 45, 7, 'FD');
                        doc.rect(105, y, 45, 7, 'FD');
                        doc.rect(150, y, 50, 7, 'FD');
                        doc.setFontSize(8);
                        doc.setTextColor(255, 255, 255);
                        doc.text('PRODUCTO', 35, y + 4.5, { align: 'center' });
                        doc.text('ENTRADAS', 82.5, y + 4.5, { align: 'center' });
                        doc.text('SALIDAS', 127.5, y + 4.5, { align: 'center' });
                        doc.text('STOCK ACTUAL', 175, y + 4.5, { align: 'center' });
                        y += 7;
                        
                        doc.setFont('helvetica', 'normal');
                    }
                    
                    const isAlt = idx % 2 === 0;
                    doc.setFillColor(isAlt ? 255 : 245, isAlt ? 255 : 250, isAlt ? 255 : 250);
                    doc.rect(10, y, 50, 7, 'FD');
                    doc.rect(60, y, 45, 7, 'FD');
                    doc.rect(105, y, 45, 7, 'FD');
                    doc.rect(150, y, 50, 7, 'FD');
                    
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(8);
                    const prodTexto = prod.length > 20 ? prod.substring(0, 20) + '...' : prod;
                    doc.text(prodTexto, 12, y + 4.5);
                    
                    // ENTRADAS formateadas
                    const entradas = resumenProductos[prod].entradasList;
                    let entradasTexto = '0';
                    if (entradas.length > 0) {
                        const ins = resumenProductos[prod].insumo;
                        if (ins && ins.tipo_control === 'Contable' && ins.unidades_por_caja > 1) {
                            let totalCajas = 0;
                            let totalUnidades = 0;
                            entradas.forEach(e => {
                                totalCajas += (e.mov_cajas || 0);
                                totalUnidades += (e.mov_unidades || 0);
                            });
                            let unidadNombre = 'und';
                            if (ins.unidad === 'Pares') unidadNombre = 'pares';
                            else if (ins.unidad === 'Rollo') unidadNombre = 'rollos';
                            else if (ins.unidad === 'Bolsa') unidadNombre = 'bolsas';
                            entradasTexto = `${totalCajas} cj, ${totalUnidades} ${unidadNombre}`;
                        } else {
                            const total = entradas.reduce((sum, e) => sum + (parseFloat(e.cantidad) || 0), 0);
                            entradasTexto = ins && ins.unidad ? `${total} ${ins.unidad}` : String(total);
                        }
                    }
                    
                    doc.setTextColor(40, 167, 69);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(entradasTexto.length > 12 ? 7 : 8);
                    doc.text(entradasTexto, 82.5, y + 4.5, { align: 'center' });
                    
                    // SALIDAS formateadas
                    const salidas = resumenProductos[prod].salidasList;
                    let salidasTexto = '0';
                    if (salidas.length > 0) {
                        const ins = resumenProductos[prod].insumo;
                        if (ins && ins.tipo_control === 'Contable' && ins.unidades_por_caja > 1) {
                            let totalCajas = 0;
                            let totalUnidades = 0;
                            salidas.forEach(s => {
                                totalCajas += (s.mov_cajas || 0);
                                totalUnidades += (s.mov_unidades || 0);
                            });
                            let unidadNombre = 'und';
                            if (ins.unidad === 'Pares') unidadNombre = 'pares';
                            else if (ins.unidad === 'Rollo') unidadNombre = 'rollos';
                            else if (ins.unidad === 'Bolsa') unidadNombre = 'bolsas';
                            salidasTexto = `${totalCajas} cj, ${totalUnidades} ${unidadNombre}`;
                        } else {
                            const total = salidas.reduce((sum, s) => sum + (parseFloat(s.cantidad) || 0), 0);
                            salidasTexto = ins && ins.unidad ? `${total} ${ins.unidad}` : String(total);
                        }
                    }
                    
                    doc.setTextColor(220, 53, 69);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(salidasTexto.length > 12 ? 7 : 8);
                    doc.text(salidasTexto, 127.5, y + 4.5, { align: 'center' });
                    
                    // Stock formateado según tipo
                    const ins = resumenProductos[prod].insumo;
                    let stockTexto = String(resumenProductos[prod].stock);
                    if (ins && ins.tipo_control === 'Contable' && ins.unidades_por_caja > 1) {
                        const cajas = ins.stock_cajas || 0;
                        const unidades = ins.stock_unidades || 0;
                        let unidadNombre = 'und';
                        if (ins.unidad === 'Pares') unidadNombre = 'pares';
                        else if (ins.unidad === 'Rollo') unidadNombre = 'rollos';
                        else if (ins.unidad === 'Bolsa') unidadNombre = 'bolsas';
                        stockTexto = `${cajas} cj, ${unidades} ${unidadNombre}`;
                    }
                    
                    doc.setTextColor(52, 152, 219);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(stockTexto.length > 12 ? 6 : 7);
                    doc.text(stockTexto, 175, y + 4.5, { align: 'center' });
                    
                    doc.setFont('helvetica', 'normal');
                    y += 7;
                });
                
                // PIE
                doc.setFontSize(7);
                doc.setTextColor(100, 100, 100);
                doc.text(`Página ${paginaActual} | Generado: ${new Date().toLocaleString('es-ES')}`, 105, 290, { align: 'center' });
                paginaActual++;
            });
            
            doc.save(`${nombreEmpresa.replace(/\s+/g, '_')}_Movimientos_Semanal_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // Menu Toggle
        document.getElementById('menuToggle').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('overlay').classList.toggle('active');
        });

        document.getElementById('overlay').addEventListener('click', () => {
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        });

        // Helper: Actualizar color según categoría
        function updateColorByCategory(categoria) {
            const colorMap = {
                'Explosivos': '#E53935',
                'Voladura': '#FF6B00',
                'EPP': '#7CB342',
                'Herramientas': '#607D8B',
                'Sostenimiento': '#673AB7',
                'Lubricantes': '#039BE5',
                'Repuestos': '#00ACC1'
            };
            
            const colorInput = document.getElementById('color');
            const colorHex = document.getElementById('color_hex');
            if (colorInput && colorMap[categoria]) {
                colorInput.value = colorMap[categoria];
                colorHex.value = colorMap[categoria];
            }
        }
        
        // Helper: Actualizar tipo control según unidad
        function updateTipoControl() {
            const unidad = document.getElementById('unidad')?.value;
            const tipoControl = document.getElementById('tipo_control');
            const unidadesCajaGroup = document.getElementById('unidades_caja_group');
            const stockContableGroup = document.getElementById('stockContableGroup');
            const stockMedibleGroup = document.getElementById('stockMedibleGroup');
            
            if (!unidad || !tipoControl) return;
            
            const medibles = ['Kg', 'Litros', 'Metro'];
            const contables = ['Unidades', 'Pares', 'Caja', 'Rollo', 'Bolsa'];
            
            if (medibles.includes(unidad)) {
                tipoControl.value = 'Medible';
                if (unidadesCajaGroup) unidadesCajaGroup.style.display = 'none';
                if (stockContableGroup) stockContableGroup.style.display = 'none';
                if (stockMedibleGroup) stockMedibleGroup.style.display = 'block';
                const unidCaja = document.getElementById('unidades_por_caja');
                if (unidCaja) unidCaja.value = 0;
            } else if (contables.includes(unidad)) {
                tipoControl.value = 'Contable';
                if (unidadesCajaGroup) unidadesCajaGroup.style.display = 'block';
                if (stockContableGroup) stockContableGroup.style.display = 'block';
                if (stockMedibleGroup) stockMedibleGroup.style.display = 'none';
            }
        }
        
        // Actualizar campos de stock cuando se cambia el tipo de control manualmente
        function updateStockFieldsByTipoControl() {
            const tipoControl = document.getElementById('tipo_control')?.value;
            const unidadesCajaGroup = document.getElementById('unidades_caja_group');
            const stockContableGroup = document.getElementById('stockContableGroup');
            const stockMedibleGroup = document.getElementById('stockMedibleGroup');
            
            if (tipoControl === 'Contable') {
                // Mostrar campos de cajas y unidades para contables
                if (unidadesCajaGroup) unidadesCajaGroup.style.display = 'block';
                if (stockContableGroup) stockContableGroup.style.display = 'block';
                if (stockMedibleGroup) stockMedibleGroup.style.display = 'none';
            } else if (tipoControl === 'Medible') {
                // Mostrar solo campo simple para medibles
                if (unidadesCajaGroup) unidadesCajaGroup.style.display = 'none';
                if (stockContableGroup) stockContableGroup.style.display = 'none';
                if (stockMedibleGroup) stockMedibleGroup.style.display = 'block';
            }
        }
        
        // Sincronizar color picker con hex
        document.addEventListener('change', (e) => {
            if (e.target.id === 'color') {
                const hex = document.getElementById('color_hex');
                if (hex) hex.value = e.target.value;
            }
            
            // Cambiar campos de cantidad en movimientos según producto seleccionado
            if (e.target.id === 'insumo' && currentView === 'movimiento') {
                const productoNombre = e.target.value;
                const producto = DATA.insumos.find(p => p.producto === productoNombre);
                
                const contableGroup = document.getElementById('cantidadContableGroup');
                const medibleGroup = document.getElementById('cantidadMedibleGroup');
                
                if (producto && producto.tipo_control === 'Contable' && producto.unidades_por_caja > 1) {
                    if (contableGroup) contableGroup.style.display = 'block';
                    if (medibleGroup) medibleGroup.style.display = 'none';
                } else {
                    if (contableGroup) contableGroup.style.display = 'none';
                    if (medibleGroup) medibleGroup.style.display = 'block';
                }
            }
        });

        // Menu Items
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                currentView = item.dataset.view;
                
                const titles = {
                    dashboard: 'Dashboard General',
                    usuarios: 'Gestión de Usuarios',
                    insumos: 'Inventario de Insumos',
                    movimiento: 'Control de Movimientos',
                    registro_trabajo: 'Registro de Trabajo',
                    avance: 'Control de Avance',
                    produccion: 'Control de Producción',
                    voladura: 'Gestión de Voladura',
                    reportes: 'Sistema de Reportes',
                    configuraciones: 'Configuraciones del Sistema'
                };
                
                document.getElementById('pageTitle').textContent = titles[currentView];
                
                // Limpiar campo de búsqueda al cambiar de vista
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.value = '';
                }
                
                if (currentView === 'dashboard') {
                    document.getElementById('dashboardStats').style.display = 'grid';
                    document.getElementById('contentPanel').style.display = 'none';
                    actualizarDashboard(); // Actualizar con datos en tiempo real
                } else if (currentView === 'reportes') {
                    document.getElementById('dashboardStats').style.display = 'none';
                    document.getElementById('contentPanel').style.display = 'block';
                    document.getElementById('filterSection').style.display = 'flex';
                    document.getElementById('panelHeader').style.display = 'none'; // Ocultar panel header en reportes
                    document.getElementById('tableContent').innerHTML = '<p class="text-center text-muted p-5">Seleccione un tipo de reporte y fechas para generar</p>';
                } else if (currentView === 'configuraciones') {
                    document.getElementById('dashboardStats').style.display = 'none';
                    document.getElementById('contentPanel').style.display = 'block';
                    document.getElementById('filterSection').style.display = 'none';
                    document.getElementById('panelHeader').style.display = 'none'; // Ocultar todo el panel header
                    renderConfiguraciones();
                } else {
                    document.getElementById('dashboardStats').style.display = 'none';
                    document.getElementById('contentPanel').style.display = 'block';
                    document.getElementById('filterSection').style.display = 'none';
                    document.getElementById('panelHeader').style.display = 'flex'; // Mostrar panel header
                    
                    const btnAgregar = document.getElementById('btnAgregar');
                    if (currentView === 'usuarios' && currentUser.rol !== 'admin') {
                        btnAgregar.disabled = true;
                        btnAgregar.innerHTML = '<i class="fas fa-lock"></i> Solo Admin';
                        btnAgregar.classList.remove('btn-primary');
                        btnAgregar.classList.add('btn-secondary');
                    } else {
                        btnAgregar.disabled = false;
                        btnAgregar.innerHTML = '<i class="fas fa-plus"></i> Agregar';
                        btnAgregar.classList.remove('btn-secondary');
                        btnAgregar.classList.add('btn-primary');
                    }
                    btnAgregar.style.display = 'inline-block';
                    
                    renderTable(currentView);
                }
                
                // Cerrar menú en móvil
                if (window.innerWidth <= 992) {
                    document.getElementById('sidebar').classList.remove('active');
                    document.getElementById('overlay').classList.remove('active');
                }
            });
        });
        
        // Función para previsualizar avatar
        function cargarAvatarPreview(event) {
            const file = event.target.files[0];
            if (file) {
                // Verificar tamaño (máx 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    alert('La imagen es muy grande. Máximo 2MB.');
                    event.target.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    avatarImageData = e.target.result;
                    
                    // Actualizar preview
                    const preview = document.getElementById('avatarPreview');
                    if (preview) {
                        preview.innerHTML = `<img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover;">`;
                    }
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Función para previsualizar imagen de producto
        function cargarImagenProductoPreview(event) {
            const file = event.target.files[0];
            if (file) {
                // Verificar tamaño (máx 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    alert('La imagen es muy grande. Máximo 2MB.');
                    event.target.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagenProductoData = e.target.result;
                    
                    // Actualizar preview
                    const preview = document.getElementById('imagenProductoPreview');
                    if (preview) {
                        preview.innerHTML = `<img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover;">`;
                    }
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Funciones del Modal
        function openModal(id = null) {
            // Verificar si estamos en modo visualización
            if (window.modoVisualizacionCampaña) {
                alert('⚠️ No puedes editar registros en modo visualización. Vuelve a la campaña actual para editar.');
                return;
            }
            
            editingId = id;
            const isEdit = id !== null;
            
            document.getElementById('modalTitle').textContent = isEdit ? 'EDITAR REGISTRO' : 'AGREGAR REGISTRO';
            document.getElementById('formFields').innerHTML = generateFormFields(currentView, id);
            document.getElementById('modalForm').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('modalForm').classList.remove('active');
            editingId = null;
        }
        
        function generateFormFields(view, id) {
            let html = '';
            let data = id ? DATA[view].find(item => item.id === id) : {};
            
            if (view === 'usuarios') {
                html += `
                    <div class="form-group">
                        <label>Foto de Perfil / Avatar</label>
                        <div class="d-flex align-items-center gap-3 mb-2">
                            <div class="border rounded-circle d-flex align-items-center justify-content-center" style="width:80px;height:80px;overflow:hidden;background:#f0f0f0;" id="avatarPreview">
                                ${data.avatar && data.avatar.startsWith('data:image') ? 
                                    `<img src="${data.avatar}" style="width:100%;height:100%;object-fit:cover;">` : 
                                    `<i class="fas fa-user text-muted" style="font-size:40px;"></i>`
                                }
                            </div>
                            <div class="flex-grow-1">
                                <input type="file" class="form-control" id="avatarImagen" accept="image/*" onchange="cargarAvatarPreview(event)">
                                <small class="text-muted">Formatos: JPG, PNG, GIF (máx. 2MB)</small>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ID Usuario *</label>
                        <input type="text" id="id_usuario" value="${data.id_usuario || 'USR' + String(Math.max(...DATA.usuarios.map(u => parseInt(u.id_usuario?.replace('USR','') || 0)), 0) + 1).padStart(3, '0')}" required>
                    </div>
                    <div class="form-group">
                        <label>Nombre Completo *</label>
                        <input type="text" id="nombre" value="${data.nombre || ''}" required>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="email" value="${data.email || ''}" required>
                    </div>
                    <div class="form-group">
                        <label>Contraseña ${id ? '' : '*'}</label>
                        <input type="password" id="password" value="${id ? '' : ''}" ${id ? '' : 'required'} placeholder="${id ? 'Dejar en blanco para mantener' : ''}">
                    </div>
                    <div class="form-group">
                        <label>Rol / Cargo *</label>
                        <select id="rol" required>
                            <option value="">Seleccione...</option>
                            
                            <optgroup label="👔 Administración">
                                <option value="admin" ${data.rol === 'admin' ? 'selected' : ''}>Administrador</option>
                                <option value="gerente" ${data.rol === 'gerente' ? 'selected' : ''}>Gerente General</option>
                                <option value="jefe_operaciones" ${data.rol === 'jefe_operaciones' ? 'selected' : ''}>Jefe de Operaciones</option>
                                <option value="contador" ${data.rol === 'contador' ? 'selected' : ''}>Contador</option>
                                <option value="recursos_humanos" ${data.rol === 'recursos_humanos' ? 'selected' : ''}>Recursos Humanos</option>
                            </optgroup>
                            
                            <optgroup label="⚙️ Ingeniería y Supervisión">
                                <option value="ingeniero_minas" ${data.rol === 'ingeniero_minas' ? 'selected' : ''}>Ingeniero de Minas</option>
                                <option value="ingeniero_seguridad" ${data.rol === 'ingeniero_seguridad' ? 'selected' : ''}>Ingeniero de Seguridad</option>
                                <option value="supervisor" ${data.rol === 'supervisor' ? 'selected' : ''}>Supervisor de Turno</option>
                                <option value="tecnico" ${data.rol === 'tecnico' ? 'selected' : ''}>Técnico Minero</option>
                                <option value="topografo" ${data.rol === 'topografo' ? 'selected' : ''}>Topógrafo</option>
                            </optgroup>
                            
                            <optgroup label="🔬 Geología y Laboratorio">
                                <option value="geologo" ${data.rol === 'geologo' ? 'selected' : ''}>Geólogo</option>
                                <option value="ingeniero_geologo" ${data.rol === 'ingeniero_geologo' ? 'selected' : ''}>Ingeniero Geólogo</option>
                                <option value="laboratorista" ${data.rol === 'laboratorista' ? 'selected' : ''}>Laboratorista</option>
                            </optgroup>
                            
                            <optgroup label="⛏️ Operaciones Mina">
                                <option value="encargado" ${data.rol === 'encargado' ? 'selected' : ''}>Encargado de Área</option>
                                <option value="perforista" ${data.rol === 'perforista' ? 'selected' : ''}>Perforista</option>
                                <option value="operador" ${data.rol === 'operador' ? 'selected' : ''}>Operador de Maquinaria</option>
                                <option value="volador" ${data.rol === 'volador' ? 'selected' : ''}>Volador</option>
                                <option value="carrero" ${data.rol === 'carrero' ? 'selected' : ''}>Carrero</option>
                                <option value="ayudante" ${data.rol === 'ayudante' ? 'selected' : ''}>Ayudante de Mina</option>
                                <option value="trabajador" ${data.rol === 'trabajador' ? 'selected' : ''}>Trabajador General</option>
                            </optgroup>
                            
                            <optgroup label="🔧 Mantenimiento">
                                <option value="mecanico" ${data.rol === 'mecanico' ? 'selected' : ''}>Mecánico</option>
                                <option value="electricista" ${data.rol === 'electricista' ? 'selected' : ''}>Electricista</option>
                                <option value="soldador" ${data.rol === 'soldador' ? 'selected' : ''}>Soldador</option>
                            </optgroup>
                            
                            <optgroup label="📦 Logística y Almacén">
                                <option value="almacenero" ${data.rol === 'almacenero' ? 'selected' : ''}>Almacenero</option>
                                <option value="logistica" ${data.rol === 'logistica' ? 'selected' : ''}>Logística</option>
                                <option value="chofer" ${data.rol === 'chofer' ? 'selected' : ''}>Chofer</option>
                            </optgroup>
                            
                            <optgroup label="🏥 Salud y Servicios">
                                <option value="enfermero" ${data.rol === 'enfermero' ? 'selected' : ''}>Enfermero(a)</option>
                                <option value="cocinero" ${data.rol === 'cocinero' ? 'selected' : ''}>Cocinero(a)</option>
                                <option value="vigilante" ${data.rol === 'vigilante' ? 'selected' : ''}>Vigilante</option>
                                <option value="limpieza" ${data.rol === 'limpieza' ? 'selected' : ''}>Personal de Limpieza</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fecha Registro</label>
                        <input type="date" id="fecha_registro" value="${data.fecha_registro || new Date().toISOString().split('T')[0]}">
                    </div>
                    <div class="form-group">
                        <label>Estado *</label>
                        <select id="estado" required>
                            <option value="Activo" ${data.estado === 'Activo' ? 'selected' : ''}>Activo</option>
                            <option value="Inactivo" ${data.estado === 'Inactivo' ? 'selected' : ''}>Inactivo</option>
                        </select>
                    </div>
                `;
            } else if (view === 'insumos') {
                const nextId = 'PROD' + String(Math.max(...DATA.insumos.map(i => parseInt(i.id_producto?.replace('PROD','') || 0)), 0) + 1).padStart(3, '0');
                html += `
                    <div class="form-group">
                        <label>Imagen del Producto</label>
                        <div class="d-flex align-items-center gap-3 mb-2">
                            <div class="border rounded d-flex align-items-center justify-content-center" style="width:100px;height:100px;overflow:hidden;background:#f0f0f0;" id="imagenProductoPreview">
                                ${data.imagen && data.imagen.startsWith('data:image') ? 
                                    `<img src="${data.imagen}" style="width:100%;height:100%;object-fit:cover;">` : 
                                    `<i class="fas fa-box text-muted" style="font-size:40px;"></i>`
                                }
                            </div>
                            <div class="flex-grow-1">
                                <input type="file" class="form-control" id="imagenProducto" accept="image/*" onchange="cargarImagenProductoPreview(event)">
                                <small class="text-muted">Formatos: JPG, PNG, GIF (máx. 2MB)</small>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ID Producto *</label>
                        <input type="text" id="id_producto" value="${data.id_producto || nextId}" required readonly style="background:#f5f5f5">
                    </div>
                    <div class="form-group">
                        <label>Nombre del Producto *</label>
                        <input type="text" id="producto" value="${data.producto || ''}" required>
                    </div>
                    <div class="form-group">
                        <label>REF (Código Rápido)</label>
                        <input type="text" id="ref" value="${data.ref || ''}" placeholder="Ej: ANFO, DIN65" maxlength="15">
                        <small class="text-muted">Referencia corta para identificación rápida (opcional)</small>
                    </div>
                    <div class="form-group">
                        <label>Categoría *</label>
                        <select id="categoria" required onchange="updateColorByCategory(this.value)">
                            <option value="">Seleccione...</option>
                            <optgroup label="🧨 Explosivos y Voladura">
                                <option value="Explosivos" ${data.categoria === 'Explosivos' ? 'selected' : ''}>Explosivos</option>
                                <option value="Voladura" ${data.categoria === 'Voladura' ? 'selected' : ''}>Voladura</option>
                            </optgroup>
                            <optgroup label="🦺 Seguridad">
                                <option value="EPP" ${data.categoria === 'EPP' ? 'selected' : ''}>EPP (Equipo Protección Personal)</option>
                            </optgroup>
                            <optgroup label="🔧 Operación">
                                <option value="Herramientas" ${data.categoria === 'Herramientas' ? 'selected' : ''}>Herramientas</option>
                                <option value="Sostenimiento" ${data.categoria === 'Sostenimiento' ? 'selected' : ''}>Sostenimiento</option>
                            </optgroup>
                            <optgroup label="⚙️ Mantenimiento">
                                <option value="Lubricantes" ${data.categoria === 'Lubricantes' ? 'selected' : ''}>Lubricantes</option>
                                <option value="Repuestos" ${data.categoria === 'Repuestos' ? 'selected' : ''}>Repuestos</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Unidad de Medida *</label>
                        <select id="unidad" required onchange="updateTipoControl()">
                            <option value="">Seleccione...</option>
                            <optgroup label="Contables">
                                <option value="Unidades" ${data.unidad === 'Unidades' ? 'selected' : ''}>Unidades</option>
                                <option value="Pares" ${data.unidad === 'Pares' ? 'selected' : ''}>Pares</option>
                                <option value="Caja" ${data.unidad === 'Caja' ? 'selected' : ''}>Caja</option>
                                <option value="Rollo" ${data.unidad === 'Rollo' ? 'selected' : ''}>Rollo</option>
                                <option value="Bolsa" ${data.unidad === 'Bolsa' ? 'selected' : ''}>Bolsa</option>
                            </optgroup>
                            <optgroup label="Medibles">
                                <option value="Kg" ${data.unidad === 'Kg' ? 'selected' : ''}>Kilogramos (Kg)</option>
                                <option value="Litros" ${data.unidad === 'Litros' ? 'selected' : ''}>Litros (L)</option>
                                <option value="Metro" ${data.unidad === 'Metro' ? 'selected' : ''}>Metros (m)</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Control *</label>
                        <select id="tipo_control" required onchange="updateStockFieldsByTipoControl()">
                            <option value="Contable" ${data.tipo_control === 'Contable' ? 'selected' : ''}>📊 Contable (por unidades)</option>
                            <option value="Medible" ${data.tipo_control === 'Medible' ? 'selected' : ''}>📏 Medible (por peso/volumen)</option>
                        </select>
                        <small class="text-muted">Contable: se cuenta por unidades. Medible: se mide por peso/volumen</small>
                    </div>
                    <div class="form-group" id="unidades_caja_group" style="display:${data.tipo_control === 'Contable' ? 'block' : 'none'};">
                        <label>Unidades por Caja</label>
                        <input type="number" id="unidades_por_caja" value="${data.unidades_por_caja || 0}" min="0">
                        <small class="text-muted">Solo para productos contables. Ej: 100 fulminantes por caja. Si es 0 o 1, se manejará solo en unidades.</small>
                    </div>
                    <div class="form-group">
                        <label>Presentación *</label>
                        <input type="text" id="presentacion" value="${data.presentacion || ''}" placeholder="Ej: Caja x 100 unidades" required>
                    </div>
                    <div class="form-group">
                        <label>Stock Mínimo *</label>
                        <input type="number" id="stock_minimo" value="${data.stock_minimo || 1}" min="1" required>
                        <small class="text-muted">Cantidad mínima para alerta de reposición</small>
                    </div>
                    <div class="form-group" id="stockContableGroup" style="display:${data.tipo_control === 'Contable' ? 'block' : 'none'};">
                        <label>Stock Actual (Cajas y Unidades) *</label>
                        <div style="display:flex;gap:10px;">
                            <div style="flex:1;">
                                <input type="number" id="stock_cajas" value="${data.stock_cajas || 0}" min="0" placeholder="Ej: 5">
                                <small class="text-muted">Cajas completas</small>
                            </div>
                            <div style="flex:1;">
                                <input type="number" id="stock_unidades" value="${data.stock_unidades || 0}" min="0" placeholder="Ej: 50">
                                <small class="text-muted">Unidades sueltas</small>
                            </div>
                        </div>
                        <small class="text-muted d-block mt-2"><i class="fas fa-info-circle"></i> <strong>Nota:</strong> Si ingresaste unidades por caja, el total se calculará automáticamente</small>
                    </div>
                    <div class="form-group" id="stockMedibleGroup" style="display:${!data.tipo_control || data.tipo_control === 'Medible' ? 'block' : 'none'};">
                        <label>Stock Actual *</label>
                        <input type="number" id="stock_actual" value="${data.stock_actual || 0}" min="0" step="0.01" placeholder="Ej: 60">
                        <small class="text-muted">Cantidad disponible actualmente en almacén</small>
                    </div>
                    <div class="form-group">
                        <label>Color de Identificación *</label>
                        <div style="display:flex;gap:10px;align-items:center">
                            <input type="color" id="color" value="${data.color || '#4CAF50'}" required style="width:60px;height:40px;border:none;border-radius:8px;cursor:pointer">
                            <input type="text" id="color_hex" value="${data.color || '#4CAF50'}" readonly style="flex:1;background:#f5f5f5">
                        </div>
                        <small class="text-muted">Color para identificación visual rápida</small>
                    </div>
                `;
            } else if (view === 'movimiento') {
                // Generar lista de insumos desde la tabla DATA.insumos
                const insumosOptions = DATA.insumos.map(insumo => 
                    `<option value="${insumo.producto}" ${data.insumo === insumo.producto ? 'selected' : ''}>
                        ${insumo.producto} (${insumo.categoria}) - ${insumo.unidad}
                    </option>`
                ).join('');
                
                html += `
                    <div class="form-group">
                        <label>Fecha *</label>
                        <input type="date" id="fecha" value="${data.fecha || new Date().toISOString().split('T')[0]}" required>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Movimiento *</label>
                        <select id="tipo" required>
                            <option value="">Seleccione...</option>
                            <option value="Entrada" ${data.tipo === 'Entrada' ? 'selected' : ''}>Entrada (Ingreso al Almacén)</option>
                            <option value="Salida" ${data.tipo === 'Salida' ? 'selected' : ''}>Salida (Consumo/Uso)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Producto/Insumo *</label>
                        <select id="insumo" required>
                            <option value="">Seleccione un producto...</option>
                            ${insumosOptions}
                        </select>
                        <small class="text-muted">Seleccione el producto desde el inventario de insumos registrados</small>
                    </div>
                    <div class="form-group" id="cantidadContableGroup" style="display:none;">
                        <label>Cantidad (Cajas y Unidades) *</label>
                        <div style="display:flex;gap:10px;">
                            <div style="flex:1;">
                                <input type="number" id="mov_cajas" value="${data.mov_cajas || 0}" min="0" placeholder="Cajas">
                                <small class="text-muted">Cajas completas</small>
                            </div>
                            <div style="flex:1;">
                                <input type="number" id="mov_unidades" value="${data.mov_unidades || 0}" min="0" placeholder="Unidades">
                                <small class="text-muted">Unidades sueltas</small>
                            </div>
                        </div>
                    </div>
                    <div class="form-group" id="cantidadMedibleGroup">
                        <label>Cantidad *</label>
                        <input type="number" id="cantidad" value="${data.cantidad || 0}" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Responsable *</label>
                        <select id="responsable" required>
                            <option value="">Seleccione un responsable...</option>
                            ${DATA.usuarios.filter(u => u.estado === 'Activo').map(u => 
                                `<option value="${u.nombre}" ${data.responsable === u.nombre ? 'selected' : ''}>${u.nombre} (${u.rol})</option>`
                            ).join('')}
                        </select>
                        <small class="text-muted">Seleccione el responsable del movimiento</small>
                    </div>
                `;
            } else if (view === 'registro_trabajo') {
                const nextId = 'REG' + String(Math.max(...DATA.registro_trabajo.map(r => parseInt(r.id_registro?.replace('REG','') || 0)), 0) + 1).padStart(3, '0');
                html += `
                    <div class="form-group">
                        <label>ID Registro *</label>
                        <input type="text" id="id_registro" value="${data.id_registro || nextId}" required readonly style="background:#f5f5f5">
                    </div>
                    <div class="form-group">
                        <label>Fecha *</label>
                        <input type="date" id="fecha" value="${data.fecha || new Date().toISOString().split('T')[0]}" required>
                    </div>
                    <div class="form-group">
                        <label>Trabajador *</label>
                        <select id="trabajador_select" required onchange="completarDatosTrabajador()">
                            <option value="">Seleccione un trabajador...</option>
                            ${DATA.usuarios.filter(u => u.estado === 'Activo').map(u => 
                                `<option value="${u.id_usuario}|${u.nombre}" ${data.id_usuario === u.id_usuario ? 'selected' : ''}>
                                    ${u.id_usuario} - ${u.nombre} (${u.rol})
                                </option>`
                            ).join('')}
                        </select>
                        <small class="text-muted">Seleccione el trabajador de la lista de usuarios activos</small>
                    </div>
                    <div class="form-group" style="display:none;">
                        <input type="hidden" id="id_usuario" value="${data.id_usuario || ''}">
                        <input type="hidden" id="nombre" value="${data.nombre || ''}">
                    </div>
                    <div class="form-group">
                        <label>Zona de Trabajo *</label>
                        <div style="display:flex;gap:10px;align-items:flex-start;">
                            <input 
                                type="text" 
                                id="zona_trabajo" 
                                list="zonas-trabajo-list" 
                                value="${data.zona_trabajo || ''}"
                                placeholder="Seleccione o escriba una zona..."
                                required 
                                style="flex:1;"
                                class="form-control"
                            />
                            <datalist id="zonas-trabajo-list">
                                ${((await getZonas())).map(z => 
                                    `<option value="${z}">`
                                ).join('')}
                            </datalist>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="gestionarZonas()" title="Gestionar Zonas">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                        <small class="text-muted">
                            <i class="fas fa-lightbulb"></i> Seleccione de la lista o escriba una zona personalizada. Use el botón ⚙️ para gestionar zonas
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Turno *</label>
                        <select id="turno" required>
                            <option value="">Seleccione...</option>
                            <option value="Mañana" ${data.turno === 'Mañana' ? 'selected' : ''}>Mañana</option>
                            <option value="Tarde" ${data.turno === 'Tarde' ? 'selected' : ''}>Tarde</option>
                            <option value="Noche" ${data.turno === 'Noche' ? 'selected' : ''}>Noche</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Jornada Trabajada *</label>
                        <select id="horas_trabajadas" required>
                            <option value="">Seleccione...</option>
                            <option value="1" ${data.horas_trabajadas == '1' ? 'selected' : ''}>T - Turno Completo (1 día)</option>
                            <option value="1.5" ${data.horas_trabajadas == '1.5' ? 'selected' : ''}>TM - Turno y Medio (1.5 días)</option>
                            <option value="0.5" ${data.horas_trabajadas == '0.5' ? 'selected' : ''}>M - Medio Turno (0.5 días)</option>
                        </select>
                        <small class="text-muted">T=1 día, TM=1.5 días, M=0.5 días (para cálculo de días acumulados)</small>
                    </div>
                    <div class="form-group">
                        <label>Observaciones</label>
                        <textarea id="observaciones" rows="3">${data.observaciones || ''}</textarea>
                    </div>
                `;
            } else if (view === 'avance') {
                const nextId = 'AVA' + String(Math.max(...DATA.avance.map(a => parseInt(a.id_avance?.replace('AVA','') || 0)), 0) + 1).padStart(3, '0');
                html += `
                    <div class="form-group">
                        <label>ID Avance *</label>
                        <input type="text" id="id_avance" value="${data.id_avance || nextId}" required readonly style="background:#f5f5f5">
                    </div>
                    <div class="form-group">
                        <label>Fecha *</label>
                        <input type="date" id="fecha" value="${data.fecha || new Date().toISOString().split('T')[0]}" required>
                    </div>
                    <div class="form-group">
                        <label>Zona / Labor *</label>
                        <input type="text" id="zona" list="zonas_avance_list" value="${data.zona || ''}" required placeholder="Ej: Galería 340 NE" autocomplete="off">
                        <datalist id="zonas_avance_list">
                            ${[...new Set(DATA.avance.map(a => a.zona).filter(Boolean))].sort().map(z => `<option value="${z}">`).join('')}
                        </datalist>
                        <small class="text-muted">El sistema aprenderá las zonas que registres</small>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Trabajo *</label>
                        <input type="text" id="tipo_labor" list="tipos_labor_list" value="${data.tipo_labor || ''}" required placeholder="Ej: Galería, Frente A, Pique..." autocomplete="off">
                        <datalist id="tipos_labor_list">
                            ${[...new Set(DATA.avance.map(a => a.tipo_labor).filter(Boolean))].sort().map(tipo => `<option value="${tipo}">`).join('')}
                        </datalist>
                        <small class="text-muted">El sistema aprenderá los tipos que registres</small>
                    </div>
                    <div class="form-group">
                        <label>Actividad Realizada *</label>
                        <input type="text" id="actividad" list="actividades_avance_list" value="${data.actividad || ''}" required placeholder="Ej: Perforación" autocomplete="off">
                        <datalist id="actividades_avance_list">
                            ${[...new Set(DATA.avance.map(a => a.actividad).filter(Boolean))].sort().map(act => `<option value="${act}">`).join('')}
                        </datalist>
                        <small class="text-muted">El sistema aprenderá las actividades que registres</small>
                    </div>
                    <div class="form-group">
                        <label>Avance Lineal (m) *</label>
                        <input type="number" id="avance_metros" value="${data.avance_metros || 0}" min="0" step="0.1" required placeholder="Ej: 1.80">
                        <small class="text-muted">Metros lineales avanzados</small>
                    </div>
                    <div class="form-group">
                        <label>Jornada de Trabajo *</label>
                        <select id="jornada" required>
                            <option value="">Seleccione...</option>
                            <option value="1" ${data.jornada == 1 ? 'selected' : ''}>T - Turno Completo (8 horas)</option>
                            <option value="1.5" ${data.jornada == 1.5 ? 'selected' : ''}>TM - Turno y Medio (12 horas)</option>
                            <option value="0.5" ${data.jornada == 0.5 ? 'selected' : ''}>M - Medio Turno (4 horas)</option>
                        </select>
                        <small class="text-muted">Duración de la jornada de trabajo</small>
                    </div>
                    <div class="form-group">
                        <label>Personal Asignado *</label>
                        <input type="number" id="personal" value="${data.personal || 0}" min="1" required placeholder="Cantidad">
                    </div>
                    <div class="form-group">
                        <label>Observaciones</label>
                        <textarea id="observaciones" rows="3" placeholder="Detalles del avance, incidencias, etc...">${data.observaciones || ''}</textarea>
                    </div>
                `;
            } else if (view === 'produccion') {
                html += `
                    <div class="form-group">
                        <label>Fecha *</label>
                        <input type="date" id="fecha" value="${data.fecha || new Date().toISOString().split('T')[0]}" required>
                    </div>
                    <div class="form-group">
                        <label>Zona / Labor *</label>
                        <input type="text" id="zona" list="zonas_prod_list" value="${data.zona || ''}" required autocomplete="off" placeholder="Ej: Galería 340 NE">
                        <datalist id="zonas_prod_list">
                            ${[...new Set(DATA.produccion.map(p => p.zona).filter(Boolean))].sort().map(z => `<option value="${z}">`).join('')}
                        </datalist>
                        <small class="text-muted">El sistema aprenderá las zonas que registres</small>
                    </div>
                    <div class="form-group">
                        <label>Mineral *</label>
                        <select id="mineral" required>
                            <option value="">Seleccione...</option>
                            <option value="Oro" ${data.mineral === 'Oro' ? 'selected' : ''}>Oro</option>
                            <option value="Plata" ${data.mineral === 'Plata' ? 'selected' : ''}>Plata</option>
                            <option value="Cobre" ${data.mineral === 'Cobre' ? 'selected' : ''}>Cobre</option>
                            <option value="Zinc" ${data.mineral === 'Zinc' ? 'selected' : ''}>Zinc</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Unidad de Medida *</label>
                        <select id="unidad" required>
                            <option value="">Seleccione...</option>
                            <option value="Sacos" ${data.unidad === 'Sacos' ? 'selected' : ''}>Sacos</option>
                            <option value="Baldes" ${data.unidad === 'Baldes' ? 'selected' : ''}>Baldes</option>
                            <option value="Coches" ${data.unidad === 'Coches' ? 'selected' : ''}>Coches</option>
                            <option value="Carretillas" ${data.unidad === 'Carretillas' ? 'selected' : ''}>Carretillas</option>
                            <option value="Volquetes" ${data.unidad === 'Volquetes' ? 'selected' : ''}>Volquetes</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Cantidad *</label>
                        <input type="number" id="cantidad" value="${data.cantidad || 0}" min="0" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label>Observaciones / Detalle de Extracción</label>
                        <textarea id="observaciones" rows="3" placeholder="Ej: Baldes de 20 litros, 2 baldes = 1 saco, 8 sacos = 1 coche&#10;Ej: Baldes grandes de 200kg directo a volquete&#10;Ej: Extracción con coches, cada coche ~8 sacos">${data.observaciones || ''}</textarea>
                        <small class="text-muted">Describe cómo se extrae en esta labor para referencia futura</small>
                    </div>
                `;
            } else if (view === 'voladura') {
                // Filtrar SOLO explosivos y voladura de insumos
                const explosivosInsumos = DATA.insumos.filter(i => 
                    i.categoria === 'Explosivos' || i.categoria === 'Voladura'
                );
                
                html += `
                    <div class="form-group">
                        <label>Fecha *</label>
                        <input type="date" id="fecha" value="${data.fecha || new Date().toISOString().split('T')[0]}" required>
                    </div>
                    <div class="form-group">
                        <label>Zona *</label>
                        <input type="text" id="zona" value="${data.zona || ''}" required>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Explosivo *</label>
                        <select id="explosivo" required>
                            <option value="">Seleccione desde inventario...</option>
                            ${explosivosInsumos.length === 0 ? 
                                '<option value="" disabled>No hay explosivos en Insumos (categoría: Explosivos o Voladura)</option>' :
                                explosivosInsumos.map(exp => 
                                    `<option value="${exp.producto}" ${data.explosivo === exp.producto ? 'selected' : ''}>${exp.ref ? '[' + exp.ref + '] ' : ''}${exp.producto}</option>`
                                ).join('')
                            }
                        </select>
                        <small class="text-muted">Solo muestra productos de Insumos con categoría Explosivos o Voladura</small>
                    </div>
                    <div class="form-group">
                        <label>Cantidad (Kg) *</label>
                        <input type="number" id="cantidad" value="${data.cantidad || 0}" min="0" required>
                    </div>
                    <div class="form-group">
                        <label>Número de Taladros *</label>
                        <input type="number" id="taladros" value="${data.taladros || 0}" min="0" required>
                    </div>
                    <div class="form-group">
                        <label>Estado *</label>
                        <select id="estado" required>
                            <option value="Planificado" ${data.estado === 'Planificado' ? 'selected' : ''}>Planificado</option>
                            <option value="En Proceso" ${data.estado === 'En Proceso' ? 'selected' : ''}>En Proceso</option>
                            <option value="Completado" ${data.estado === 'Completado' ? 'selected' : ''}>Completado</option>
                        </select>
                    </div>
                `;
            }
            
            return html;
        }
        
        function saveData() {
            const form = document.getElementById('dataForm');
            if (!form.checkValidity()) {
                alert('Por favor complete todos los campos requeridos');
                return;
            }
            
            const newData = {};
            const inputs = form.querySelectorAll('input, select, textarea');
            
            inputs.forEach(input => {
                if (input.type === 'file') {
                    // Skip file inputs, se manejan por separado
                    return;
                }
                if (input.type === 'number') {
                    newData[input.id] = parseFloat(input.value) || 0;
                } else {
                    newData[input.id] = input.value;
                }
            });
            
            // Validar que no se repita el nombre del producto en insumos
            if (currentView === 'insumos') {
                const nombreProducto = newData.producto?.trim().toLowerCase();
                const productoExiste = DATA.insumos.find(p => 
                    p.producto.toLowerCase() === nombreProducto && 
                    p.id !== editingId
                );
                
                if (productoExiste) {
                    alert(`El producto "${newData.producto}" ya existe en el inventario. Por favor use otro nombre.`);
                    return;
                }
                
                // Calcular stock_actual para productos contables con cajas
                if (newData.tipo_control === 'Contable' && newData.unidades_por_caja > 1) {
                    const cajas = parseInt(newData.stock_cajas || 0);
                    const unidades = parseInt(newData.stock_unidades || 0);
                    const unidadesPorCaja = parseInt(newData.unidades_por_caja || 0);
                    newData.stock_actual = (cajas * unidadesPorCaja) + unidades;
                } else if (newData.tipo_control === 'Contable') {
                    // Para productos contables sin cajas (unidades_por_caja = 1)
                    newData.stock_actual = parseInt(newData.stock_actual || 0);
                    newData.stock_cajas = 0;
                    newData.stock_unidades = newData.stock_actual;
                }
            }
            
            // Para movimientos: calcular cantidad total y actualizar stock de insumos
            if (currentView === 'movimiento') {
                const productoNombre = newData.insumo;
                const producto = DATA.insumos.find(p => p.producto === productoNombre);
                
                if (producto) {
                    // Si el producto es contable con cajas, calcular cantidad desde mov_cajas y mov_unidades
                    if (producto.tipo_control === 'Contable' && producto.unidades_por_caja > 1) {
                        const movCajas = parseInt(newData.mov_cajas || 0);
                        const movUnidades = parseInt(newData.mov_unidades || 0);
                        const unidadesPorCaja = parseInt(producto.unidades_por_caja || 0);
                        newData.cantidad = (movCajas * unidadesPorCaja) + movUnidades;
                    }
                    
                    // Actualizar stock del producto en insumos
                    const cantidadMovimiento = parseInt(newData.cantidad || 0);
                    
                    if (newData.tipo === 'Entrada') {
                        // Entrada: aumentar stock
                        if (producto.tipo_control === 'Contable' && producto.unidades_por_caja > 1) {
                            const movCajas = parseInt(newData.mov_cajas || 0);
                            const movUnidades = parseInt(newData.mov_unidades || 0);
                            producto.stock_cajas = (producto.stock_cajas || 0) + movCajas;
                            producto.stock_unidades = (producto.stock_unidades || 0) + movUnidades;
                            
                            // Si las unidades exceden unidades_por_caja, convertir a cajas
                            if (producto.stock_unidades >= producto.unidades_por_caja) {
                                const cajasAdicionales = Math.floor(producto.stock_unidades / producto.unidades_por_caja);
                                producto.stock_cajas += cajasAdicionales;
                                producto.stock_unidades = producto.stock_unidades % producto.unidades_por_caja;
                            }
                            
                            producto.stock_actual = (producto.stock_cajas * producto.unidades_por_caja) + producto.stock_unidades;
                        } else {
                            producto.stock_actual = (producto.stock_actual || 0) + cantidadMovimiento;
                            if (producto.tipo_control === 'Contable') {
                                producto.stock_unidades = producto.stock_actual;
                            }
                        }
                    } else if (newData.tipo === 'Salida') {
                        // Salida: VALIDAR stock antes de procesar
                        if (producto.tipo_control === 'Contable' && producto.unidades_por_caja > 1) {
                            let totalUnidadesActuales = (producto.stock_cajas * producto.unidades_por_caja) + producto.stock_unidades;
                            
                            if (totalUnidadesActuales < cantidadMovimiento) {
                                alert(`❌ STOCK INSUFICIENTE
                                
Producto: ${producto.producto}
Stock disponible: ${producto.stock_cajas} cajas, ${producto.stock_unidades} unidades (${totalUnidadesActuales} total)
Cantidad solicitada: ${newData.mov_cajas || 0} cajas, ${newData.mov_unidades || 0} unidades (${cantidadMovimiento} total)

La operación ha sido CANCELADA.`);
                                return; // CANCELAR la operación
                            }
                            
                            totalUnidadesActuales -= cantidadMovimiento;
                            producto.stock_cajas = Math.floor(totalUnidadesActuales / producto.unidades_por_caja);
                            producto.stock_unidades = totalUnidadesActuales % producto.unidades_por_caja;
                            producto.stock_actual = totalUnidadesActuales;
                        } else {
                            const stockDisponible = producto.stock_actual || 0;
                            
                            if (stockDisponible < cantidadMovimiento) {
                                alert(`❌ STOCK INSUFICIENTE
                                
Producto: ${producto.producto}
Stock disponible: ${stockDisponible}
Cantidad solicitada: ${cantidadMovimiento}

La operación ha sido CANCELADA.`);
                                return; // CANCELAR la operación
                            }
                            
                            producto.stock_actual = stockDisponible - cantidadMovimiento;
                            if (producto.tipo_control === 'Contable') {
                                producto.stock_unidades = producto.stock_actual;
                            }
                        }
                    }
                    
                    // Agregar fecha de creación al movimiento
                    if (!editingId) {
                        newData.fecha_creacion = new Date().toISOString();
                    }
                }
            }
            
            // === AUTO-GUARDAR ZONAS NUEVAS EN REGISTRO DE TRABAJO ===
            // Si es registro_trabajo y la zona no existe, agregarla automáticamente
            let zonaAgregada = false;
            if (currentView === 'registro_trabajo' && newData.zona_trabajo) {
                const zonaIngresada = newData.zona_trabajo.trim();
                const zonasActuales = (await getZonas());
                
                // Si la zona NO existe en el catálogo, agregarla automáticamente
                if (zonaIngresada && !zonasActuales.includes(zonaIngresada)) {
                    zonasActuales.push(zonaIngresada);
                    await setZonas(zonasActuales);
                    zonaAgregada = true;
                    
                    // Mensaje en consola para debugging
                    console.log(`✅ Nueva zona "${zonaIngresada}" agregada automáticamente al catálogo`);
                }
            }
            
            // === VALIDAR DUPLICADOS EN REGISTRO DE TRABAJO ===
            // No permitir registrar al mismo trabajador dos veces en el mismo día
            if (currentView === 'registro_trabajo' && !editingId) {
                const nombreTrabajador = newData.nombre?.trim();
                const fechaRegistro = newData.fecha;
                
                const registroExiste = DATA.registro_trabajo.find(r => 
                    r.nombre.trim() === nombreTrabajador && 
                    r.fecha === fechaRegistro
                );
                
                if (registroExiste) {
                    alert(`❌ REGISTRO DUPLICADO

El trabajador "${nombreTrabajador}" ya se encuentra registrado para la fecha ${fechaRegistro}.

No se puede agregar el mismo trabajador dos veces en el mismo día.`);
                    return;
                }
            }
            
            // Guardar avatar si hay uno nuevo
            if (currentView === 'usuarios' && avatarImageData) {
                newData.avatar = avatarImageData;
            }
            
            // Guardar imagen de producto si hay una nueva
            if (currentView === 'insumos' && imagenProductoData) {
                newData.imagen = imagenProductoData;
            }
            
            if (editingId) {
                // Editar registro existente
                const index = DATA[currentView].findIndex(item => item.id === editingId);
                if (index !== -1) {
                    DATA[currentView][index] = { ...DATA[currentView][index], ...newData };
                }
            } else {
                // Agregar nuevo registro
                const newId = Math.max(...DATA[currentView].map(item => item.id), 0) + 1;
                newData.id = newId;
                
                // Agregar campos adicionales según el tipo
                if (currentView === 'usuarios') {
                    newData.fechaRegistro = new Date().toISOString().split('T')[0];
                    if (!newData.avatar) newData.avatar = ''; // Avatar vacío si no se subió
                } else if (currentView === 'insumos') {
                    newData.fecha = new Date().toISOString().split('T')[0];
                    if (!newData.imagen) newData.imagen = ''; // Imagen vacía si no se subió
                }
                
                DATA[currentView].push(newData);
            }
            
            // Limpiar variables de imágenes
            avatarImageData = null;
            imagenProductoData = null;
            
            closeModal();
            renderTable(currentView);
            guardarEnCampañaActiva(); // Guardar en campaña
            
            // Si se agregó zona nueva, actualizar el datalist para próximos registros
            if (zonaAgregada && currentView === 'registro_trabajo') {
                const datalistZonas = document.getElementById('zonas-trabajo-list');
                if (datalistZonas) {
                    const zonasActualizadas = (await getZonas());
                    datalistZonas.innerHTML = zonasActualizadas.map(z => `<option value="${z}">`).join('');
                }
            }
            
            // Actualizar dashboard si se modificaron datos
            actualizarDashboard();
            
            // Mostrar mensaje de éxito (personalizado si se agregó zona nueva)
            let mensaje = editingId ? 'Registro actualizado exitosamente' : 'Registro agregado exitosamente';
            if (zonaAgregada && currentView === 'registro_trabajo') {
                mensaje += `\n\n✅ Nueva zona "${newData.zona_trabajo}" agregada al catálogo`;
            }
            alert(mensaje);
        }
        
        function viewDetails(id, view) {
            const item = DATA[view].find(i => i.id === id);
            if (!item) return;
            
            let html = '<div class="row g-3">';
            
            // Si es usuario y tiene avatar, mostrarlo primero en una tarjeta especial
            if (view === 'usuarios' && item.avatar && item.avatar.startsWith('data:image')) {
                html += `
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body text-center">
                                <h6 class="card-subtitle mb-3 text-muted text-uppercase" style="font-size:11px;font-weight:700;">
                                    <i class="fas fa-user-circle text-info"></i> Foto de Perfil
                                </h6>
                                <div class="d-inline-block border rounded-circle" style="width:120px;height:120px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,0.15);">
                                    <img src="${item.avatar}" style="width:100%;height:100%;object-fit:cover;">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Si es insumo y tiene imagen, mostrarla primero
            if (view === 'insumos' && item.imagen && item.imagen.startsWith('data:image')) {
                html += `
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body text-center">
                                <h6 class="card-subtitle mb-3 text-muted text-uppercase" style="font-size:11px;font-weight:700;">
                                    <i class="fas fa-image text-info"></i> Imagen del Producto
                                </h6>
                                <div class="d-inline-block border rounded" style="width:200px;height:200px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,0.15);">
                                    <img src="${item.imagen}" style="width:100%;height:100%;object-fit:contain;background:#f8f9fa;">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Columnas a excluir del modal de detalles
            const excludeFields = ['id', 'password', 'avatar', 'imagen', 'stock_cajas', 'stock_unidades'];
            
            // Generar campos según el tipo de vista
            Object.keys(item).forEach(key => {
                if (!excludeFields.includes(key)) {
                    let label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    let value = item[key];
                    
                    // Formatear stock_actual concatenado para insumos
                    if (key === 'stock_actual' && view === 'insumos') {
                        if (item.tipo_control === 'Contable' && item.unidades_por_caja > 1) {
                            const cajas = item.stock_cajas || 0;
                            const unidades = item.stock_unidades || 0;
                            value = `<strong style="font-size:18px;">${cajas} cajas, ${unidades} ${item.unidad.toLowerCase()}</strong>`;
                        } else if (item.tipo_control === 'Contable') {
                            const unidades = item.stock_unidades || 0;
                            value = `<strong style="font-size:18px;">${unidades} ${item.unidad.toLowerCase()}</strong>`;
                        } else {
                            value = `<strong style="font-size:18px;">${value}</strong>`;
                        }
                    }
                    // Formatear valores especiales
                    else if (key === 'color') {
                        value = `<span class="badge" style="background:${value};padding:10px 30px;font-size:14px;">${value}</span>`;
                    } else if (key === 'rol') {
                        value = `<span class="badge bg-primary fs-6">${value}</span>`;
                    } else if (key === 'estado') {
                        value = `<span class="badge bg-success fs-6">${value}</span>`;
                    } else if (key === 'tipo_movimiento') {
                        const badgeClass = value === 'Entrada' ? 'bg-success' : 'bg-danger';
                        value = `<span class="badge ${badgeClass} fs-6">${value}</span>`;
                    } else if (key === 'tipo_control') {
                        const badgeClass = value === 'Contable' ? 'bg-primary' : 'bg-warning';
                        value = `<span class="badge ${badgeClass} fs-6">${value}</span>`;
                    }
                    
                    html += `
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted text-uppercase" style="font-size:11px;font-weight:700;">
                                        <i class="fas fa-tag text-info"></i> ${label}
                                    </h6>
                                    <p class="card-text fs-5 fw-bold text-dark mb-0">${value || 'N/A'}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            
            document.getElementById('modalDetallesBody').innerHTML = html;
            
            // Mostrar el modal usando Bootstrap 5
            const modalElement = document.getElementById('modalDetalles');
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
        
        function deleteItem(id) {
            // Verificar si estamos en modo visualización
            if (window.modoVisualizacionCampaña) {
                alert('⚠️ No puedes eliminar registros en modo visualización. Vuelve a la campaña actual para editar.');
                return;
            }
            
            if (confirm('¿Está seguro de eliminar este registro?')) {
                const index = DATA[currentView].findIndex(item => item.id === id);
                if (index !== -1) {
                    // Si es un movimiento, revertir el cambio en el stock
                    if (currentView === 'movimiento') {
                        const movimiento = DATA[currentView][index];
                        const insumo = DATA.insumos.find(i => i.producto === movimiento.insumo);
                        
                        if (insumo) {
                            const cantidad = parseFloat(movimiento.cantidad) || 0;
                            
                            if (insumo.tipo_control === 'Contable' && insumo.unidades_por_caja > 1) {
                                // Para productos contables
                                const cajas = movimiento.mov_cajas || 0;
                                const unidades = movimiento.mov_unidades || 0;
                                
                                if (movimiento.tipo === 'Entrada') {
                                    // Era entrada, entonces restar
                                    insumo.stock_cajas = (insumo.stock_cajas || 0) - cajas;
                                    insumo.stock_unidades = (insumo.stock_unidades || 0) - unidades;
                                    
                                    // Ajustar si las unidades quedan negativas
                                    if (insumo.stock_unidades < 0) {
                                        insumo.stock_cajas--;
                                        insumo.stock_unidades += insumo.unidades_por_caja;
                                    }
                                } else if (movimiento.tipo === 'Salida') {
                                    // Era salida, entonces sumar
                                    insumo.stock_cajas = (insumo.stock_cajas || 0) + cajas;
                                    insumo.stock_unidades = (insumo.stock_unidades || 0) + unidades;
                                    
                                    // Ajustar si las unidades exceden
                                    if (insumo.stock_unidades >= insumo.unidades_por_caja) {
                                        const cajasExtra = Math.floor(insumo.stock_unidades / insumo.unidades_por_caja);
                                        insumo.stock_cajas += cajasExtra;
                                        insumo.stock_unidades = insumo.stock_unidades % insumo.unidades_por_caja;
                                    }
                                }
                                
                                // Recalcular stock_actual
                                insumo.stock_actual = (insumo.stock_cajas || 0) * insumo.unidades_por_caja + (insumo.stock_unidades || 0);
                                
                            } else {
                                // Para productos medibles
                                if (movimiento.tipo === 'Entrada') {
                                    // Era entrada, entonces restar
                                    insumo.stock_actual = (insumo.stock_actual || 0) - cantidad;
                                } else if (movimiento.tipo === 'Salida') {
                                    // Era salida, entonces sumar
                                    insumo.stock_actual = (insumo.stock_actual || 0) + cantidad;
                                }
                            }
                        }
                    }
                    
                    DATA[currentView].splice(index, 1);
                    renderTable(currentView);
                    guardarEnCampañaActiva(); // Guardar en campaña
                    actualizarDashboard(); // Actualizar dashboard
                    alert('Registro eliminado exitosamente');
                }
            }
        }
        
        // Función para completar automáticamente datos del trabajador
        function completarDatosTrabajador() {
            const select = document.getElementById('trabajador_select');
            if (!select || !select.value) return;
            
            const [idUsuario, nombre] = select.value.split('|');
            
            document.getElementById('id_usuario').value = idUsuario;
            document.getElementById('nombre').value = nombre;
        }
        
        // Función para gestionar zonas de trabajo
        function gestionarZonas() {
            const zonasActuales = (await getZonas());
            
            // MÉTODO 1: HTML con onclick inline (compatible con todos los navegadores)
            let html = `
                <div style="max-height:400px;overflow-y:auto;">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> <strong>Gestione las zonas de trabajo.</strong> Puede agregar nuevas zonas o eliminar las existentes.
                    </div>
                    
                    <h6 class="mb-3"><i class="fas fa-map-marker-alt"></i> Zonas de Trabajo Disponibles:</h6>
                    <div class="list-group mb-3">
                        ${zonasActuales.map((zona, index) => `
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-location-dot text-primary me-2"></i><strong>${zona}</strong></span>
                                <button type="button" class="btn btn-sm btn-danger btn-eliminar-zona" data-index="${index}" onclick="window.eliminarZonaDirecta(${index}); return false;">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    
                    <hr>
                    
                    <h6 class="mb-3"><i class="fas fa-plus-circle"></i> Agregar Nueva Zona:</h6>
                    <div class="input-group mb-2">
                        <input type="text" class="form-control" id="nuevaZonaInput" placeholder="Ej: Nivel 2, Rampa Principal" onkeydown="if(event.key==='Enter'){window.agregarZonaDirecta(); return false;}">
                        <button type="button" class="btn btn-success btn-agregar-zona" id="btnAgregarZona" onclick="window.agregarZonaDirecta(); return false;">
                            <i class="fas fa-plus"></i> Agregar
                        </button>
                    </div>
                    <small class="text-muted"><i class="fas fa-lightbulb"></i> Presione Enter o click en Agregar</small>
                </div>
            `;
            
            document.getElementById('modalDetallesTitle').innerHTML = '<i class="fas fa-cog"></i> Gestionar Zonas de Trabajo';
            document.getElementById('modalDetallesBody').innerHTML = html;
            
            const modalElement = document.getElementById('modalDetalles');
            const modalInstance = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
            modalInstance.show();
            
            // MÉTODO 2: addEventListener directo (backup)
            setTimeout(() => {
                const btnAgregar = document.getElementById('btnAgregarZona');
                if (btnAgregar) {
                    btnAgregar.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        window.agregarZonaDirecta();
                    });
                }
                
                // MÉTODO 3: Event delegation en el modal body (triple backup)
                const modalBody = document.getElementById('modalDetallesBody');
                if (modalBody) {
                    modalBody.addEventListener('click', function(e) {
                        if (e.target.closest('.btn-agregar-zona')) {
                            e.preventDefault();
                            e.stopPropagation();
                            window.agregarZonaDirecta();
                        }
                        
                        if (e.target.closest('.btn-eliminar-zona')) {
                            e.preventDefault();
                            e.stopPropagation();
                            const btn = e.target.closest('.btn-eliminar-zona');
                            const idx = parseInt(btn.getAttribute('data-index'));
                            if (!isNaN(idx)) {
                                window.eliminarZonaDirecta(idx);
                            }
                        }
                    });
                }
                
                // MÉTODO 4: Focus y Enter en input
                const input = document.getElementById('nuevaZonaInput');
                if (input) {
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            window.agregarZonaDirecta();
                        }
                    });
                    input.focus();
                }
            }, 100);
        }
        
        // IMPORTANTE: Asignar funciones a window para que onclick pueda accederlas
        window.agregarZonaDirecta = async function agregarZonaDirecta() {
            const input = document.getElementById('nuevaZonaInput');
            if (!input) return;
            
            const nuevaZona = input.value.trim();
            
            if (!nuevaZona) {
                alert('⚠️ Por favor ingrese el nombre de la zona');
                input.focus();
                return;
            }
            
            const zonas = (await getZonas());
            
            if (zonas.includes(nuevaZona)) {
                alert('⚠️ Esta zona ya existe');
                input.value = '';
                input.focus();
                return;
            }
            
            zonas.push(nuevaZona);
            await setZonas(zonas);
            
            // Recargar el modal con la nueva zona
            gestionarZonas();
        };
        
        window.eliminarZonaDirecta = async function eliminarZonaDirecta(index) {
            const zonas = (await getZonas());
            
            if (zonas.length <= 1) {
                alert('⚠️ Debe mantener al menos una zona');
                return;
            }
            
            const zonaAEliminar = zonas[index];
            
            if (!confirm(`¿Está seguro de eliminar la zona "${zonaAEliminar}"?`)) {
                return;
            }
            
            zonas.splice(index, 1);
            await setZonas(zonas);
            
            // Recargar el modal sin la zona eliminada
            gestionarZonas();
        };
        
        // Mantener las funciones antiguas por compatibilidad (apuntan a window)
        async function agregarZona() {
            window.agregarZonaDirecta();
        }
        
        async function eliminarZona(index) {
            window.eliminarZonaDirecta(index);
        }
        
        async function renderConfiguraciones() {
            // Cargar valores guardados de localStorage
            const nombreEmpresa = (await getConfig('config_nombreEmpresa', '')) || 'MINERA SAC';
            const idioma = (await getConfig('config_idioma', '')) || 'es';
            const zonaHoraria = (await getConfig('config_zonaHoraria', '')) || 'America/Lima';
            const logoEmpresa = (await getConfig('config_logoEmpresa', '')) || 'M';
            const ultimoRespaldo = (await getConfig('ultimo_respaldo', ''));
            const fechaRespaldo = ultimoRespaldo ? new Date(ultimoRespaldo).toLocaleString() : 'Nunca';
            
            // Verificar si el usuario es admin
            const esAdmin = currentUser.rol === 'admin';
            
            let html = `<div class="container-fluid p-3 pt-2">`;
            
            // Si NO es admin, mostrar mensaje informativo
            if (!esAdmin) {
                html += `
                    <div class="alert alert-info mb-4" role="alert">
                        <i class="fas fa-info-circle"></i> <strong>Información:</strong> Solo el Administrador puede modificar la configuración del sistema. Tú puedes cambiar tu contraseña y ver información del sistema.
                    </div>
                `;
            }
            
            html += `<div class="row g-4">
                        <!-- Tarjeta Perfil de Usuario -->
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0"><i class="fas fa-user-circle"></i> Perfil de Usuario</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Nombre de Usuario</label>
                                        <input type="text" class="form-control" value="${currentUser.nombre}" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Rol</label>
                                        <input type="text" class="form-control" value="${currentUser.rol}" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Usuario</label>
                                        <input type="text" class="form-control" value="${currentUser.username}" readonly>
                                    </div>
                                    <button class="btn btn-warning w-100" onclick="cambiarContrasena()">
                                        <i class="fas fa-key"></i> Cambiar Contraseña
                                    </button>
                                </div>
                            </div>
                        </div>
            `;
            
            // Tarjeta Acerca del Sistema (TODOS los usuarios)
            html += `
                        <!-- Tarjeta Acerca del Sistema -->
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-header bg-dark text-white">
                                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Acerca del Sistema</h5>
                                </div>
                                <div class="card-body">
                                    <div class="text-center mb-3">
                                        <div class="bg-primary rounded-circle d-inline-flex align-items-center justify-content-center" style="width:80px;height:80px;overflow:hidden;">
                                            ${logoEmpresa.startsWith('data:image') ? 
                                                `<img src="${logoEmpresa}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` : 
                                                `<h1 class="text-white mb-0">${logoEmpresa}</h1>`
                                            }
                                        </div>
                                    </div>
                                    <h5 class="text-center mb-3">${nombreEmpresa}</h5>
                                    <table class="table table-sm">
                                        <tr><td class="fw-bold">Versión:</td><td>1.0.0</td></tr>
                                        <tr><td class="fw-bold">Fecha de Lanzamiento:</td><td>Febrero 2026</td></tr>
                                        <tr><td class="fw-bold">Licencia:</td><td>Empresarial</td></tr>
                                        <tr><td class="fw-bold">Soporte:</td><td>soporte@minerasac.com</td></tr>
                                        <tr><td class="fw-bold">Tu Rol:</td><td><span class="badge bg-primary">${currentUser.rol}</span></td></tr>
                                    </table>
                                </div>
                            </div>
                        </div>
            `;
            
            // Las siguientes tarjetas SOLO las ve el ADMIN
            if (esAdmin) {
                html += `
                        
                        <!-- Tarjeta Configuración del Sistema -->
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0"><i class="fas fa-cogs"></i> Configuración del Sistema</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Logo del Sistema</label>
                                        <div class="d-flex align-items-center gap-3 mb-2">
                                            <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width:60px;height:60px;overflow:hidden;" id="logoPreview">
                                                ${logoEmpresa.startsWith('data:image') ? 
                                                    `<img src="${logoEmpresa}" style="width:100%;height:100%;object-fit:cover;">` : 
                                                    `<h3 class="text-white mb-0">${logoEmpresa}</h3>`
                                                }
                                            </div>
                                            <div class="flex-grow-1">
                                                <input type="file" class="form-control mb-2" id="logoImagen" accept="image/*" onchange="cargarImagenLogo(event)">
                                                <small class="text-muted">O ingresa una letra/emoji:</small>
                                                <input type="text" class="form-control mt-1" id="logoTexto" value="${logoEmpresa.startsWith('data:image') ? '' : logoEmpresa}" maxlength="2" placeholder="M">
                                            </div>
                                        </div>
                                        <small class="text-muted">Sube una imagen o escribe una letra/emoji</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Nombre de la Empresa</label>
                                        <input type="text" class="form-control" id="nombreEmpresa" value="${nombreEmpresa}">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Idioma del Sistema</label>
                                        <select class="form-select" id="idiomaSystem">
                                            <option value="es" ${idioma === 'es' ? 'selected' : ''}>Español</option>
                                            <option value="en" ${idioma === 'en' ? 'selected' : ''}>English</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Zona Horaria</label>
                                        <select class="form-select" id="zonaHoraria">
                                            <option value="America/Lima" ${zonaHoraria === 'America/Lima' ? 'selected' : ''}>Lima (GMT-5)</option>
                                            <option value="America/Mexico_City" ${zonaHoraria === 'America/Mexico_City' ? 'selected' : ''}>Ciudad de México (GMT-6)</option>
                                            <option value="America/Bogota" ${zonaHoraria === 'America/Bogota' ? 'selected' : ''}>Bogotá (GMT-5)</option>
                                            <option value="America/Santiago" ${zonaHoraria === 'America/Santiago' ? 'selected' : ''}>Santiago (GMT-3)</option>
                                        </select>
                                    </div>
                                    <button class="btn btn-info w-100" onclick="guardarConfiguracionSistema()">
                                        <i class="fas fa-save"></i> Guardar Configuración
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tarjeta Seguridad -->
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-header bg-danger text-white">
                                    <h5 class="mb-0"><i class="fas fa-shield-alt"></i> Seguridad</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-light rounded">
                                        <div>
                                            <h6 class="mb-1">Autenticación de Dos Factores</h6>
                                            <small class="text-muted">Protege tu cuenta con un código adicional</small>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="auth2FA" onchange="guardarConfigSeguridad()">
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-light rounded">
                                        <div>
                                            <h6 class="mb-1">Cerrar Sesión Automática</h6>
                                            <small class="text-muted">Después de 30 minutos de inactividad</small>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="autoLogout" checked onchange="guardarConfigSeguridad()">
                                        </div>
                                    </div>
                                    <button class="btn btn-danger w-100" onclick="verSesionesActivas()">
                                        <i class="fas fa-list"></i> Ver Sesiones Activas
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tarjeta Notificaciones -->
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0"><i class="fas fa-bell"></i> Notificaciones</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-light rounded">
                                        <div>
                                            <h6 class="mb-1">Notificaciones por Email</h6>
                                            <small class="text-muted">Recibe alertas importantes por correo</small>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="notifEmail" checked onchange="guardarConfigNotificaciones()">
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-light rounded">
                                        <div>
                                            <h6 class="mb-1">Alertas de Stock Bajo</h6>
                                            <small class="text-muted">Cuando los insumos lleguen al mínimo</small>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="alertaStock" checked onchange="guardarConfigNotificaciones()">
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-light rounded">
                                        <div>
                                            <h6 class="mb-1">Reportes Automáticos</h6>
                                            <small class="text-muted">Recibe reportes semanales automáticamente</small>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="reportesAuto" onchange="guardarConfigNotificaciones()">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tarjeta Respaldo y Datos -->
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-header bg-warning text-dark">
                                    <h5 class="mb-0"><i class="fas fa-database"></i> Respaldo y Datos</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <h6 class="fw-bold">Respaldo Automático</h6>
                                        <p class="text-muted small mb-2">Último respaldo: ${fechaRespaldo}</p>
                                        <button class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="crearRespaldo()">
                                            <i class="fas fa-cloud-upload-alt"></i> Crear Respaldo Ahora
                                        </button>
                                    </div>
                                    <hr>
                                    <div class="mb-3">
                                        <h6 class="fw-bold">Exportar Datos</h6>
                                        <button class="btn btn-outline-success btn-sm w-100 mb-2" onclick="exportarTodoExcel()">
                                            <i class="fas fa-file-excel"></i> Exportar Todo a Excel
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm w-100" onclick="exportarTodoPDF()">
                                            <i class="fas fa-file-pdf"></i> Exportar Todo a PDF
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tarjeta Mantenimiento de Datos -->
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                    <h5 class="mb-0"><i class="fas fa-tools"></i> Mantenimiento de Datos</h5>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle"></i> <strong>Precaución:</strong> Estas acciones son permanentes.
                                    </div>
                                    
                                    <div class="mb-3 p-3 border rounded border-danger bg-light">
                                        <h6 class="fw-bold mb-2 text-danger">
                                            <i class="fas fa-exclamation-circle"></i> EMERGENCIA: Restaurar Sistema
                                        </h6>
                                        <p class="text-muted small mb-2">
                                            Si el sistema no funciona o no puedes hacer login, usa este botón para restaurar todo a valores predeterminados.
                                        </p>
                                        <button class="btn btn-danger w-100" onclick="resetearSistemaCompleto()">
                                            <i class="fas fa-sync-alt"></i> RESETEAR TODO EL SISTEMA
                                        </button>
                                    </div>
                                    
                                    <div class="mb-3 p-3 border rounded">
                                        <h6 class="fw-bold mb-2">
                                            <i class="fas fa-map-marker-alt"></i> Zonas de Trabajo
                                        </h6>
                                        <p class="text-muted small mb-2">
                                            Eliminar todas las zonas del catálogo. Las nuevas zonas se agregarán automáticamente al registrar trabajos.
                                        </p>
                                        <button class="btn btn-sm btn-outline-danger w-100" onclick="reiniciarZonas()">
                                            <i class="fas fa-redo"></i> Limpiar Catálogo de Zonas
                                        </button>
                                    </div>
                                    
                                    <div class="p-3 border rounded bg-light">
                                        <h6 class="fw-bold mb-2">
                                            <i class="fas fa-chart-line"></i> Estadísticas
                                        </h6>
                                        <table class="table table-sm mb-0">
                                            <tr>
                                                <td class="text-muted">Zonas registradas:</td>
                                                <td class="fw-bold text-end" id="totalZonas">${(await getZonas()).length}</td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Registros de trabajo:</td>
                                                <td class="fw-bold text-end">${DATA.registro_trabajo.length}</td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tarjeta Gestión de Campañas -->
                        <div class="col-12">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white;">
                                    <h5 class="mb-0"><i class="fas fa-calendar-alt"></i> Gestión de Campañas Mineras</h5>
                                </div>
                                <div class="card-body" id="seccionCampañas">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i> <strong>¿Qué son las Campañas?</strong><br>
                                        Las campañas permiten organizar el trabajo minero por períodos (1-2 meses). Al finalizar una campaña, 
                                        todos los datos se archivan y puedes iniciar una nueva con tablas limpias. Los insumos y usuarios se mantienen.
                                    </div>
                                    <div class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Cargando...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            document.getElementById('tableContent').innerHTML = html;
            
            // Cargar contenido de campañas después de renderizar
            if (esAdmin) {
                cargarSeccionCampañas();
            }
            
            // Cargar estados de los switches desde localStorage (solo para admin)
            if (esAdmin) {
                setTimeout(() => {
                const auth2FA = (await getConfig('config_auth2FA', '')) === 'true';
                const autoLogout = (await getConfig('config_autoLogout', '')) !== 'false'; // por defecto true
                const notifEmail = (await getConfig('config_notifEmail', '')) !== 'false';
                const alertaStock = (await getConfig('config_alertaStock', '')) !== 'false';
                const reportesAuto = (await getConfig('config_reportesAuto', '')) === 'true';
                
                document.getElementById('auth2FA').checked = auth2FA;
                document.getElementById('autoLogout').checked = autoLogout;
                document.getElementById('notifEmail').checked = notifEmail;
                document.getElementById('alertaStock').checked = alertaStock;
                document.getElementById('reportesAuto').checked = reportesAuto;
            }, 100);
            }
        }
        
        // Función para cambiar contraseña
        function cambiarContrasena() {
            const nuevaPass = prompt('Ingrese su nueva contraseña:');
            if (nuevaPass && nuevaPass.length >= 6) {
                alert('✓ Contraseña cambiada exitosamente');
                showNotification('Contraseña actualizada correctamente', 'success');
            } else if (nuevaPass) {
                alert('❌ La contraseña debe tener al menos 6 caracteres');
            }
        }
        
        // Función para reiniciar zonas de trabajo a valores por defecto
        async function resetearSistemaCompleto() {
            const confirmar = confirm('⚠️⚠️⚠️ ¡ADVERTENCIA CRÍTICA! ⚠️⚠️⚠️\n\nEsto BORRARÁ TODO:\n• Campañas\n• Sistema de campañas\n• Configuraciones\n• Google Sheets config\n\nPERO mantendrá los usuarios y datos de ejemplo.\n\n¿Continuar?');
            
            if (!confirmar) return;
            
            const confirmar2 = confirm('¿Estás 100% seguro?\n\nEsta acción NO se puede deshacer.');
            
            if (confirmar2) {
                // Borrar todo de localStorage
                /* localStorage.removeItem reemplazado por DB */
                /* localStorage.removeItem reemplazado por DB */
                /* localStorage.removeItem reemplazado por DB */
                /* localStorage.removeItem reemplazado por DB */
                /* localStorage.removeItem reemplazado por DB */
                
                alert('✅ Sistema reseteado!\n\nRecargando página...');
                location.reload();
            }
        }
        
        async function reiniciarZonas() {
            const confirmar = confirm('⚠️ ¿Está seguro de reiniciar las zonas de trabajo?\n\nEsto eliminará TODAS las zonas del catálogo.\nEl catálogo quedará vacío.\n\nLos registros de trabajo existentes NO se eliminarán.');
            
            if (confirmar) {
                // Reiniciar a vacío
                const zonasDefault = [];
                await setZonas(zonasDefault);
                
                // Actualizar contador en la interfaz
                const contadorZonas = document.getElementById('totalZonas');
                if (contadorZonas) {
                    contadorZonas.textContent = zonasDefault.length;
                }
                
                // Notificación de éxito
                alert('✅ Zonas reiniciadas exitosamente\n\nEl catálogo ahora está vacío.\nLas nuevas zonas se agregarán automáticamente al registrar trabajos.');
                
                console.log('✅ Zonas de trabajo reiniciadas a lista vacía');
            }
        }
        
        // Variable global para guardar el logo
        let logoActual = (await getConfig('config_logoEmpresa', '')) || 'M';
        
        // Función para cargar imagen de logo
        function cargarImagenLogo(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    logoActual = e.target.result;
                    
                    // Actualizar preview
                    const preview = document.getElementById('logoPreview');
                    preview.innerHTML = `<img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover;">`;
                    
                    // Limpiar campo de texto
                    document.getElementById('logoTexto').value = '';
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Guardar configuración del sistema
        async function guardarConfiguracionSistema() {
            const logoTexto = document.getElementById('logoTexto').value;
            const logoEmpresa = logoTexto || logoActual || 'M';
            const nombreEmpresa = document.getElementById('nombreEmpresa').value;
            const idioma = document.getElementById('idiomaSystem').value;
            const zona = document.getElementById('zonaHoraria').value;
            
            // Si hay texto, usarlo en lugar de la imagen
            if (logoTexto) {
                logoActual = logoTexto;
            }
            
            // Guardar en localStorage
            await setConfig('config_logoEmpresa', logoActual);
            await setConfig('config_nombreEmpresa', nombreEmpresa);
            await setConfig('config_idioma', idioma);
            await setConfig('config_zonaHoraria', zona);
            
            // Actualizar el logo y nombre en la sidebar
            const sidebarLogo = document.querySelector('.logo');
            const sidebarTitle = document.querySelector('.sidebar-title');
            const loginLogo = document.querySelector('.login-logo');
            
            // Si es imagen, usar como fondo, si no, como texto
            if (logoActual.startsWith('data:image')) {
                if (sidebarLogo) {
                    sidebarLogo.style.backgroundImage = `url(${logoActual})`;
                    sidebarLogo.style.backgroundSize = 'cover';
                    sidebarLogo.style.backgroundPosition = 'center';
                    sidebarLogo.textContent = '';
                }
                if (loginLogo) {
                    loginLogo.style.backgroundImage = `url(${logoActual})`;
                    loginLogo.style.backgroundSize = 'cover';
                    loginLogo.style.backgroundPosition = 'center';
                    loginLogo.textContent = '';
                }
            } else {
                if (sidebarLogo) {
                    sidebarLogo.style.backgroundImage = '';
                    sidebarLogo.textContent = logoActual;
                }
                if (loginLogo) {
                    loginLogo.style.backgroundImage = '';
                    loginLogo.textContent = logoActual;
                }
            }
            
            if (sidebarTitle) sidebarTitle.textContent = nombreEmpresa;
            
            // Actualizar título del navegador
            document.title = `${nombreEmpresa} - Sistema de Gestión`;
            
            // Mostrar notificación
            showNotification(`Configuración guardada: ${nombreEmpresa}`, 'success');
        }
        
        // Guardar configuración de seguridad
        async function guardarConfigSeguridad() {
            const auth2FA = document.getElementById('auth2FA').checked;
            const autoLogout = document.getElementById('autoLogout').checked;
            
            await setConfig('config_auth2FA', auth2FA);
            await setConfig('config_autoLogout', autoLogout);
            
            showNotification('Configuración de seguridad guardada', 'success');
        }
        
        // Guardar configuración de notificaciones
        async function guardarConfigNotificaciones() {
            const notifEmail = document.getElementById('notifEmail').checked;
            const alertaStock = document.getElementById('alertaStock').checked;
            const reportesAuto = document.getElementById('reportesAuto').checked;
            
            await setConfig('config_notifEmail', notifEmail);
            await setConfig('config_alertaStock', alertaStock);
            await setConfig('config_reportesAuto', reportesAuto);
            
            showNotification('Preferencias de notificaciones guardadas', 'success');
        }
        
        // Ver sesiones activas
        function verSesionesActivas() {
            alert('Sesiones Activas:\n\n• Sesión actual: Navegador Web (Activa ahora)\n• Última sesión: 15/02/2026 - 10:30 AM\n• IP: 192.168.1.100');
        }
        
        // Crear respaldo del sistema
        async function crearRespaldo() {
            // Crear objeto con todos los datos
            const backup = {
                fecha_respaldo: new Date().toISOString(),
                version: '1.0.0',
                usuario: currentUser.username,
                datos: DATA,
                configuracion: {
                    nombreEmpresa: (await getConfig('config_nombreEmpresa', '')) || 'MINERA SAC',
                    logoEmpresa: (await getConfig('config_logoEmpresa', '')) || 'M',
                    idioma: (await getConfig('config_idioma', '')) || 'es',
                    zonaHoraria: (await getConfig('config_zonaHoraria', '')) || 'America/Lima'
                }
            };
            
            // Convertir a JSON
            const jsonStr = JSON.stringify(backup, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            // Crear link de descarga
            const link = document.createElement('a');
            link.href = url;
            link.download = `respaldo_minera_${new Date().toISOString().split('T')[0]}.bak`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Guardar fecha del último respaldo
            await setConfig('ultimo_respaldo', new Date().toISOString());
            
            showNotification('Respaldo creado y descargado', 'success');
        }
        
        // Exportar todo a Excel (CSV)
        async function exportarTodoExcel() {
            const nombreEmpresa = (await getConfig('config_nombreEmpresa', '')) || 'MINERA SAC';
            let csv = `${nombreEmpresa} - EXPORTACION COMPLETA\n`;
            csv += `Fecha: ${new Date().toLocaleDateString()}\n\n`;
            
            // Función para convertir array de objetos a CSV
            Object.keys(DATA).forEach(seccion => {
                csv += `\n${seccion.toUpperCase()}\n`;
                if (DATA[seccion].length > 0) {
                    const headers = Object.keys(DATA[seccion][0]);
                    csv += headers.join(',') + '\n';
                    DATA[seccion].forEach(item => {
                        csv += headers.map(h => `"${item[h] || ''}"`).join(',') + '\n';
                    });
                }
            });
            
            // Descargar archivo
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `minera_sac_completo_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Archivo Excel generado', 'success');
        }
        
        // Exportar todo a PDF
        async function exportarTodoPDF() {
            if (typeof jspdf === 'undefined') {
                alert('Generando PDF...');
                showNotification('PDF en proceso de generación', 'info');
                return;
            }
            
            const { jsPDF } = jspdf;
            const doc = new jsPDF();
            
            const nombreEmpresa = (await getConfig('config_nombreEmpresa', '')) || 'MINERA SAC';
            
            // Título
            doc.setFontSize(18);
            doc.text(`${nombreEmpresa} - REPORTE COMPLETO`, 105, 20, { align: 'center' });
            doc.setFontSize(10);
            doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 105, 28, { align: 'center' });
            
            let y = 40;
            
            // Agregar secciones
            Object.keys(DATA).forEach(seccion => {
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                }
                
                doc.setFontSize(14);
                doc.text(seccion.toUpperCase(), 14, y);
                y += 8;
                doc.setFontSize(10);
                doc.text(`Total: ${DATA[seccion].length} registros`, 14, y);
                y += 15;
            });
            
            const nombreEmpresaArchivo = ((await getConfig('config_nombreEmpresa', '')) || 'MINERA_SAC').replace(/\s+/g, '_');
            doc.save(`${nombreEmpresaArchivo}_respaldo_${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification('PDF generado exitosamente', 'success');
        }
        
        // Buscar actualizaciones
        function verActualizaciones() {
            showNotification('Sistema actualizado - Versión 1.0.0', 'info');
        }
        
        // Función de notificación
        function showNotification(message, type = 'success') {
            const colors = {
                success: '#28a745',
                error: '#dc3545',
                info: '#17a2b8',
                warning: '#ffc107'
            };
            
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type]};
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 6px 16px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: slideIn 0.3s ease;
                font-weight: 600;
            `;
            notification.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Cargar configuración al iniciar
        document.addEventListener('DOMContentLoaded', async function() {
            const nombreGuardado = (await getConfig('config_nombreEmpresa', ''));
            const logoGuardado = (await getConfig('config_logoEmpresa', ''));
            
            if (nombreGuardado) {
                document.title = `${nombreGuardado} - Sistema de Gestión`;
                const sidebarTitle = document.querySelector('.sidebar-title');
                if (sidebarTitle) sidebarTitle.textContent = nombreGuardado;
            }
            
            if (logoGuardado) {
                logoActual = logoGuardado;
                const sidebarLogo = document.querySelector('.logo');
                const loginLogo = document.querySelector('.login-logo');
                
                // Si es imagen, usar como fondo
                if (logoGuardado.startsWith('data:image')) {
                    if (sidebarLogo) {
                        sidebarLogo.style.backgroundImage = `url(${logoGuardado})`;
                        sidebarLogo.style.backgroundSize = 'cover';
                        sidebarLogo.style.backgroundPosition = 'center';
                        sidebarLogo.textContent = '';
                    }
                    if (loginLogo) {
                        loginLogo.style.backgroundImage = `url(${logoGuardado})`;
                        loginLogo.style.backgroundSize = 'cover';
                        loginLogo.style.backgroundPosition = 'center';
                        loginLogo.textContent = '';
                    }
                } else {
                    // Si es texto
                    if (sidebarLogo) {
                        sidebarLogo.style.backgroundImage = '';
                        sidebarLogo.textContent = logoGuardado;
                    }
                    if (loginLogo) {
                        loginLogo.style.backgroundImage = '';
                        loginLogo.textContent = logoGuardado;
                    }
                }
            }
        });
    </script>
    
    <style>
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(400px); opacity: 0; }
        }
    </style>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
